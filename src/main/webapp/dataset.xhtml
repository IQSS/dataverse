<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:pt="http://java.sun.com/jsf/passthrough"
      xmlns:cc="http://java.sun.com/jsf/composite"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:iqbs="http://xmlns.jcp.org/jsf/composite/iqbs">
    <h:head>
    </h:head>
    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="#{DatasetPage.editMode == 'CREATE' ? bundle['dataset.pageTitle'] : DatasetPage.workingVersion.title} - #{DatasetPage.dataset.owner.name} #{bundle.dataverse}"/>
            <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
            <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
            <ui:param name="version" value="#{DatasetPage.workingVersion}"/>
            <ui:param name="locked" value="#{DatasetPage.locked}"/>
            <ui:param name="showMessagePanel" value="#{true}"/>
            <ui:define name="body">
                <o:importFunctions type="edu.harvard.iq.dataverse.util.MarkupChecker" />
                <f:metadata>
                    <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                    <f:viewParam name="ownerId" value="#{DatasetPage.ownerId}"/>
                    <f:viewParam name="version" value="#{DatasetPage.version}"/>
                    <f:viewParam name="versionId" value="#{DatasetPage.versionId}"/>
                    <f:viewParam name="persistentId" value="#{DatasetPage.persistentId}"/>
                    <f:viewParam name="fileSortField" value="#{DatasetPage.fileSortField}"/>
                    <f:viewParam name="fileSortOrder" value="#{DatasetPage.fileSortOrder}"/>
                    <f:viewAction action="#{DatasetPage.init}" rendered="true"/>
                    <f:viewAction action="#{dataverseHeaderFragment.initBreadcrumbs(DatasetPage.dataset)}"/>
                    <f:viewAction action="#{EditDatafilesPage.initCreateMode(DatasetPage.editMode, DatasetPage.workingVersion, DatasetPage.newFiles, DatasetPage.selectedFiles)}"/>
                </f:metadata>
                <h:form id="datasetForm">
                    <!-- Header / Button Panel -->
                    <!-- View editMode -->
                    <div id="topDatasetBlock" class="row" jsf:rendered="#{empty DatasetPage.editMode}">
                        <div id="actionButtonBlock" class="col-xs-12" jsf:rendered="#{!widgetWrapper.widgetView}">
                            <!-- Metrics -->
                            <div id="metrics-block" class="pull-left" jsf:rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                <div class="pull-left text-center" id="metrics-label">
                                    <span class="metrics-label-text small"><span class="glyphicon glyphicon-stats"/> #{bundle['metrics.title']}</span>
                                </div>
                                <div class="pull-left">
                                    <div id="metrics-content" class="tab-content">
                                        <div id="metrics-views" class="metrics-views tab-pane fade small text-center">
                                            #{bundle['metrics.views']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                        <div id="metrics-downloads" class="metrics-downloads tab-pane small text-center active in">
                                            <h:outputFormat value="{0} #{bundle['metrics.downloads']}">
                                                <f:param value="#{guestbookResponseServiceBean.getCountGuestbookResponsesByDatasetId(DatasetPage.dataset.id)}"/>
                                            </h:outputFormat>
                                        </div>
                                        <div id="metrics-citations" class="metrics-citations tab-pane fade small text-center">
                                            #{bundle['metrics.citations']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                        <div id="metrics-shares" class="metrics-shares tab-pane fade small text-center">
                                            #{bundle['metrics.shares']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                    </div>
                                    <div id="metrics-tabs">
                                        <!-- DISABLED TOGGLE UNTIL FURTHER DEVELOPMENT ON METRICS IS COMPLETED
                                        ADDED style="pointer-events:none;" ATTRIBUTE TO A-HREF ELEMENTS BELOW
                                        REMOVED fade CLASS FROM metrics-downloads DIV ABOVE AND ADDED active in -->
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-views" style="pointer-events:none;" class="metrics-views" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-downloads" style="pointer-events:none;" class="metrics-downloads first" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-citations" style="pointer-events:none;" class="metrics-citations" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-shares" style="pointer-events:none;" class="metrics-shares" data-toggle="tab">&#160;</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END: Metrics -->
                            
                            <!-- View Dataset Versions Button -->
                            <!-- 4.2.1: replaced permissionServiceBean.on(DatasetPage.dataset).has('ViewUnpublishedDataset') with DatasetPage.canViewUnpublishedDataset() -->
                            <div class="btn-group pull-left" jsf:rendered="#{DatasetPage.releasedVersionTabList.size() > 1 or (DatasetPage.releasedVersionTabList.size() == 1 and DatasetPage.dataset.latestVersion.draft and DatasetPage.canViewUnpublishedDataset())}">
                                <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                    View Dataset Versions <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" role="menu">
                                    <ui:repeat value="#{DatasetPage.versionTabList}" var="versionLinks">
                                        <li class="#{DatasetPage.workingVersion == versionLinks ? 'disabled' : ''}">
                                            <h:outputLink styleClass="ui-commandlink ui-widget" value="/dataset.xhtml?persistentId=#{versionLinks.dataset.globalId}&#38;version=#{versionLinks.versionState}"
                                                          rendered="#{!(DatasetPage.workingVersion == versionLinks) and !(versionLinks.released or versionLinks.deaccessioned)}">
                                                <h:outputText value="#{versionLinks.versionState}" styleClass="#{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" /></h:outputLink>
                                            <h:outputText styleClass="ui-commandlink ui-widget ui-state-disabled #{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" value="#{versionLinks.versionState}"
                                                          rendered="#{(DatasetPage.workingVersion == versionLinks) and !(versionLinks.released or versionLinks.deaccessioned)}"/>
                                            <h:outputLink styleClass="ui-commandlink ui-widget" value="/dataset.xhtml?persistentId=#{versionLinks.dataset.globalId}&#38;version=#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}"
                                                          rendered="#{!(DatasetPage.workingVersion == versionLinks) and (versionLinks.released or versionLinks.deaccessioned)}">
                                                <h:outputText value="#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}" styleClass="#{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" /></h:outputLink>
                                            <h:outputText styleClass="ui-commandlink ui-widget ui-state-disabled #{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" value="#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}"
                                                          rendered="#{(DatasetPage.workingVersion == versionLinks) and !(versionLinks.draft)}"/>
                                        </li>
                                    </ui:repeat>
                                </ul>
                            </div>
                            <!-- END: Dataset Versions Button -->
                            
                            <div class="button-block pull-right">
                                <!-- Edit/Publish Button Group -->
                                <!-- Edit Button -->
                                <div class="btn-group pull-right" jsf:rendered="#{DatasetPage.sessionUserAuthenticated
                                                                                  and DatasetPage.canUpdateDataset()
                                                                                  and !DatasetPage.dataset.deaccessioned}">
                                    <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle #{DatasetPage.locked ? 'disabled' : ''}" data-toggle="dropdown">
                                        <span class="glyphicon glyphicon-pencil"/> #{bundle['dataset.editBtn']} <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu pull-right text-left" role="menu">
                                        <li>
                                            <h:outputLink value="/editdatafiles.xhtml?datasetId=#{DatasetPage.dataset.id}&#38;mode=UPLOAD">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.upload']}"/>
                                            </h:outputLink>
                                        </li>
                                        <li>
                                            <p:commandLink id="editMetadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@form,:datasetForm,:messagePanel" oncomplete="javascript:post_edit_metadata()">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.metadata']}" />
                                            </p:commandLink>
                                        </li>
                                        <li>
                                            <p:commandLink id="editTerms" actionListener="#{DatasetPage.edit('LICENSE')}" update="@form,:datasetForm,:messagePanel" oncomplete="javascript:post_edit_terms()">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.terms']}" />
                                            </p:commandLink>
                                        </li>
                                        <ui:fragment rendered="#{permissionsWrapper.canManagePermissions(DatasetPage.dataset)}">
                                            <li class="dropdown-submenu pull-left">
                                                <a tabindex="-1" href="#">#{bundle['dataset.editBtn.itemLabel.permissions']}</a>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <h:link id="managePermissions" styleClass="ui-commandlink ui-widget" outcome="permissions-manage">
                                                            <h:outputText value="Dataset" />
                                                            <f:param name="id" value="#{DatasetPage.dataset.id}" />
                                                        </h:link>
                                                    </li>
                                                    <li>
                                                        <h:link id="manageFilePermissions" styleClass="ui-commandlink ui-widget" outcome="permissions-manage-files">
                                                            <h:outputText value="File" />
                                                            <f:param name="id" value="#{DatasetPage.dataset.id}" />
                                                        </h:link>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li>
                                                <p:commandLink id="privateUrl" oncomplete="PF('privateUrlConfirmation').show()" action="#{DatasetPage.initPrivateUrlPopUp()}" update="privateUrlPanel">
                                                    <h:outputText value="#{bundle['dataset.editBtn.itemLabel.privateUrl']}" />
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <li>
                                            <h:outputLink value="/dataset-widgets.xhtml?datasetId=#{DatasetPage.dataset.id}">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.widgets']}"/>
                                            </h:outputLink>
                                        </li>
                                        <ui:fragment rendered="#{!DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deleteDataset" onclick="PF('deleteConfirmation').show()">
                                                    <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deleteDataset']}" />
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deleteVersion" onclick="PF('deleteVersionConfirmation').show()">
                                                    <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deleteDraft']}" />
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.existReleasedVersion and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deaccessionDatasetLink" onclick="PF('deaccessionBlock').show()"
                                                               action="#{DatasetPage.updateReleasedVersions()}"
                                                               oncomplete="PF('deaccessionBlock').show();bind_bsui_components();"
                                                               update="deaccessionBlock">
                                                    <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deaccession']}" />
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                    </ul>
                                </div>
                                <!-- END: Edit Button -->

                                <!-- Publish/Submit for Review/Return to Author Button Group -->
                                <div class="btn-group pull-right" role="group" jsf:rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                                                               or (DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                                                               and DatasetPage.canUpdateDataset()
                                                                                               and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset))}">
                                    <!-- Publish Buttons -->
                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="PF('publishConfirm').show()"
                                                   rendered="#{!DatasetPage.dataset.released
                                                               and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="PF('releaseDraft').show()"
                                                   rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <!-- 4.2.1:  replaced permissionServiceBean.on(DatasetPage.dataset.owner).has('PublishDataverse') with DatasetPage.canPublishDataverse() -->
                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="PF('mayNotRelease').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and !DatasetPage.canPublishDataverse()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="PF('publishParent').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                               and DatasetPage.canPublishDataverse()
                                                               and (DatasetPage.dataset.owner.owner == null or (DatasetPage.dataset.owner.owner != null and DatasetPage.dataset.owner.owner.released))
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                               and DatasetPage.canPublishDataverse()
                                                               and (DatasetPage.dataset.owner.owner != null and !DatasetPage.dataset.owner.owner.released)
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}"
                                                   onclick="PF('maynotPublishParent').show()">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>
                                    <!-- END: Publish Buttons -->

                                    <!-- Return to Author Button -->
                                    <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="PF('sendBackToContributor').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.latestVersion.inReview
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                                   #{bundle['dataset.rejectBtn']}
                                    </p:commandLink>
                                    <!-- END: Return to Author Button -->

                                    <!-- Submit for Review Button -->
                                    <button type="button" class="btn btn-default #{DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}" onclick="PF('inreview').show()"
                                            jsf:rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                            and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                            and DatasetPage.canUpdateDataset()
                                                            and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <span class="glyphicon glyphicon-globe"/> #{DatasetPage.dataset.latestVersion.inReview ? bundle['dataset.disabledSubmittedBtn'] : bundle['dataset.submitBtn']}
                                    </button>
                                    <!-- End: Submit for Review Button -->
                                </div>
                                <!-- END: Publish/Submit for Review/Return to Author Button Group -->
                                <!-- END: Edit/Publish Button Group -->
                                <!-- Email/Link/Share Button Group -->
                                <div class="btn-group pull-right" id="datasetButtonBar" role="group">
                                    <p:commandLink class="btn btn-default bootstrap-button-tooltip" title="#{bundle['dataset.email.datasetContactBtn']}"
                                                   update=":contactDialog" oncomplete="PF('contactForm').show()" actionListener="#{sendFeedbackDialog.initUserInput}">
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.userMessage}" value=""/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.userEmail}" value=""/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.messageSubject}" value=""/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.recipient}" value="#{DatasetPage.dataset}"/>
                                        <span class="glyphicon glyphicon-envelope no-text"/>
                                    </p:commandLink>
                                    <p:commandLink styleClass="btn btn-default bootstrap-button-tooltip" rendered="#{dataverseSession.user.superuser and !DatasetPage.workingVersion.deaccessioned}"
                                                   title="#{bundle['dataset.email.datasetLinkBtn.tip']}"
                                                   action="#{DatasetPage.updateLinkableDataverses()}"
                                                   oncomplete="PF('linkDatasetForm').show();bind_bsui_components();"
                                                   update="linkDatasetForm">
                                        <span class="glyphicon glyphicon-link no-text"/>
                                    </p:commandLink>
                                    <p:commandLink styleClass="btn btn-default bootstrap-button-tooltip" rendered="#{!DatasetPage.workingVersion.deaccessioned}"
                                                   title="#{bundle['dataset.share.datasetShare']}"
                                                   oncomplete="PF('shareDialog').show();sharrre();">
                                        <span class="glyphicon glyphicon-share no-text"/>
                                    </p:commandLink>
                                </div>
                                <p:dialog id="shareDialog" header="#{bundle['dataset.share.datasetShare']}" widgetVar="shareDialog" modal="true" rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                    <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.share.datasetShare.tip']}</p>

                                    <div id="sharrre-widget" data-url="#{DatasetPage.dataverseSiteUrl}/dataset.xhtml?persistentId=#{dataset.globalId}" data-text="#{bundle['dataset.share.datasetShare.shareText']}"></div>

                                    <div class="button-block">
                                        <button type="button" onclick="PF('shareDialog').hide()" class="btn btn-default" value="#{bundle.close}">
                                            #{bundle.close}
                                        </button>
                                    </div>
                                </p:dialog>
                                <!-- END: Email/Link/Share Button Group -->
                            </div>
                        </div>
                        <div id="datasetVersionBlock" class="container-fluid">
                            <div id="title-block" class="row" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.title.value}">
                                <span id="title">#{DatasetPage.datasetVersionUI.title.value}</span>
                                <h:outputText value="#{bundle['dataset.versionUI.draft']}" styleClass="label label-primary" rendered="#{DatasetPage.workingVersion.draft}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.inReview']}" styleClass="label label-success" rendered="#{DatasetPage.workingVersion.inReview}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.unpublished']}" styleClass="label label-warning" rendered="#{!DatasetPage.dataset.released}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.deaccessioned']}" styleClass="label label-danger" rendered="#{DatasetPage.workingVersion.deaccessioned}"/>
                            </div>
                            <!-- CITATION BLOCK -->
                            <ui:fragment rendered="#{!empty DatasetPage.displayCitation}">
                                <ui:include src="dataset-citation.xhtml">
                                    <ui:param name="datasetPage" value="true"/>
                                </ui:include>
                            </ui:fragment>
                            <!-- END: CITATION BLOCK -->
                            <div id="deaccession-reason-block" class="row bg-danger" jsf:rendered="#{DatasetPage.workingVersion.deaccessioned}">
                                <h5 class="margin-top-half">#{bundle['dataset.deaccession.reason']}</h5>
                                <p>#{DatasetPage.workingVersion.versionNote}</p>
                                <ui:fragment rendered="#{!empty DatasetPage.workingVersion.archiveNote}">
                                    <p>#{bundle['dataset.beAccessedAt']} <a href="#{DatasetPage.workingVersion.archiveNote}" target="_blank">#{DatasetPage.workingVersion.archiveNote}</a></p>
                                </ui:fragment>
                            </div>
                            <div id="metadata-panel" class="row panel panel-default"
                                 jsf:rendered="#{!widgetWrapper.widgetView and !DatasetPage.workingVersion.deaccessioned and
                                                 (!empty DatasetPage.datasetVersionUI.descriptionDisplay
                                                 or !empty DatasetPage.datasetVersionUI.keywordDisplay
                                                 or !empty DatasetPage.datasetVersionUI.subject.value
                                                 or !empty DatasetPage.datasetVersionUI.relPublicationCitation
                                                 or !empty DatasetPage.datasetVersionUI.notes.value)}">
                                <div class="panel-body metadata-panel-body">
                                    <div id="description" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.descriptionDisplay}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.description.datasetFieldType.description}">#{bundle['dataset.descriptionDisplay.title']}</span>
                                        </label>
                                        <div class="col-sm-9"><h:outputText value="#{DatasetPage.datasetVersionUI.descriptionDisplay}" escape="false"/></div>
                                    </div>
                                    <div id="subject" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.subject.value}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.subject.datasetFieldType.description}">#{DatasetPage.datasetVersionUI.subject.datasetFieldType.title}</span>
                                        </label>
                                        <div class="col-sm-9">#{DatasetPage.datasetVersionUI.subject.displayValue}</div>
                                    </div>
                                    <div id="keywords" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.keywordDisplay}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.keyword.datasetFieldType.description}">#{bundle['dataset.keywordDisplay.title']}</span>
                                        </label>
                                        <div class="col-sm-9">#{DatasetPage.datasetVersionUI.keywordDisplay}</div>
                                    </div>
                                    <div id="publication" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.relPublicationCitation}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).description}">#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).title}</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetVersionUI.relPublicationCitation)}" escape="false"/>
                                            <a href="#{DatasetPage.datasetVersionUI.relPublicationUrl}" title="#{DatasetPage.datasetVersionUI.relPublicationUrl}" target="_blank">#{DatasetPage.datasetVersionUI.relPublicationId}</a>
                                        </div>
                                    </div>
                                    <div id="note" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.notes.value}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.notes.datasetFieldType.description}">#{DatasetPage.datasetVersionUI.notes.datasetFieldType.title}</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetVersionUI.notes.value)}" escape="false"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END View editMode -->

                    <!-- Create/Edit editMode -->
                    <ui:fragment rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE'}">
                        <div class="form-group">
                            <label for="select_HostDataverse" class="col-sm-2 control-label">
                                <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['dataverse.host.title']}">
                                    #{bundle.hostDataverse}
                                </span>
                            </label>
                            <div class="col-sm-10">
                                <h:outputText styleClass="highlightBold" value="#{DatasetPage.dataset.owner.name} #{bundle.dataverse}"/>
                                <h:inputHidden value="#{DatasetPage.ownerId}" id="select_HostDataverse" />
                                <ui:remove><!-- removed for beta -->
                                    <p:selectOneMenu id="select_HostDataverse" value="#{DatasetPage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                        <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"/>
                                    </p:selectOneMenu>
                                </ui:remove>
                            </div>
                        </div>
                        <div class="form-group" jsf:rendered="#{!empty DatasetPage.dataverseTemplates and DatasetPage.editMode == 'CREATE'}">
                            <label for="select_DatasetTemplate" class="col-sm-2 control-label">
                                <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['dataset.manageTemplates.tab.action.btn.view.dialog.datasetTemplate.title']}">
                                    #{bundle['dataset.manageTemplates.tab.action.btn.view.dialog.datasetTemplate']}
                                </span>
                            </label>
                            <div class="col-sm-6">
                                <p class="help-block">
                                    <span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.template.tip']}
                                </p>
                                <p:selectOneMenu value="#{DatasetPage.selectedTemplate}" onchange="updateTemplate()"
                                                 converter="templateConverter" id="select_DatasetTemplate" styleClass="form-control"
                                                 valueChangeListener="#{DatasetPage.updateSelectedTemplate}"
                                                 style="width:auto !important; max-width:100%; min-width:200px;">
                                    <f:selectItem itemLabel="#{bundle['dataset.noTemplate.label']}" itemValue="#{null}" />
                                    <f:selectItems value="#{DatasetPage.dataverseTemplates}"
                                                   var="template" itemLabel="#{template.name}" itemValue="#{template}"/>
                                </p:selectOneMenu>
                                <p:commandButton value="Direct" id="updateTemplate"
                                                 style="display:none"
                                                 update=":datasetForm,accessPopup"
                                                 action="#{DatasetPage.handleChangeButton}">
                                </p:commandButton>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-12">
                                <span class="glyphicon glyphicon-asterisk text-danger"/> <h:outputText value="#{bundle['dataset.asterisk.tip']}"/>
                            </div>
                        </div>
                    </ui:fragment>
                    <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                        <ui:include src="metadataFragment.xhtml">
                            <ui:param name="datasetPage" value="true"/>
                            <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? DatasetPage.editMode : ''}"/>
                            <ui:param name="metadataBlocks" value="#{!empty DatasetPage.editMode ? DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray(): DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}"/>
                            <ui:param name="publicationDate" value="#{DatasetPage.dataset.publicationDateFormattedYYYYMMDD}"/>
                            <ui:param name="globalId" value="#{DatasetPage.dataset.globalId}"/>
                        </ui:include>
                    </ui:fragment>
                    <!-- END Create/Edit editMode -->

                    <!-- Edit editMode -->
                    <div class="button-block form-top" jsf:rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'LICENSE'}">
                        <p:commandButton id="saveTop" value="#{bundle.saveChanges}" onclick="checkNewlyRestricted();PF('blockDatasetForm').show();" />
                        <p:commandButton id="cancelTop" value="#{bundle.cancel}" action="#{DatasetPage.cancel}" process="@this" update="@form" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                    </div>
                    <!-- END Header / Button Panel -->
                    <!-- View/Tabs infoMode -->
                    <!-- Tabs -->
                    <div id="contentTabs" jsf:rendered="#{DatasetPage.editMode != 'INFO'}">

                        <p:fragment id="pageRefreshFragment"> <!-- rendered="_{empty DatasetPage.editMode}" -->
                            <h:inputHidden value="#{DatasetPage.locked}" id="datasetLockedVariable" />
                            <h:inputHidden value="#{DatasetPage.stateChanged}" id="datasetStateChangedVariable" />

                            <p:remoteCommand name="refreshLockCommand" process="@this" update=":#{p:component('pageRefreshFragment')}" actionListener="#{DatasetPage.refreshLock}"/>
                            <p:remoteCommand name="refreshAllCommand" process="@this" update="@all" actionListener="#{DatasetPage.refresh}"/>

                            <!-- see the comment in the javascript below that explains what this button is for -->
                            <p:commandButton id="refreshButton" process="@this" widgetVar="refreshButton" update="@all" style="display:none"/>

                            <script type="text/javascript">

                                $(this).ready(function () {
                                    refreshIfStillLocked();
                                });

                                function refreshIfStillLocked() {
                                    if ($('input[id$="datasetLockedVariable"]').val() === 'true') {
                                        // if dataset is locked, instruct the page to
                                        // wait and check again:
                                        waitAndCheckLockAgain();
                                    } else {
                                        // if not locked, has it just been unlocked?
                                        if ($('input[id$="datasetStateChangedVariable"]').val() === 'true') {
                                            // For whatever unknown PrimeFaces reason
                                            // the page needs to be refreshed twice, for all
                                            // the pull down menus to update properly:
                                            refreshAllCommand();
                                            // You can't just run 2 refreshAllCommand()s in a row
                                            // either; because the command has an "update=@all" on it,
                                            // so I guess if you try to execute the 2nd one right after
                                            // the first one, this fragment is still going to be loading -
                                            // so there would not yet be a command to run! (it needs to
                                            // be rendered, before you can execute it, that is)
                                            setTimeout(function () {
                                                // this button doesn't do anything, but it has an update="@all"
                                                // attribute:
                                                $('button[id$="refreshButton"]').trigger('click');
                                                //refreshAllCommand();
                                            }, 1500);
                                        }
                                    }
                                }

                                function waitAndCheckLockAgain() {
                                    setTimeout(function () {
                                        // refresh the lock in the
                                        // backing bean; i.e., check, if the ingest has
                                        // already completed in the background:
                                        //$('button[id$="refreshButton"]').trigger('click');
                                        refreshLockCommand();
                                    }, 10000);
                                }

                            </script>


                        </p:fragment>

                        <ui:fragment id="uploadFilesOnCreateTab" rendered="#{!DatasetPage.workingVersion.deaccessioned and
                                                                             (DatasetPage.editMode == 'CREATE')}">
                            <ui:include src="editFilesFragment.xhtml">
                                <ui:param name="datasetPage" value="true"/>
                                <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
                                <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
                                <ui:param name="version" value="#{DatasetPage.workingVersion}"/>
                            </ui:include>

                        </ui:fragment>

                        <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}"
                                   rendered="#{empty DatasetPage.editMode or (DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'LICENSE')}">
                            <p:ajax event="tabChange" listener="#{DatasetPage.tabChanged}" oncomplete="bind_bsui_components();" update="@this" />
                            <p:tab id="dataFilesTab" title="#{bundle.files}" rendered="#{(!DatasetPage.workingVersion.deaccessioned or 
                                                              (DatasetPage.workingVersion.deaccessioned and DatasetPage.canUpdateDataset()))  and
                                                              (empty DatasetPage.editMode)}">
                                <ui:include src="filesFragment.xhtml">
                                    <ui:param name="fileDownloadHelper" value="#{DatasetPage.fileDownloadHelper}"/>
                                </ui:include>
                            </p:tab>

                            <!-- 4.2.1: the 3 tabs below - metadata, terms and versions: these account for ~100 queries total -->
                            <!-- a lot of these however, are repeated queries on AuthenticatedUser and RoleAssignment; once these are optimized, the tabs will become very cheap. -->
                            <p:tab id="metadataMapTab" title="#{bundle['file.dataFilesTab.metadata.header']}"
                                   rendered="#{(!DatasetPage.workingVersion.deaccessioned or (DatasetPage.workingVersion.deaccessioned and DatasetPage.canUpdateDataset())) 
                                               and (empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA')}">
                                <div class="button-block tab-header margin-bottom text-right" jsf:rendered="#{empty DatasetPage.editMode and !widgetWrapper.widgetView}">
                                    <p:commandLink type="button" styleClass="btn btn-default" actionListener="#{DatasetPage.edit('METADATA')}" update="@form,:messagePanel" oncomplete="javascript:post_edit_metadata()" 
                                                   disabled="#{DatasetPage.locked}" rendered="#{DatasetPage.sessionUserAuthenticated and empty DatasetPage.editMode and !widgetWrapper.widgetView
                                                               and DatasetPage.canUpdateDataset() and !DatasetPage.dataset.deaccessioned }">
                                        <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        <span class="glyphicon glyphicon-pencil"/> #{bundle['file.dataFilesTab.metadata.addBtn']}
                                    </p:commandLink>                                   
                                    <div class="btn-group" jsf:rendered="#{DatasetPage.dataset.released and !DatasetPage.dataset.deaccessioned}" >
                                        <button class="btn btn-default dropdown-toggle" type="button" styleClass="btn btn-default" data-toggle="dropdown">
                                            <span class="glyphicon glyphicon-export"/> #{bundle['dataset.exportBtn']} <span class="caret"/></button>
                                        <ul class="dropdown-menu" role="menu">
                                            <ui:repeat var="exporter" value="#{DatasetPage.exporters}">
                                                <li>
                                                    <h:outputLink value="#{exporter[1]}" target="_blank">
                                                        <h:outputText value="#{exporter[0]}"/>
                                                    </h:outputLink>
                                                </li>  
                                            </ui:repeat>
                                        </ul>
                                    </div>
                                </div>
                                <ui:include src="metadataFragment.xhtml">
                                    <ui:param name="datasetPage" value="true"/>
                                    <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? DatasetPage.editMode : ''}"/>
                                    <ui:param name="metadataBlocks" value="#{!empty DatasetPage.editMode ? DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray(): DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}"/>
                                    <ui:param name="publicationDate" value="#{DatasetPage.dataset.publicationDate != null ? DatasetPage.dataset.publicationDateFormattedYYYYMMDD : ''}"/>
                                    <ui:param name="globalId" value="#{DatasetPage.dataset.globalId}"/>
                                </ui:include>
                                <!-- commented out as handled by export button above
                                to enable in development: curl -X PUT -d true http://localhost:8080/api/admin/settings/:DdiExportEnabled
                                <div jsf:rendered="#{DatasetPage.metadataExportEnabled}">                                  
                                    <h:outputLink value="#{DatasetPage.metadataAsJsonUrl}" rendered="#{DatasetPage.metadataAsJsonUrl != null}">
                                        <h:outputText value="Export metadata as JSON"/>
                                    </h:outputLink>
                                </div>
                                -->
                            </p:tab>

                            <!-- 4.2.1: see comment above -->
                            <p:tab id="termsTab" title="#{bundle['file.dataFilesTab.terms.header']}"
                                   rendered="#{!DatasetPage.workingVersion.deaccessioned and (empty DatasetPage.editMode or DatasetPage.editMode == 'LICENSE')}">
                                <ui:include src="dataset-license-terms.xhtml">
                                    <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? 'LICENSE': ''}"/>
                                    <ui:param name="termsOfUseAndAccess" value="#{DatasetPage.workingVersion.termsOfUseAndAccess}"/>
                                    <ui:param name="datasetPage" value="true"/>
                                </ui:include>
                            </p:tab>
                            <!-- 4.2.1: see above -->
                            <p:tab id="versionsTab" title="#{bundle['file.dataFilesTab.versions']}" rendered="#{empty DatasetPage.editMode}">
                                <ui:include src="dataset-versions.xhtml"></ui:include>
                            </p:tab>
                        </p:tabView>
                    </div>
                    <!-- END View/Tabs infoMode -->

                    <!-- Create Metadata Tip -->
                    <div class="alert alert-info margin-top" jsf:rendered="#{DatasetPage.editMode == 'CREATE'}">
                        #{bundle['file.metadataTip']}
                    </div>

                    <!-- Create/Save Dataset Button Panel -->
                    <div class="button-block" jsf:rendered="#{!empty DatasetPage.editMode}">
                        <p:commandButton tabindex="1000" id="save" value="#{DatasetPage.editMode == 'CREATE' ? bundle['file.addBtn'] : bundle.saveChanges}" onclick="checkNewlyRestricted();PF('blockDatasetForm').show();" />
                        <p:commandButton tabindex="1000" id="cancel" value="#{bundle.cancel}" action="#{DatasetPage.cancel}" process="@this" update="@form" rendered="#{DatasetPage.editMode != 'CREATE'}" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                        <p:button id="cancelCreate" value="#{bundle.cancel}" outcome="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}" rendered="#{DatasetPage.editMode == 'CREATE'}" />
                        <p:commandButton value="Direct" id="datasetSave"
                                         style="display:none"
                                         update=":datasetForm,:messagePanel"
                                         oncomplete="javascript:bind_bsui_components();$(document).scrollTop(0);"
                                         action="#{DatasetPage.save}" />
                    </div>
                    <!-- END: Create/Save Dataset Button Panel -->

                    <p:blockUI block="datasetForm" widgetVar="blockDatasetForm"/>

                    <!-- Popups -->
                    <p:dialog styleClass="smallPopUp" header="#{bundle['dataset.inValidSelectedFilesForDownload']}" widgetVar="downloadInvalid" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noValidSelectedFilesForDownload']}</p>
                        <ui:fragment   rendered="#{DatasetPage.dataset.fileAccessRequest}"  >
                            <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.requestAccessToRestrictedFiles']}</p>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('downloadInvalid').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['dataset.inValidSelectedFilesForDownload']}" widgetVar="downloadMixed" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.mixedSelectedFilesForDownload']}</p>
                        <table>
                            <ui:repeat var="resFile" value="#{DatasetPage.selectedNonDownloadableFiles}" >
                                <tr>
                                    <td>#{resFile.label}</td>
                                </tr>
                            </ui:repeat>
                        </table>
                        <div class="button-block">
                            <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.downloadUnrestricted']}</p>
                            <ui:fragment rendered="#{!DatasetPage.downloadPopupRequired}">
                                <p:commandButton value="#{bundle.continue}" onclick="PF('downloadMixed').hide()" action="#{DatasetPage.startMultipleFileDownload(false)}" />
                            </ui:fragment>
                            <ui:fragment rendered="#{DatasetPage.downloadPopupRequired}">
                                <p:commandButton value="#{bundle.continue}" onclick="PF('downloadMixed').hide()"
                                                 action="#{DatasetPage.modifyGuestbookMultipleResponse()}" update="@form" />
                            </ui:fragment>
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('downloadMixed').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDialog.header']}" widgetVar="deleteConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDialog.tip']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('deleteConfirmation').hide()" action="#{DatasetPage.deleteDataset()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('deleteConfirmation').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDraftDialog.header']}" widgetVar="deleteVersionConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDraftDialog.tip']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('deleteVersionConfirmation').hide()" action="#{DatasetPage.deleteDatasetVersion()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('deleteVersionConfirmation').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog id="privateUrlId" styleClass="smallPopUp" header="#{bundle['dataset.privateurl.header']}" widgetVar="privateUrlConfirmation" modal="true">
                        <p:fragment id="privateUrlPanel" rendered="#{DatasetPage.userCanCreatePrivateURL}">
                            <p class="help-block"><span class="glyphicon glyphicon-info-sign"/>&#160;
                                <h:outputFormat value="#{bundle['dataset.privateurl.tip']}" escape="false">
                                    <f:param value="#{systemConfig.guidesBaseUrl}"/>
                                    <f:param value="#{systemConfig.version}"/>
                                </h:outputFormat>
                            </p>
                            <div>
                                <div class="highlight" jsf:rendered="#{empty(DatasetPage.privateUrl)}">
                                    <p class="no-margin-bottom">#{bundle['dataset.privateurl.absent']}</p>
                                </div>
                                <div class="highlight" jsf:rendered="#{!empty(DatasetPage.privateUrl)}" onclick="if (event.target) {
                                            selectText(event.target);
                                        } else {
                                            selectText(this);
                                        }">
                                    <p class="text-success highlightBold" jsf:rendered="#{DatasetPage.privateUrlWasJustCreated}"><span class="glyphicon glyphicon glyphicon-ok"/> #{bundle['dataset.privateurl.createdSuccess']}</p>
                                    <ui:param name="privateUrlLink" value="#{DatasetPage.getPrivateUrlLink(DatasetPage.privateUrl)}" />
                                    <p class="no-margin-bottom">
                                        <span>#{privateUrlLink}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="button-block">
                                <p:commandButton styleClass="btn btn-default" value="#{bundle['dataset.privateurl.createPrivateUrl']}" action="#{DatasetPage.createPrivateUrl()}" update="privateUrlPanel,:messagePanel" rendered="#{empty(DatasetPage.privateUrl)}" />
                                <p:commandButton styleClass="btn btn-default" value="#{bundle['dataset.privateurl.disablePrivateUrl']}" action="#{DatasetPage.setPrivateUrlJustCreatedToFalse()}" onclick="PF('privateUrlConfirmation').hide();PF('disablePrivateUrlConfirmation').show()" rendered="#{!empty(DatasetPage.privateUrl)}" update="privateUrlPanel"/>
                                <p:commandButton styleClass="btn btn-default" value="#{bundle.close}" onclick="PF('privateUrlConfirmation').hide();PF('blockDatasetForm').hide();" update="privateUrlPanel"/>
                            </div>
                        </p:fragment>
                        <p:fragment id="privateUrlPanelCannotCreate" rendered="#{!DatasetPage.userCanCreatePrivateURL}">
                            <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.privateurl.cannotCreate']}</p>
                            <div class="button-block">
                                <p:commandButton styleClass="btn btn-default" value="#{bundle.cancel}" onclick="PF('privateUrlConfirmation').hide();PF('blockDatasetForm').hide();" type="button" />
                            </div>
                        </p:fragment>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['dataset.privateurl.header']}" widgetVar="disablePrivateUrlConfirmation" modal="true" closable="false">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.privateurl.disableConfirmationText']}</p>
                        <div class="button-block">
                            <p:commandButton styleClass="btn btn-default" value="#{bundle['dataset.privateurl.disablePrivateUrlConfirm']}" action="#{DatasetPage.disablePrivateUrl()}" update="privateUrlPanel,:messagePanel" onclick="PF('disablePrivateUrlConfirmation').hide();"/>
                            <p:commandButton styleClass="btn btn-default" value="#{bundle.cancel}" onclick="PF('disablePrivateUrlConfirmation').hide();PF('privateUrlConfirmation').show();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteFileDialog.header']}" widgetVar="deleteFileConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.tip']}</p>
                        <ui:fragment rendered="#{DatasetPage.dataset.released}">
                            <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.failed.tip']}</p>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('deleteFileConfirmation').hide()" oncomplete="window.scrollTo(0, 0);"
                                             update=":#{p:component('filesTable')},:messagePanel" action="#{DatasetPage.deleteFiles()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('deleteFileConfirmation').hide();
                                    PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteFileDialog.header']}" widgetVar="deleteSelectedFileConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.multiple.immediate']}</p>
                        <ui:fragment rendered="#{DatasetPage.dataset.released}">
                            <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.failed.tip']}</p>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['file.delete']}" onclick="PF('deleteSelectedFileConfirmation').hide()"
                                             action="#{DatasetPage.deleteFilesAndSave()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('deleteSelectedFileConfirmation').hide();
                                    PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionBlock" header="#{bundle['dataset.editBtn.itemLabel.deaccession']}" widgetVar="deaccessionBlock" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.tip']}</p>
                        <div class="form-group" jsf:rendered="#{DatasetPage.releasedVersionTabList.size() > 1}">
                            <label for="versionDeaccessionTable">#{bundle['file.deaccessionDialog.reason.question1']} <span class="glyphicon glyphicon-asterisk text-danger" title="#{bundle.requiredField}"/></label>
                            <p:dataTable id="versionDeaccessionTable" value="#{DatasetPage.releasedVersionTabList}" var="versionTab" widgetVar="versionDeaccessionTable"
                                         rowIndexVar="rowNum" selection="#{DatasetPage.selectedDeaccessionVersions}" rowKey="#{versionTab}">
                                <p:column selectionMode="multiple" class="col-select-width text-center"/>
                                <p:column>
                                    <h:outputText value="#{bundle['file.deaccessionDialog.version']} #{versionTab.versionNumber}.#{versionTab.minorVersionNumber}, #{versionTab.versionDate}" />
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div class="form-group">
                            <label for="reasonOptions">#{bundle['file.deaccessionDialog.reason.question2']} <span class="glyphicon glyphicon-asterisk text-danger" title="#{bundle.requiredField}"/></label>
                            <h:selectOneMenu id="reasonOptions" styleClass="form-control" value="#{DatasetPage.deaccessionReasonRadio}">
                                <f:selectItem itemLabel="#{bundle.select}" itemValue="0" noSelectionOption="true" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.identifiable']}" itemValue="1" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.beRetracted']}" itemValue="2" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.beTransferred']}" itemValue="3" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.IRB']}" itemValue="4" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.legalIssue']}" itemValue="5" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.notValid']}" itemValue="6" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.other']}" itemValue="7" />
                            </h:selectOneMenu>
                        </div>
                        <div class="form-group">
                            <label for="reasonForDeaccession">
                                #{bundle['file.deaccessionDialog.enterInfo']}
                            </label>
                            <p:inputTextarea id="reasonForDeaccession" styleClass="form-control" immediate="true" autoResize="false" rows="2" cols="40"
                                             onkeyup="updateHiddenReason(this);" value="#{DatasetPage.deaccessionReasonText}" widgetVar="reasonForDeaccession"/>
                            <p:message for="reasonForDeaccession"/>
                        </div>
                        <div class="form-group">
                            <label for="forwardURLForDeaccession">
                                #{bundle['file.deaccessionDialog.leaveURL']}
                            </label>
                            <p:inputText id="forwardURLForDeaccession" styleClass="form-control" value="#{DatasetPage.deaccessionForwardURLFor}" widgetVar="forwardURLForDeaccession"/>
                            <p:watermark for="forwardURLForDeaccession" value="#{bundle['file.deaccessionDialog.leaveURL.watermark']}" id="watermark" />
                        </div>
                        <div class="button-block">
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.deaccession}" rendered="#{DatasetPage.releasedVersionTabList.size() > 1}"
                                           onclick="testDeaccessionVersionSelection(true);"/>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.deaccession}" rendered="#{DatasetPage.releasedVersionTabList.size() == 1}"
                                           onclick="testDeaccessionVersionSelection(false);"/>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.cancel}" onclick="PF('deaccessionBlock').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionConfirmation" header="Deaccession Dataset" widgetVar="deaccessionConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.deaccession.tip']}</p>
                        <div class="button-block">
                            <h:commandButton styleClass="btn btn-default" value="#{bundle.yes}" onclick="PF('deaccessionConfirmation').hide();
                                    PF('deaccessionBlock').hide()" action="#{DatasetPage.deaccessionVersions}" />
                            <button type="button" class="btn btn-default" value="No" onclick="PF('deaccessionConfirmation').hide()">#{bundle.no}</button>
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionAllConfirmation" header="#{bundle['dataset.editBtn.itemLabel.deaccession']}" widgetVar="deaccessionAllConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.deaccessionDataset.tip']}</p>
                        <div class="button-block">
                            <h:commandButton styleClass="btn btn-default" value="Yes" onclick="PF('deaccessionAllConfirmation').hide();
                                    PF('deaccessionBlock').hide();
                                    PF('blockDatasetForm').hide();" action="#{DatasetPage.deaccessionVersions}" />
                            <button type="button" class="btn btn-default" value="No" onclick="PF('deaccessionAllConfirmation').hide();
                                    PF('blockDatasetForm').hide();">#{bundle.no}</button>
                        </div>
                    </p:dialog>
                    <p:confirmDialog id="selectDeaccessionVersion" message="#{bundle['file.deaccessionDialog.dialog.selectVersion.tip']}" header="#{bundle['file.deaccessionDialog.dialog.selectVersion.header']}" widgetVar="selectDeaccessionVersion"> </p:confirmDialog>
                    <p:confirmDialog id="selectDeaccessionReason" message="#{bundle['file.deaccessionDialog.dialog.reason.tip']}" header="#{bundle['file.deaccessionDialog.dialog.reason.header']}" widgetVar="selectDeaccessionReason"> </p:confirmDialog>
                    <p:confirmDialog id="enterForwardUrl" message="#{bundle['file.deaccessionDialog.dialog.url.tip']}" header="#{bundle['file.deaccessionDialog.dialog.url.header']}" widgetVar="enterForwardUrl"> </p:confirmDialog>
                    <p:confirmDialog id="enterOtherReason" message="#{bundle['file.deaccessionDialog.dialog.textForReason.tip']}" header="#{bundle['file.deaccessionDialog.dialog.textForReason.header']}" widgetVar="enterOtherReason"> </p:confirmDialog>
                    <p:confirmDialog id="reasonTooManyCharacters" message="#{bundle['file.deaccessionDialog.dialog.limitChar.tip']}" header="#{bundle['file.deaccessionDialog.dialog.limitChar.header']}" widgetVar="reasonTooManyCharacters"> </p:confirmDialog>
                    <p:inputText id="hiddenReasonInput" style="display:none" widgetVar="hiddenReasonInput"/>
                    <p:dialog id="compareTwo" header="#{bundle['file.viewDiffDialog.header']}" widgetVar="compareTwo" modal="true">
                        <p class="help-block"><span class="glyphicon glyphicon-warning-sign text-danger"/> <span class="text-danger">#{bundle['file.viewDiffDialog.dialog.warning']}</span></p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('compareTwo').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog id="detailsBlocks" styleClass="largePopUp" header="#{bundle['file.viewDiffDialog.header']}" widgetVar="detailsBlocks" modal="true">
                        <div id="version-title" class="margin-bottom-half">#{DatasetPage.datasetVersionDifference.newVersion.title}</div>
                        <div id="version-details-block" class=" clearfix margin-bottom-half">
                            <div class="pull-left">
                                &#160;
                            </div>
                            <div class="pull-left">
                                #{bundle['file.viewDiffDialog.version']}: #{DatasetPage.datasetVersionDifference.originalVersion.semanticVersion}<br/>
                                #{bundle['file.viewDiffDialog.lastUpdated']}: #{DatasetPage.datasetVersionDifference.originalVersion.lastUpdateTime}
                            </div>
                            <div class="pull-left">
                                #{bundle['file.viewDiffDialog.version']}: #{DatasetPage.datasetVersionDifference.newVersion.semanticVersion}<br/>
                                #{bundle['file.viewDiffDialog.lastUpdated']}: #{DatasetPage.datasetVersionDifference.newVersion.lastUpdateTime}
                            </div>
                        </div>
                        <ui:fragment rendered="#{!empty(DatasetPage.datasetVersionDifference.detailDataByBlock)}">
                            <ui:repeat value="#{DatasetPage.datasetVersionDifference.detailDataByBlock}" var="block">
                                <div class="panel panel-default">
                                    <div class="panel-heading text-info">
                                        <h:outputText value="#{block.get(0)[0].datasetFieldType.metadataBlock.displayName}" />
                                    </div>
                                    <p:dataTable id="byBlockInner" styleClass="dvnDifferanceTable" var="dsfArray" value="#{block}">
                                        <p:column styleClass="versionValue">
                                            <h:outputText value="#{dsfArray[0].datasetFieldType.title}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails">
                                            <h:outputText rendered="#{dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].displayValue}" />
                                            <h:outputText rendered="#{!dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].compoundDisplayValue}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails" >
                                            <h:outputText rendered="#{dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].displayValue}" />
                                            <h:outputText rendered="#{!dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].compoundDisplayValue}" />
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </ui:repeat>
                        </ui:fragment>
                        <div class="panel panel-default" jsf:rendered="#{!empty(DatasetPage.datasetVersionDifference.fileNote)}">
                            <div class="panel-heading text-info" rendered="#{!empty(DatasetPage.datasetVersionDifference.datasetFilesDiffList)}">
                                <h:outputText id="outputText" value="#{bundle.files}"/>
                            </div>
                            <p:dataTable id="diffFilesDataTable" styleClass="dvnDifferanceTable" value="#{DatasetPage.datasetVersionDifference.datasetFilesDiffList}" var="fileDiff">
                                <p:column styleClass="versionValue">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileID']} #{fileDiff.fileId}"/>
                                    <br></br>
                                    <h:outputText value="#{fileDiff.fileChecksumType} #{fileDiff.fileChecksumValue}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{! fileDiff.file1Empty}">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileName']}: #{fileDiff.fileName1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileType']}: #{fileDiff.fileType1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileSize']}: #{fileDiff.fileSize1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.category']}: #{fileDiff.fileCat1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.description']}: #{fileDiff.fileDesc1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.restricted']}: #{fileDiff.fileRest1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileRest1 != null}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{fileDiff.file1Empty}">
                                    &#160;
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{! fileDiff.file2Empty}">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileName']}: #{fileDiff.fileName2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileType']}: #{fileDiff.fileType2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileSize']}: #{fileDiff.fileSize2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.category']}: #{fileDiff.fileCat2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.description']}: #{fileDiff.fileDesc2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.restricted']}: #{fileDiff.fileRest2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileRest2 != null}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{fileDiff.file2Empty}">
                                    &#160;
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div class="panel panel-default" jsf:rendered="#{!empty(DatasetPage.datasetVersionDifference.changedTermsAccess)}">
                            <div class="panel-heading text-info" >
                                <h:outputText id="outputTextTOU" value="#{bundle['dataset.versionDifferences.termsOfUseAccess']}"/>
                            </div>
                            <p:dataTable id="changedTermsAccessTable" styleClass="dvnDifferanceTable" var="diffArray" value="#{DatasetPage.datasetVersionDifference.changedTermsAccess}">
                                <p:column styleClass="versionValue">
                                    <h:outputText value="#{diffArray[0]}" />
                                </p:column>
                                <p:column styleClass="versionDetails">
                                    <h:outputText value="#{diffArray[1]}" />
                                </p:column>
                                <p:column styleClass="versionDetails" >
                                    <h:outputText value="#{diffArray[2]}"/>
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div class="button-block margin-bottom">
                            <p:commandButton value="#{bundle.done}" onclick="PF('detailsBlocks').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForDownload" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForDownload" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForDownload']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForDownload').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForRequestAccess" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForRequestAccess" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForRequestAccess']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForRequestAccess').hide();
                                    PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForDelete" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForDelete" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForDelete']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForDelete').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForRestrict" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForRestrict" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForRestrict']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForRestrict').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForUnRestrict" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForUnRestrict" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForUnRestrict']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForUnRestrict').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForEditMetadata" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForEditMetadata" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForMetadataEdit']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForEditMetadata').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:dialog id="selectFilesForEditTags" styleClass="smallPopUp"
                              header="#{bundle['dataset.noSelectedFiles.header']}" widgetVar="selectFilesForEditTags" modal ="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.noSelectedFilesForMetadataEdit']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('selectFilesForEditTags').hide();PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>

                    <p:remoteCommand  name="refreshTagsCommand" action="#{DatasetPage.refreshTagsPopUp()}" update=":datasetForm:fileTagsPopup"
                                      oncomplete="PF('fileTagsPopup').show();"/>

                    <!-- We no longer need this remoteCommand; see my comments in the javascript method testFilesSelectedForEditMetadata() -->
                    <!-- for more info. - L.A. 4.2.1 -->
                    <!-- p:remoteCommand  name="openEditFilesPageCommand" action=" {DatasetPage.editFileMetadata()}"  / -->

                    <p:dialog id="fileTagsPopup" styleClass="smallPopUp" header="#{bundle['file.editTags']}" widgetVar="fileTagsPopup" modal="true">
                        <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['file.editTagsDialog.tip']}</p>
                        <div class="form-horizontal" jsf:rendered="#{!(empty DatasetPage.selectedFiles)}">
                            <div class="form-group text-left">
                                <label for="selectedTagsList" class="col-sm-4 control-label">
                                    #{bundle['file.editTagsDialog.selectedTags']}
                                </label>
                                <div class="col-sm-8">
                                    <p:outputPanel id="selectedTagsList" style="padding-top:.5em;">
                                        <h:outputText value="#{bundle['file.editTagsDialog.selectedTags.none']}" rendered="#{(empty DatasetPage.selectedTags) and (empty DatasetPage.selectedTabFileTags)}" />

                                        <ui:repeat value="#{DatasetPage.selectedTags}" var="tags" rendered="#{!empty DatasetPage.selectedTags}">
                                            <h:outputText value="#{tags}" styleClass="label label-default" style="margin-right:.5em;display:inline-block;"/>
                                        </ui:repeat>
                                        <ui:repeat value="#{DatasetPage.selectedTabFileTags}" var="tags" rendered="#{!empty DatasetPage.selectedTabFileTags}">
                                            <h:outputText value="#{tags}" styleClass="label label-info" style="margin-right:.5em;display:inline-block;"/>
                                        </ui:repeat>
                                    </p:outputPanel>
                                </div>
                            </div>
                            <div class="form-group text-left">
                                <label for="fileTagsMenuDS" class="col-sm-4 control-label">
                                    #{bundle['file.editTagsDialog.select']}
                                </label>
                                <div class="col-sm-8">
                                    <p:selectCheckboxMenu id="fileTagsMenuDS" styleClass="form-control"
                                                          value="#{DatasetPage.selectedTags}" label="#{bundle.select}">

                                        <p:ajax event="toggleSelect" listener="#{DatasetPage.handleSelection}" update="selectedTagsList" />
                                        <p:ajax event="change" listener="#{DatasetPage.handleSelection}" update="selectedTagsList" />

                                        <f:selectItems value="#{DatasetPage.categoriesByName}"/>
                                    </p:selectCheckboxMenu>
                                    <p:message for="fileTagsMenuDS" display="text" />
                                </div>
                            </div>
                            <div class="form-group text-left">
                                <label for="fileTagAddNewDS" class="col-sm-4 control-label">
                                    #{bundle['file.editTagsDialog.add']}
                                </label>
                                <div class="col-sm-8">
                                    <div class="row form-inline">
                                        <div class="col-sm-12">
                                            <p class="help-block">#{bundle['file.editTagsDialog.add.tip']}</p>
                                            <p:inputText id="fileTagAddNewDS" styleClass="form-control"
                                                         type="text" value="#{DatasetPage.newCategoryName}"
                                                         placeholder="#{bundle['file.editTagsDialog.newName']}"
                                                         onkeypress="if (event.keyCode == 13) {
                                                                     return false;
                                                                 }" />
                                            <p:commandLink styleClass="btn btn-default" style="margin-left:.5em;" value="#{bundle.apply}" action="#{DatasetPage.saveNewCategory}" update="selectedTagsList, fileTagAddNewDS, fileTagsMenuDS"/>
                                        </div>
                                    </div>
                                    <p:message for="fileTagAddNewDS" display="text" />
                                </div>
                            </div>
                            <div class="form-group text-left" jsf:rendered="#{DatasetPage.tabularDataSelected}">
                                <label for="tabularDataTagsDSPage" class="col-sm-4 control-label">
                                    #{bundle['file.tabularDataTags']}
                                </label>
                                <div class="col-sm-8">
                                    <p class="help-block">#{bundle['file.tabularDataTags.tip']}</p>
                                    <p:selectCheckboxMenu id="tabularDataTagsDSPage" styleClass="form-control"
                                                          value="#{DatasetPage.selectedTabFileTags}" label="#{bundle.select}"
                                                          filter="false">

                                        <p:ajax event="toggleSelect" listener="#{DatasetPage.handleSelection}" update="selectedTagsList" />
                                        <p:ajax event="change" listener="#{DatasetPage.handleSelection}" update="selectedTagsList" />

                                        <f:selectItems value="#{DatasetPage.tabFileTags}" />
                                    </p:selectCheckboxMenu>
                                    <p:message for="tabularDataTagsDSPage" display="text" />
                                </div>
                            </div>
                            <div class="form-group text-left">
                                <label class="col-sm-4 control-label">
                                    #{bundle['dataset.removeUnusedFileTags.label']}
                                </label>
                                <div class="col-sm-8">
                                    <p class="help-block">#{bundle['dataset.removeUnusedFileTags.tip']}</p>
                                    <p:selectBooleanCheckbox id="removeUnused" itemLabel="#{bundle['dataset.removeUnusedFileTags.check']}" value="#{DatasetPage.removeUnusedTags}" widgetVar="removeUnused"/>
                                </div>
                            </div>
                        </div>
                        <div class="button-block">
                            <p:commandButton styleClass="btn btn-default" id="fileTagsPopupSaveButton" value="#{bundle.saveChanges}" oncomplete="PF('fileTagsPopup').hide()" update=":datasetForm:tabView:filesTable, :datasetForm" action="#{DatasetPage.saveFileTagsAndCategories()}"/>
                            <p:commandButton styleClass="btn btn-default" id="fileTagsPopupCancelButton" value="#{bundle.cancel}" onclick="PF('fileTagsPopup').hide();PF('blockDatasetForm').hide();" actionListener="#{DatasetPage.clearFileMetadataSelectedForTagsPopup()}"/>
                        </div>
                    </p:dialog>

                    <!-- Request Access Sign Up/Log In Button -->
                    <p:dialog header="#{bundle['file.requestAccess']}" widgetVar="accessSignUpLogIn_popup" modal="true">
                        <p class="help-block">
                            <span class="glyphicon glyphicon-warning-sign text-danger"/>&#160;
                            <h:outputFormat styleClass="text-danger" value="#{dataverseHeaderFragment.signupAllowed ? bundle['file.requestAccess.dialog.msg.signup'] : bundle['file.requestAccess.dialog.msg']}" escape="false">
                                <f:param value="#{navigationWrapper.redirectPage}"/>
                                <f:param value="#{widgetWrapper.widgetView ? '_blank' : '_self'}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('accessSignUpLogIn_popup').hide();
                                    PF('blockDatasetForm').hide();"/>
                        </div>
                    </p:dialog>
                    <!-- END: Request Access Sign Up/Log In Button -->

                    <p:dialog id="downloadPopup" styleClass="largePopUp" header="#{bundle['file.downloadDialog.header']}" widgetVar="downloadPopup" modal="true">
                        <o:importFunctions type="edu.harvard.iq.dataverse.util.MarkupChecker" />

                        <ui:include src="file-download-popup-fragment.xhtml">
                            <ui:param name="workingVersion" value="#{DatasetPage.workingVersion}"/>
                            <ui:param name="downloadPopupRequired" value="#{DatasetPage.downloadPopupRequired}"/>
                            <ui:param name="guestbookResponse" value="#{DatasetPage.guestbookResponse}"/>
                            <ui:param name="guestbookResponseService" value="#{DatasetPage.guestbookResponseService}"/>
                            <ui:param name="fileDownloadHelper" value="#{DatasetPage.fileDownloadHelper}"/>
                            <ui:param name="fileDownloadService" value="#{DatasetPage.fileDownloadService}"/>
                            <ui:param name="twoRavensHelper" value="#{DatasetPage.twoRavensHelper}"/>
                        </ui:include>

                    </p:dialog>

                    <p:dialog id="downloadDataSubsetPopup" styleClass="smallPopUp" header="Download Data Subset" widgetVar="downloadDataSubsetPopup"
                              rendered="#{empty DatasetPage.editMode}" modal="true">
                        <div class="form-inline clearfix" jsf:rendered="#{!(empty DatasetPage.guestbookResponse.dataFile) and DatasetPage.guestbookResponse.dataFile.tabularData}">
                            <ui:include src="/subset/gui_subset.xhtml">
                                <ui:param name="dataFile" value="#{DatasetPage.guestbookResponse.dataFile}"/>
                            </ui:include>
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['file.mapData.unpublished.header']}" widgetVar="mapData_popup" modal="true">
                        <p class="help-block">
                            <span class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.mapData.unpublished.message']}</span>
                        </p>
                        <div class="button-block">
                            <button type="button" class="btn btn-default" onclick="PF('mapData_popup').hide();PF('blockDatasetForm').hide();">
                                #{bundle.close}
                            </button>
                        </div>
                    </p:dialog>

                    <p:dialog id="linkDatasetForm" header="#{bundle['dataset.link']}" widgetVar="linkDatasetForm" modal="true">
                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() > 0}">
                            <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 1}">
                                <p class="help-block">#{bundle['dataverse.link.no.choice']}</p>
                            </ui:fragment>
                            <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() > 1}">
                                <p class="help-block">#{bundle['dataverse.link.dataset.choose']}</p>
                            </ui:fragment>
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">
                                        <h:outputFormat value="#{bundle['dataverse.link.yourDataverses']}">
                                            <f:param value="#{DatasetPage.dataversesForLinking.size()}"/>
                                        </h:outputFormat>
                                    </label>
                                    <div class="col-sm-7">
                                        <h:selectOneMenu styleClass="form-control" value="#{DatasetPage.linkingDataverseId}"
                                                         rendered="#{DatasetPage.dataversesForLinking.size() > 1}">
                                            <f:selectItems value="#{DatasetPage.linkingDVSelectItems}" />
                                        </h:selectOneMenu>
                                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 1}">
                                            <p class="form-control-static">#{DatasetPage.linkingDataverse.displayName}</p>
                                        </ui:fragment>
                                    </div>
                                </div>
                            </div>
                        </ui:fragment>
                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 0}">
                            <ui:fragment rendered="#{DatasetPage.noDVsAtAll }">
                                <p>#{bundle['dataverse.link.no.linkable']}</p>
                            </ui:fragment>
                            <ui:fragment rendered="#{ DatasetPage.noDVsRemaining }">
                                <p>#{bundle['dataverse.link.no.linkable.remaining']}</p>
                            </ui:fragment>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle['dataset.link.save']}"
                                           action="#{DatasetPage.saveLinkedDataset}"
                                           rendered="#{DatasetPage.dataversesForLinking.size() > 1}" />
                            <p:commandLink type="button" styleClass="btn btn-default" onclick="PF('linkDatasetForm').hide()"
                                           value="#{bundle['dataset.link.save']}" actionListener="#{DatasetPage.saveLinkedDataset()}"
                                           rendered="#{DatasetPage.dataversesForLinking.size() == 1}" />
                            <button type="button" class="btn btn-default" onclick="PF('linkDatasetForm').hide();PF('blockDatasetForm').hide();">
                                #{bundle.cancel}
                            </button>
                        </div>
                    </p:dialog>

                    <p:dialog id="accessPopup" header="File Restrictions" widgetVar="accessPopup" modal="true">
                        <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE' or empty DatasetPage.editMode }">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label for="metadata_TermsAccess" class="col-sm-3 control-label">
                                        <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.termsOfsAccess.title']}">
                                            #{bundle['file.dataFilesTab.terms.list.termsOfAccess.termsOfsAccess']}
                                        </span>
                                    </label>
                                    <div class="col-sm-9">
                                        <p:inputTextarea value="#{DatasetPage.workingVersion.termsOfUseAndAccess.termsOfAccess}" autoResize="false" rows="5" styleClass="form-control" widgetVar="inputtoa" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="metadata_RequestAccess" class="col-sm-3 control-label">
                                        <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess.title']}">
                                            #{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess']}
                                        </span>
                                    </label>
                                    <div class="col-sm-9">
                                        <p:selectBooleanCheckbox id="requestAccess" itemLabel="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess.enableBtn']}"
                                                                 value="#{DatasetPage.workingVersion.termsOfUseAndAccess.fileAccessRequest}" widgetVar="inputfar"/>
                                    </div>
                                </div>
                            </div>
                            <div class="button-block">
                                <ui:fragment rendered="#{DatasetPage.editMode != 'CREATE'}">
                                    <p:commandButton value="#{bundle.continue}" onclick="PF('accessPopup').hide()" update=":datasetForm,:messagePanel" action="#{DatasetPage.restrictSelectedFiles(true)}" />
                                </ui:fragment>
                                <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                                    <p:commandButton value="#{bundle.continue}" onclick="PF('accessPopup').hide()" update=":datasetForm,:messagePanel" action="#{DatasetPage.save()}" />
                                </ui:fragment>
                                <p:commandButton value="#{bundle.cancel}" onclick="PF('accessPopup').hide();PF('blockDatasetForm').hide();" type="button" />
                            </div>
                        </ui:fragment>
                    </p:dialog>

                    <p:dialog id="inreview" header="#{bundle['dataset.submitBtn']}" widgetVar="inreview" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.submitMessage']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('inreview').hide();
                                    PF('blockDatasetForm').hide();" action="#{DatasetPage.submitDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('inreview').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <!-- Publish/Submit for Review Dialogs -->
                    <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="publishConfirm" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.publish.tip']}
                        </p>
                        <div id="terms-agreement-block" class="well" jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0}">
                            <h:outputText value="#{DatasetPage.datasetPublishCustomText}" escape="false"/>
                        </div>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('publishConfirm').hide();
                                    PF('blockDatasetForm').hide();" action="#{DatasetPage.releaseDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('publishConfirm').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="publishParent" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.both']}" escape="false">
                                <o:param>
                                    <a href="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}" title="#{DatasetPage.dataset.owner.displayName}">
                                        <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                    </a>
                                </o:param>
                            </h:outputFormat>
                        </p>
                        <div id="terms-agreement-block" class="well" jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0}">
                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetPublishCustomText)}" escape="false"/>
                        </div>
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.publishBoth.tip']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['dataset.mayNotBePublished.both.button']}" onclick="PF('publishParent').hide();
                                    PF('blockDatasetForm').hide();" action="#{DatasetPage.releaseParentDVAndDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('publishParent').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="releaseDraft" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.republish.tip']}
                        </p>
                        <div id="terms-agreement-block" class="well" jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0 and DatasetPage.isDatasetPublishPopupCustomTextOnAllVersions()}">
                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetPublishCustomText)}" escape="false"/>
                        </div>
                        <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}">
                            <p class="help-block">
                                <span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.selectVersionNumber']}
                            </p>
                            <p:selectOneRadio id="options" value="#{DatasetPage.releaseRadio}">
                                <f:selectItem itemLabel="#{bundle['dataset.minorRelease']} (#{DatasetPage.datasetNextMinorVersion})" itemValue="1" />
                                <f:selectItem itemLabel="#{bundle['dataset.majorRelease']} (#{DatasetPage.datasetNextMajorVersion})" itemValue="2" />
                            </p:selectOneRadio>
                        </ui:fragment>
                        <p>
                            <h:outputFormat value="#{bundle['dataset.majorRelease.tip']}" rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}">
                                <f:param value="#{DatasetPage.datasetNextMajorVersion}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('releaseDraft').hide();PF('blockDatasetForm').hide();" rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}" action="#{DatasetPage.releaseDraft}" />
                            <p:commandButton value="#{bundle.continue}" onclick="PF('releaseDraft').hide();
                                    PF('blockDatasetForm').hide();" rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}" action="#{DatasetPage.releaseMajor}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('releaseDraft').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.mayNotBePublished']}" widgetVar="mayNotRelease" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.administrator']}" escape="false">
                                <o:param>
                                    <a href="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}" title="#{DatasetPage.dataset.owner.displayName}">
                                        <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                    </a>
                                </o:param>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('mayNotRelease').hide();
                                    PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.mayNotBePublished']}" widgetVar="maynotPublishParent" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.twoGenerations']}" escape="false">
                                <o:param>
                                    <a href="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}" title="#{DatasetPage.dataset.owner.displayName}">
                                        <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                    </a>
                                </o:param>
                                <o:param>
                                    <a href="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.owner.alias}" title="#{DatasetPage.dataset.owner.owner.displayName}">
                                        <h:outputText value="#{DatasetPage.dataset.owner.owner.displayName}"/>
                                    </a>
                                </o:param>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="PF('maynotPublishParent').hide();
                                    PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.rejectBtn']}" widgetVar="sendBackToContributor" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.rejectMessage']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="PF('sendBackToContributor').hide()" action="#{DatasetPage.sendBackToContributor}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="PF('sendBackToContributor').hide();PF('blockDatasetForm').hide();" type="button" />
                        </div>
                    </p:dialog>
                    <!-- END: Publish/Submit for Review Dialogs -->
                </h:form>
                <script type="text/javascript" src="/resources/js/dropins.js" id="dropboxjs" data-app-key="#{DatasetPage.dropBoxKey}"/>
                <script type="text/javascript">
                                function openDialog() {
                                    PF('details').show();
                                }
                                function openCompareTwo() {
                                    PF('compareTwo').show();
                                }
                                function testCheckBoxes() {
                                    var count = PF('versionsTable').getSelectedRowsCount();
                                    if (count !== 2) {
                                        PF('compareTwo').show();
                                    } else {
                                        $('button[id$="compareVersions"]').trigger('click');
                                    }
                                }
                                function testFilesSelectedForRestriction() {
                                    var count = PF('filesTable').getSelectedRowsCount();
                                    if (count === 0) {
                                        PF('selectFilesForRestrict').show();
                                    } else {
                                        PF('accessPopup').show();
                                    }

                                }

                                function testFilesSelectedForTags() {
                                    var count = PF('filesTable').getSelectedRowsCount();
                                    if (count === 0) {
                                        PF('selectFilesForEditTags').show();
                                    } else {
                                        refreshTagsCommand();
                                    }
                                }

                                function testFilesSelectedForDelete() {
                                    var count = PF('filesTable').getSelectedRowsCount();
                                    if (count === 0) {
                                        PF('selectFilesForDelete').show();
                                    } else {
                                        PF('deleteSelectedFileConfirmation').show();
                                    }
                                }
                                function testFilesSelectedForEditMetadata() {
                                    var count = PF('filesTable').getSelectedRowsCount();
                                    if (count === 0) {
                                        PF('selectFilesForEditMetadata').show();
                                    } //else {
                                    // I commented out the code below; if there's
                                    // 1 or more file selected, I don't want this
                                    // method to activate the p:remoteCommand that
                                    // issues the redirect to the edit page (or
                                    // do anything else for that matter). Doing
                                    // it this way was, for some reason, causing
                                    // this page to still try to render (??), in
                                    // some partial, half-baked state - with no
                                    // workingVersion present, etc. - that resulted
                                    // in some NULL pointers in the logs... So,
                                    // instead, the redirect will be done by the
                                    // direct action= attribute in the original
                                    // commandButton. -- L.A. 4.2.1
                                    //openEditFilesPageCommand();
                                    //}
                                }
                                function updateTemplate() {
                                    $('button[id$="updateTemplate"]').trigger('click');
                                }
                                function registerDataset() {
                                    $('button[id$="registerDataset"]').trigger('click');
                                }
                                function checkFilesSelected() {
                                    var count = PF('filesTable').getSelectedRowsCount();
                                    if (count > 0) {
                                        PF('deleteFileConfirmation').show();
                                    }
                                }
                                function checkNewlyRestricted() {
                                    if ($('input[id$="showAccessPopup"]').val() === 'true') {
                                        PF('accessPopup').show();
                                    } else {
                                        $('button[id$="datasetSave"]').trigger('click');
                                    }
                                }
                                function updateHiddenReason(textArea) {
                                    $('input[id$="hiddenReasonInput"]').val(textArea.value);
                                }
                                function testDeaccessionVersionSelection(testVersion) {
                                    var deaccessionText = $('input[id$="hiddenReasonInput"]').val();
                                    var urlEntry = $('input[id$="forwardURLForDeaccession"]').val();
                                    ;
                                    var valid = true;
                                    if (testVersion === true) {
                                        var count = PF('versionDeaccessionTable').getSelectedRowsCount();
                                    }
                                    if (validateURL(urlEntry) === false) {
                                        valid = false;
                                        PF('enterForwardUrl').show();
                                    }
                                    if (valid === true) {
                                        if ($("select[id$='reasonOptions'] option:selected").val() === '7') {
                                            if (deaccessionText === '') {
                                                valid = false;
                                                PF('enterOtherReason').show();
                                            }
                                        }
                                    }
                                    if (deaccessionText.length >= 1001) {
                                        valid = false;
                                        PF('reasonTooManyCharacters').show();
                                    }
                                    if (valid === true) {
                                        if ($("select[id$='reasonOptions'] option:selected").val() === '0') {
                                            valid = false;
                                            PF('selectDeaccessionReason').show();
                                        }
                                    }
                                    if (valid === true) {
                                        if (testVersion === false) {
                                            PF('deaccessionAllConfirmation').show();
                                        } else {
                                            if (count === 0) {
                                                PF('selectDeaccessionVersion').show();
                                            } else {
                                                PF('deaccessionConfirmation').show();
                                            }
                                        }
                                    }
                                }
                                function validateURL(textval) {
                                    if (textval === '') {
                                        return true;
                                    }
                                    var urlregex = new RegExp("^(http|https|ftp)\://([a-zA-Z0-9\.\-]+(\:[a-zA-Z0-9\.&amp;%\$\-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9\-]+\.)*[a-zA-Z0-9\-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(\:[0-9]+)*(/($|[a-zA-Z0-9\.\,\?\'\\\+&amp;%\$#\=~_\-]+))*$");
                                    return urlregex.test(textval);
                                }
                                function openDropboxChooser() {
                                    options = {
                                        // Required. Called when a user selects an item in the Chooser.
                                        success: function (files) {
                                            // Pass the JSON-ized output of the Chooser to the backing bean,
                                            // via a hidden input field:
                                            $('input[id$="dropBoxSelectionInput"]').val(JSON.stringify(files));
                                            //alert(JSON.stringify(files));
                                            // Trigger the upload processing method in the backing
                                            // bean, via an invisible commandButton:
                                            $('button[id$="dropBoxButton"]').trigger('click');
                                        },
                                        linkType: "direct",
                                        multiselect: true,
                                    };
                                    Dropbox.choose(options);
                                }


                </script>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
