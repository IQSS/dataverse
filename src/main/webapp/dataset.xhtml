<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:pt="http://java.sun.com/jsf/passthrough"
      xmlns:cc="http://java.sun.com/jsf/composite"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:iqbs="http://xmlns.jcp.org/jsf/composite/iqbs">

    <h:head>
    </h:head>

    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="#{DatasetPage.editMode == 'CREATE' ? bundle['dataset.pageTitle'] : DatasetPage.workingVersion.title} - #{DatasetPage.dataset.owner.name} #{bundle.dataverse}"/>
            <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
            <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
            <ui:param name="version" value="#{DatasetPage.workingVersion}"/>
            <ui:param name="showMessagePanel" value="#{true}"/>
            <ui:define name="body">
                <f:metadata>
                    <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                    <f:viewParam name="ownerId" value="#{DatasetPage.ownerId}"/>
                    <f:viewParam name="version" value="#{DatasetPage.version}"/>
                    <f:viewParam name="versionId" value="#{DatasetPage.versionId}"/>
                    <f:viewParam name="persistentId" value="#{DatasetPage.persistentId}"/>
                    <f:viewParam name="fileSortField" value="#{DatasetPage.fileSortField}"/>
                    <f:viewParam name="fileSortOrder" value="#{DatasetPage.fileSortOrder}"/>
                    <f:viewAction action="#{DatasetPage.init}" rendered="true"/>
                    <f:viewAction action="#{dataverseHeaderFragment.initBreadcrumbs(DatasetPage.dataset)}"/>
                    <f:viewAction action="#{EditDatafilesPage.initCreateMode(DatasetPage.editMode, DatasetPage.workingVersion, DatasetPage.newFiles, DatasetPage.selectedFiles)}"/>
                    
                </f:metadata>
                <h:form id="datasetForm">
                    <!-- Header / Button Panel -->
                    <!-- View editMode -->
                    <div id="topDatasetBlock" jsf:rendered="#{empty DatasetPage.editMode}">
                        <div id="actionButtonBlock" class="button-block clearfix">
                            <!-- Edit/Publish Button Group -->
                            <!-- Edit Button -->
                            <div class="btn-group pull-right" jsf:rendered="#{dataverseSession.user.authenticated
                                                                              and permissionsWrapper.canIssueUpdateDatasetCommand(DatasetPage.dataset)
                                                                              and !DatasetPage.dataset.latestVersion.deaccessioned}">
                                <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle #{DatasetPage.locked ? 'disabled' : ''}" data-toggle="dropdown">
                                    <span class="glyphicon glyphicon-pencil"/> #{bundle['dataset.editBtn']} <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu pull-right text-left" role="menu">
                                    <li>
                                        <h:outputLink value="/editdatafiles.xhtml?datasetId=#{DatasetPage.dataset.id}&#38;mode=UPLOAD">
                                            <h:outputText value="#{bundle['dataset.editBtn.itemLabel.upload']}"/>
                                        </h:outputLink>
                                    </li>
                                    <li>
                                        <p:commandLink id="editMetadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@form,:datasetForm,:messagePanel" oncomplete="javascript:post_edit_metadata()">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            <h:outputText value="#{bundle['dataset.editBtn.itemLabel.metadata']}" />
                                        </p:commandLink>
                                    </li>
                                    <li>
                                        <p:commandLink id="editTerms" actionListener="#{DatasetPage.edit('LICENSE')}" update="@form,:datasetForm,:messagePanel" oncomplete="javascript:post_edit_terms()">
                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                            <h:outputText value="#{bundle['dataset.editBtn.itemLabel.terms']}" />
                                        </p:commandLink>
                                    </li>                                   
                                    <ui:fragment rendered="#{permissionsWrapper.canManagePermissions(DatasetPage.dataset)}">
                                        <li class="dropdown-submenu">
                                            <a tabindex="-1" href="#">#{bundle['dataset.editBtn.itemLabel.permissions']}</a>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <h:link id="managePermissions" styleClass="ui-commandlink ui-widget" outcome="permissions-manage">
                                                        <h:outputText value="Dataset" />
                                                        <f:param name="id" value="#{DatasetPage.dataset.id}" />
                                                    </h:link>
                                                </li>
                                                <li>
                                                    <h:link id="manageFilePermissions" styleClass="ui-commandlink ui-widget" outcome="permissions-manage-files">
                                                        <h:outputText value="File" />
                                                        <f:param name="id" value="#{DatasetPage.dataset.id}" />
                                                    </h:link>
                                                </li>
                                            </ul>
                                        </li>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                        <li class="divider"></li>
                                        <li>
                                            <p:commandLink id="deleteDataset" onclick="deleteConfirmation.show()">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deleteDataset']}" />
                                            </p:commandLink>
                                        </li>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                        <li class="divider"></li>
                                        <li>
                                            <p:commandLink id="deleteVersion" onclick="deleteVersionConfirmation.show()">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deleteDraft']}" />
                                            </p:commandLink>
                                        </li>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{DatasetPage.dataset.released and !empty(DatasetPage.releasedVersionTabList) and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <li class="divider"></li>
                                        <li>
                                            <p:commandLink id="deaccessionDatasetLink" onclick="deaccessionBlock.show()">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.deaccession']}" />
                                            </p:commandLink>
                                        </li>
                                    </ui:fragment>
                                </ul>
                            </div>
                            <!-- END: Edit Button -->

                            <!-- Publish/Submit for Review/Return to Author Button Group -->
                            <div class="btn-group pull-right" role="group" jsf:rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                                                           or (DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                                                           and permissionsWrapper.canIssueUpdateDatasetCommand(DatasetPage.dataset)
                                                                                           and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset))}">
                                <!-- Publish Buttons -->
                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="publishConfirm.show()"
                                               rendered="#{!DatasetPage.dataset.released
                                                           and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                    <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                </p:commandLink>

                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="releaseDraft.show()"
                                               rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                    <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                </p:commandLink>

                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="mayNotRelease.show()"
                                               rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                           and !permissionServiceBean.on(DatasetPage.dataset.owner).has('PublishDataverse')}">
                                    <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                </p:commandLink>

                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="publishParent.show()"
                                               rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                           and permissionServiceBean.on(DatasetPage.dataset.owner).has('PublishDataverse')
                                                           and (DatasetPage.dataset.owner.owner == null or (DatasetPage.dataset.owner.owner != null and DatasetPage.dataset.owner.owner.released))
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                    <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                </p:commandLink>

                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" 
                                               rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                           and permissionServiceBean.on(DatasetPage.dataset.owner).has('PublishDataverse')
                                                           and (DatasetPage.dataset.owner.owner != null and !DatasetPage.dataset.owner.owner.released)
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}"
                                               onclick="maynotPublishParent.show()">
                                    <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                </p:commandLink>
                                <!-- END: Publish Buttons -->

                                <!-- Return to Author Button -->
                                <p:commandLink type="button" styleClass="btn btn-default #{DatasetPage.locked ? 'disabled' : ''}" onclick="sendBackToContributor.show()"
                                               rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.latestVersion.inReview
                                                           and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                               #{bundle['dataset.rejectBtn']}
                                </p:commandLink>
                                <!-- END: Return to Author Button -->

                                <!-- Submit for Review Button -->
                                <button type="button" class="btn btn-default #{DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}" onclick="inreview.show()"
                                        jsf:rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                        and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                        and permissionsWrapper.canIssueUpdateDatasetCommand(DatasetPage.dataset)
                                                        and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                    <span class="glyphicon glyphicon-globe"/> #{DatasetPage.dataset.latestVersion.inReview ? bundle['dataset.disabledSubmittedBtn'] : bundle['dataset.submitBtn']}
                                </button>
                                <!-- End: Submit for Review Button -->
                            </div>
                            <!-- END: Publish/Submit for Review/Return to Author Button Group -->
                            <!-- END: Edit/Publish Button Group -->
                            <!-- Email/Link/Share Button Group -->
                            <div class="btn-group pull-right" id="datasetButtonBar" role="group">
                                <p:commandLink class="btn btn-default bootstrap-button-tooltip" title="#{bundle['dataset.email.datasetContactBtn']}"
                                               update=":contactDialog" oncomplete="contactForm.show()" actionListener="#{sendFeedbackDialog.initUserInput}">                                     
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.userMessage}" value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.userEmail}" value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.messageSubject}" value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.recipient}" value="#{DatasetPage.dataset}"/>
                                    <span class="glyphicon glyphicon-envelope no-text"/>
                                </p:commandLink>
                                <p:commandLink styleClass="btn btn-default bootstrap-button-tooltip" rendered="#{dataverseSession.user.superuser and !DatasetPage.workingVersion.deaccessioned}"
                                               title="#{bundle['dataset.email.datasetLinkBtn.tip']}"
                                               action="#{DatasetPage.updateLinkableDataverses()}"
                                               oncomplete="PF('linkDatasetForm').show();bind_bsui_components();"
                                               update="linkDatasetForm">
                                    <span class="glyphicon glyphicon-link no-text"/>
                                </p:commandLink>
                                <p:commandLink styleClass="btn btn-default bootstrap-button-tooltip"
                                               title="#{bundle['dataset.share.datasetShare']}"
                                               oncomplete="shareDialog.show();sharrre();">
                                    <span class="glyphicon glyphicon-share no-text"/>
                                </p:commandLink>
                            </div>
                            <p:dialog id="shareDialog" header="#{bundle['dataset.share.datasetShare']}" widgetVar="shareDialog" modal="true">
                                <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.share.datasetShare.tip']}</p>

                                <div id="sharrre-widget" data-url="#{systemConfig.dataverseSiteUrl}/dataset.xhtml?persistentId=#{dataset.globalId}" data-text="#{bundle['dataset.share.datasetShare.shareText']}"></div>                                

                                <div class="button-block">
                                    <button type="button" onclick="shareDialog.hide()" class="btn btn-default" value="#{bundle.close}">
                                        #{bundle.close}
                                    </button>
                                </div>
                            </p:dialog>
                            <!-- END: Email/Link/Share Button Group -->

                            <!-- View Dataset Versions Button -->
                            <div class="btn-group pull-left" jsf:rendered="#{DatasetPage.releasedVersionTabList.size() > 1 or (DatasetPage.releasedVersionTabList.size() == 1 and DatasetPage.dataset.latestVersion.draft and permissionServiceBean.on(DatasetPage.dataset).has('ViewUnpublishedDataset'))}">
                                <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                    View Dataset Versions <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" role="menu">
                                    <ui:repeat value="#{DatasetPage.versionTabList}" var="versionLinks">
                                        <li class="#{DatasetPage.workingVersion == versionLinks ? 'disabled' : ''}">
                                            <h:outputLink styleClass="ui-commandlink ui-widget" value="/dataset.xhtml?persistentId=#{versionLinks.dataset.globalId}&#38;version=#{versionLinks.versionState}"
                                                          rendered="#{!(DatasetPage.workingVersion == versionLinks) and !(versionLinks.released or versionLinks.deaccessioned)}">
                                                <h:outputText value="#{versionLinks.versionState}" styleClass="#{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" /></h:outputLink>
                                            <h:outputText styleClass="ui-commandlink ui-widget ui-state-disabled #{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" value="#{versionLinks.versionState}"
                                                          rendered="#{(DatasetPage.workingVersion == versionLinks) and !(versionLinks.released or versionLinks.deaccessioned)}"/>
                                            <h:outputLink styleClass="ui-commandlink ui-widget" value="/dataset.xhtml?persistentId=#{versionLinks.dataset.globalId}&#38;version=#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}"
                                                          rendered="#{!(DatasetPage.workingVersion == versionLinks) and (versionLinks.released or versionLinks.deaccessioned)}">
                                                <h:outputText value="#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}" styleClass="#{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" /></h:outputLink>
                                            <h:outputText styleClass="ui-commandlink ui-widget ui-state-disabled #{DatasetPage.workingVersion == versionLinks ? 'highlightBold' : ''}" value="#{versionLinks.versionNumber}.#{versionLinks.minorVersionNumber}"
                                                          rendered="#{(DatasetPage.workingVersion == versionLinks) and !(versionLinks.draft)}"/>
                                        </li>
                                    </ui:repeat>
                                </ul>
                            </div>
                            <!-- END: Dataset Versions Button -->

                            <!-- Metrics -->
                            <div id="metrics-block" class="pull-left" jsf:rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                <div class="pull-left text-center" id="metrics-label">
                                    <span class="metrics-label-text small"><span class="glyphicon glyphicon-stats"/> #{bundle['metrics.title']}</span>
                                </div>
                                <div class="pull-left">
                                    <div id="metrics-content" class="tab-content">
                                        <div id="metrics-views" class="metrics-views tab-pane fade small text-center">
                                            #{bundle['metrics.views']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                        <div id="metrics-downloads" class="metrics-downloads tab-pane fade small text-center">
                                            <h:outputFormat value="{0} #{bundle['metrics.downloads']}">
                                                <f:param value="#{guestbookResponseServiceBean.getCountGuestbookResponsesByDatasetId(DatasetPage.dataset.id)}"/>
                                            </h:outputFormat>
                                        </div>
                                        <div id="metrics-citations" class="metrics-citations tab-pane fade small text-center">
                                            #{bundle['metrics.citations']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                        <div id="metrics-shares" class="metrics-shares tab-pane fade small text-center">
                                            #{bundle['metrics.shares']} <em>#{bundle['metrics.comingsoon']}</em>
                                        </div>
                                    </div>
                                    <div id="metrics-tabs">
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-views" class="metrics-views" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-downloads" class="metrics-downloads first" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-citations" class="metrics-citations" data-toggle="tab">&#160;</a>
                                        </div>
                                        <div class="metrics-hover pull-left">
                                            <a href="#metrics-shares" class="metrics-shares" data-toggle="tab">&#160;</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END: Metrics -->
                        </div>
                        <div id="datasetVersionBlock" class="container-fluid">
                            <div id="title-block" class="row" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.title.value}">
                                <span id="title">#{DatasetPage.datasetVersionUI.title.value}</span>
                                <h:outputText value="#{bundle['dataset.versionUI.draft']}" styleClass="label label-primary" rendered="#{DatasetPage.workingVersion.draft}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.inReview']}" styleClass="label label-success" rendered="#{DatasetPage.workingVersion.inReview}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.unpublished']}" styleClass="label label-warning" rendered="#{!DatasetPage.dataset.released}"/>
                                <h:outputText value="#{bundle['dataset.versionUI.deaccessioned']}" styleClass="label label-danger" rendered="#{DatasetPage.workingVersion.deaccessioned}"/>
                            </div>
                            <div id="citation-block" class="row" jsf:rendered="#{!empty DatasetPage.displayCitation}">
                                <div class="col-xs-12">
                                    <div class="row #{DatasetPage.workingVersion.deaccessioned ? 'bg-danger' : 'bg-citation'}">
                                        <div id="citation" class="#{DatasetPage.workingVersion.deaccessioned ? 'col-xs-12' : 'col-xs-8 col-md-9'}"
                                             onclick="if (event.target) { selectText(event.target); } else{ selectText(this); }">
                                            <h:outputText value="#{DatasetPage.displayCitation}" escape="false"/>
                                            <span class="glyphicon glyphicon-question-sign text-primary" jsf:rendered="#{!DatasetPage.dataset.released}" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="#{bundle['dataset.cite.title.released']}"/>
                                            <span class="glyphicon glyphicon-question-sign text-primary" jsf:rendered="#{DatasetPage.dataset.released and DatasetPage.workingVersion.draft}" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="#{bundle['dataset.cite.title.draft']}"/>
                                            <span class="glyphicon glyphicon-question-sign text-primary" jsf:rendered="#{DatasetPage.workingVersion.deaccessioned}" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="#{bundle['dataset.cite.title.deassessioned']}"/>
                                        </div>
                                        <div id="citation-download" class="col-sm-4 col-md-3 text-right" jsf:rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                            <div class="dropdown">
                                                <button type="button" id="downloadCitation" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                    <span class="glyphicon glyphicon-list"/> #{bundle['dataset.cite.downloadBtn']} <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu pull-right text-left" role="menu">
                                                    <li>
                                                        <a jsf:id="endNoteLink" jsf:action="#{DatasetPage.downloadDatasetCitationXML()}" >
                                                            #{bundle['dataset.cite.downloadBtn.xml']}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a jsf:id="risLink" jsf:actionListener="#{DatasetPage.downloadDatasetCitationRIS()}">
                                                            #{bundle['dataset.cite.downloadBtn.ris']}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row bg-muted" jsf:rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                        <div id="citation-standards" class="col-xs-12 text-muted small"><h:outputText value="#{bundle['dataset.cite.standards.tip']}" escape="false"/></div>
                                    </div>
                                </div>
                            </div>
                            <div id="deaccession-reason-block" class="row bg-danger" jsf:rendered="#{DatasetPage.workingVersion.deaccessioned}">
                                <h5 class="margin-top-half">#{bundle['dataset.deaccession.reason']}</h5>
                                <p>#{DatasetPage.workingVersion.versionNote}</p>
                                <ui:fragment rendered="#{!empty DatasetPage.workingVersion.archiveNote}">
                                    <p>#{bundle['dataset.beAccessedAt']} <a href="#{DatasetPage.workingVersion.archiveNote}" target="_blank">#{DatasetPage.workingVersion.archiveNote}</a></p>
                                </ui:fragment>
                            </div>
                            <div id="metadata-panel" class="row panel panel-default"
                                 jsf:rendered="#{!DatasetPage.workingVersion.deaccessioned and 
                                                 (!empty DatasetPage.datasetVersionUI.descriptionDisplay
                                                 or !empty DatasetPage.datasetVersionUI.keywordDisplay
                                                 or !empty DatasetPage.datasetVersionUI.subject.value 
                                                 or !empty DatasetPage.datasetVersionUI.relPublicationCitation
                                                 or !empty DatasetPage.datasetVersionUI.notes.value)}">
                                <div class="panel-body metadata-panel-body">
                                    <div id="description" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.descriptionDisplay}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.description.datasetFieldType.description}">#{bundle['dataset.descriptionDisplay.title']}</span>
                                        </label>
                                        <div class="col-sm-9"><h:outputText value="#{DatasetPage.datasetVersionUI.descriptionDisplay}" escape="false"/></div>
                                    </div>
                                    <div id="subject" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.subject.value}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.subject.datasetFieldType.description}">#{DatasetPage.datasetVersionUI.subject.datasetFieldType.title}</span>
                                        </label>
                                        <div class="col-sm-9">#{DatasetPage.datasetVersionUI.subject.displayValue}</div>
                                    </div>
                                    <div id="keywords" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.keywordDisplay}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.keyword.datasetFieldType.description}">#{bundle['dataset.keywordDisplay.title']}</span>
                                        </label>
                                        <div class="col-sm-9">#{DatasetPage.datasetVersionUI.keywordDisplay}</div>
                                    </div>
                                    <div id="publication" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.relPublicationCitation}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).description}">#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).title}</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <h:outputText value="#{DatasetPage.datasetVersionUI.relPublicationCitation}" escape="false"/>
                                            <a href="#{DatasetPage.datasetVersionUI.relPublicationUrl}" title="#{DatasetPage.datasetVersionUI.relPublicationUrl}" target="_blank">#{DatasetPage.datasetVersionUI.relPublicationId}</a>
                                        </div>
                                    </div>
                                    <div id="note" class="form-group" jsf:rendered="#{!empty DatasetPage.datasetVersionUI.notes.value}">
                                        <label class="col-sm-3 control-label">
                                            <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{DatasetPage.datasetVersionUI.notes.datasetFieldType.description}">#{DatasetPage.datasetVersionUI.notes.datasetFieldType.title}</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <o:importFunctions type="edu.harvard.iq.dataverse.util.MarkupChecker" />
                                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetVersionUI.notes.value)}" escape="false"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END View editMode -->

                    <!-- Create/Edit editMode -->
                    <ui:fragment rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE'}">
                        <div class="form-group">
                            <label for="select_HostDataverse" class="col-sm-2 control-label">
                                <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['dataverse.host.title']}">
                                    #{bundle.hostDataverse}
                                </span>
                            </label>
                            <div class="col-sm-10">
                                <h:outputText styleClass="highlightBold" value="#{DatasetPage.dataset.owner.name} #{bundle.dataverse}"/>
                                <h:inputHidden value="#{DatasetPage.ownerId}" id="select_HostDataverse" />
                                <ui:remove><!-- removed for beta -->
                                    <p:selectOneMenu id="select_HostDataverse" value="#{DatasetPage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                        <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"/>
                                    </p:selectOneMenu>
                                </ui:remove>
                            </div>
                        </div>
                        <div class="form-group" jsf:rendered="#{!empty DatasetPage.dataverseTemplates and DatasetPage.editMode == 'CREATE'}">
                            <label for="select_DatasetTemplate" class="col-sm-2 control-label">
                                <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['dataset.manageTemplates.tab.action.btn.view.dialog.datasetTemplate.title']}">
                                    #{bundle['dataset.manageTemplates.tab.action.btn.view.dialog.datasetTemplate']}
                                </span>
                            </label>
                            <div class="col-sm-10">
                                <p:selectOneMenu value="#{DatasetPage.selectedTemplate}" onchange="updateTemplate()"
                                                 converter="templateConverter" id="select_DatasetTemplate" styleClass="form-control"
                                                 valueChangeListener="#{DatasetPage.updateSelectedTemplate}"                                                
                                                 >
                                    <f:selectItem itemLabel="#{bundle['dataset.noTemplate.label']}" itemValue="#{null}" />
                                    <f:selectItems value="#{DatasetPage.dataverseTemplates}"
                                                   var="template" itemLabel="#{template.name}" itemValue="#{template}"/>
                                </p:selectOneMenu>
                                <p:commandButton value="Direct" id="updateTemplate"
                                                 style="display:none"
                                                 update=":datasetForm,accessPopup"
                                                 action="#{DatasetPage.handleChangeButton}">
                                </p:commandButton>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-12">
                                <span class="glyphicon glyphicon-asterisk text-danger"/> <h:outputText value="#{bundle['dataset.asterisk.tip']}"/>
                            </div>
                        </div>
                    </ui:fragment>
                    <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                        <ui:include src="metadataFragment.xhtml">
                            <ui:param name="datasetPage" value="true"/>
                            <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? DatasetPage.editMode : ''}"/>
                            <ui:param name="metadataBlocks" value="#{!empty DatasetPage.editMode ? DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray(): DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}"/>
                            <ui:param name="publicationDate" value="#{DatasetPage.dataset.publicationDateFormattedYYYYMMDD}"/>
                            <ui:param name="globalId" value="#{DatasetPage.dataset.globalId}"/>
                        </ui:include>
                    </ui:fragment>
                    <!-- END Create/Edit editMode -->

                    <!-- Edit editMode -->
                    <div class="button-block form-top" jsf:rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'LICENSE'}">
                        <p:commandButton id="saveTop" value="#{bundle.saveChanges}" onclick="checkNewlyRestricted();" />
                        <p:commandButton id="cancelTop" value="#{bundle.cancel}" action="#{DatasetPage.cancel}" process="@this" update="@form" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                    </div>
                    <!-- END Header / Button Panel -->
                    <!-- View/Tabs infoMode -->
                    <!-- Tabs -->
                    <div id="contentTabs" jsf:rendered="#{DatasetPage.editMode != 'INFO'}">
                        <ui:fragment> <!-- rendered="#{empty DatasetPage.editMode}" -->
                            <p:commandButton id="refreshButton" widgetVar="refreshButton" actionListener="#{DatasetPage.refresh}" update="@all" style="display:none"/><!-- :datasetForm:tabView:filesTable,:messagePanel -->
                            <script type="text/javascript">
                                function updateFilesTable(facesmessage) {
                                    //flash['successMsg'] = facesmessage.text; -- not working as expected - ? L.A.
                                    $('button[id$="refreshButton"]').trigger('click');
                                }
                            </script>
                            <p:socket channel="/ingest#{dataset.id}" onMessage="updateFilesTable" autoConnect="true">
                                <p:ajax event="message" update="@all" />
                            </p:socket>
                        </ui:fragment>
                        
                        <ui:fragment id="uploadFilesOnCreateTab" rendered="#{!DatasetPage.workingVersion.deaccessioned and
                                                              (DatasetPage.editMode == 'CREATE')}">
                            <ui:include src="editFilesFragment.xhtml">
                                <ui:param name="datasetPage" value="true"/>
                                <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
                                <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
                                <ui:param name="version" value="#{DatasetPage.workingVersion}"/>
                            </ui:include>

                        </ui:fragment>
                        
                        <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}" rendered="#{empty DatasetPage.editMode or (DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'LICENSE')}">
                            <p:tab id="dataFilesTab" title="#{bundle.files}" rendered="#{!DatasetPage.workingVersion.deaccessioned and
                                                              (empty DatasetPage.editMode)}">
                                <ui:include src="filesFragment.xhtml"/>
                            </p:tab>

                            <p:tab id="metadataMapTab" title="#{bundle['file.dataFilesTab.metadata.header']}"
                                   rendered="#{!DatasetPage.workingVersion.deaccessioned and (empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA')}">
                                <div class="text-right margin-bottom"
                                     jsf:rendered="#{dataverseSession.user.authenticated and empty DatasetPage.editMode
                                                     and permissionsWrapper.canIssueUpdateDatasetCommand(DatasetPage.dataset)}">
                                    <p:commandLink type="button" styleClass="btn btn-default" actionListener="#{DatasetPage.edit('METADATA')}" update="@form,:messagePanel" oncomplete="javascript:post_edit_metadata()" disabled="#{DatasetPage.locked}">
                                        <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                        <span class="glyphicon glyphicon-pencil"/> #{bundle['file.dataFilesTab.metadata.addBtn']}
                                    </p:commandLink>
                                </div>

                                <ui:include src="metadataFragment.xhtml">
                                    <ui:param name="datasetPage" value="true"/>
                                    <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? DatasetPage.editMode : ''}"/>
                                    <ui:param name="metadataBlocks" value="#{!empty DatasetPage.editMode ? DatasetPage.datasetVersionUI.metadataBlocksForEdit.entrySet().toArray(): DatasetPage.datasetVersionUI.metadataBlocksForView.entrySet().toArray()}"/>
                                    <ui:param name="publicationDate" value="#{DatasetPage.dataset.publicationDate != null ? DatasetPage.dataset.publicationDateFormattedYYYYMMDD : ''}"/>
                                    <ui:param name="globalId" value="#{DatasetPage.dataset.globalId}"/>
                                </ui:include>
                            </p:tab>

                            <p:tab id="termsTab" title="#{bundle['file.dataFilesTab.terms.header']}"
                                   rendered="#{!DatasetPage.workingVersion.deaccessioned and (empty DatasetPage.editMode or DatasetPage.editMode == 'LICENSE')}">
                                <ui:include src="dataset-license-terms.xhtml">
                                    <ui:param name="editMode" value="#{!empty DatasetPage.editMode ? 'LICENSE': ''}"/>
                                    <ui:param name="termsOfUseAndAccess" value="#{DatasetPage.workingVersion.termsOfUseAndAccess}"/>
                                    <ui:param name="datasetPage" value="true"/>
                                </ui:include>
                            </p:tab>
                            <p:tab id="versionsTab" title="#{bundle['file.dataFilesTab.versions']}" rendered="#{empty DatasetPage.editMode}">
                                <ui:include src="dataset-versions.xhtml"></ui:include>                         
                            </p:tab>
                        </p:tabView>
                    </div>
                    <!-- END View/Tabs infoMode -->

                    <!-- Create Metadata Tip -->
                    <div class="alert alert-info margin-top" jsf:rendered="#{DatasetPage.editMode == 'CREATE'}">
                        #{bundle['file.metadataTip']}
                    </div>

                    <!-- Create/Save Dataset Button Panel -->
                    <div class="button-block" jsf:rendered="#{!empty DatasetPage.editMode}">
                        <p:commandButton tabindex="1000" id="save" value="#{DatasetPage.editMode == 'CREATE' ? bundle['file.addBtn'] : bundle.saveChanges}" onclick="checkNewlyRestricted();" />
                        <p:commandButton tabindex="1000" id="cancel" value="#{bundle.cancel}" action="#{DatasetPage.cancel}" process="@this" update="@form" rendered="#{DatasetPage.editMode != 'CREATE'}" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                        <p:button id="cancelCreate" value="#{bundle.cancel}" outcome="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}" rendered="#{DatasetPage.editMode == 'CREATE'}" />
                        <p:commandButton value="Direct" id="datasetSave"
                                         style="display:none"
                                         update=":datasetForm,:messagePanel"
                                         oncomplete="javascript:bind_bsui_components();$(document).scrollTop(0);"
                                         action="#{DatasetPage.save}" />
                    </div>
                    <!-- END: Create/Save Dataset Button Panel -->

                    <!-- Popups -->
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDialog.header']}" widgetVar="deleteConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDialog.tip']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="deleteConfirmation.hide()" action="#{DatasetPage.deleteDataset()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="deleteConfirmation.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDraftDialog.header']}" widgetVar="deleteVersionConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDraftDialog.tip']}</p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="deleteVersionConfirmation.hide()" action="#{DatasetPage.deleteDatasetVersion()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="deleteVersionConfirmation.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteFileDialog.header']}" widgetVar="deleteFileConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.tip']}</p>
                        <ui:fragment rendered="#{DatasetPage.dataset.released}">
                            <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.failed.tip']}</p>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="deleteFileConfirmation.hide()" oncomplete="window.scrollTo(0, 0);"
                                             update=":#{p:component('filesTable')},:messagePanel" action="#{DatasetPage.deleteFiles()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="deleteFileConfirmation.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteFileDialog.header']}" widgetVar="deleteSelectedFileConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.multiple.immediate']}</p>
                        <ui:fragment rendered="#{DatasetPage.dataset.released}">
                            <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteFileDialog.failed.tip']}</p>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['file.delete']}" onclick="deleteSelectedFileConfirmation.hide()" 
                                             action="#{DatasetPage.deleteFilesAndSave()}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="deleteSelectedFileConfirmation.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionBlock" header="#{bundle['dataset.editBtn.itemLabel.deaccession']}" widgetVar="deaccessionBlock" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.tip']}</p>
                        <div class="form-group" jsf:rendered="#{DatasetPage.releasedVersionTabList.size() > 1}">
                            <label for="versionDeaccessionTable">#{bundle['file.deaccessionDialog.reason.question1']} <span class="glyphicon glyphicon-asterisk text-danger" title="#{bundle.requiredField}"/></label>
                            <p:dataTable id="versionDeaccessionTable" value="#{DatasetPage.releasedVersionTabList}" var="versionTab" widgetVar="versionDeaccessionTable"
                                         rowIndexVar="rowNum" selection="#{DatasetPage.selectedDeaccessionVersions}" rowKey="#{versionTab}">
                                <p:column selectionMode="multiple" class="col-select-width text-center"/>
                                <p:column>
                                    <h:outputText value="#{bundle['file.deaccessionDialog.version']} #{versionTab.versionNumber}.#{versionTab.minorVersionNumber}, #{versionTab.versionDate}" />
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div class="form-group">
                            <label for="reasonOptions">#{bundle['file.deaccessionDialog.reason.question2']} <span class="glyphicon glyphicon-asterisk text-danger" title="#{bundle.requiredField}"/></label>
                            <h:selectOneMenu id="reasonOptions" styleClass="form-control" value="#{DatasetPage.deaccessionReasonRadio}">
                                <f:selectItem itemLabel="#{bundle.select}" itemValue="0" noSelectionOption="true" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.identifiable']}" itemValue="1" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.beRetracted']}" itemValue="2" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.beTransferred']}" itemValue="3" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.IRB']}" itemValue="4" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.legalIssue']}" itemValue="5" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.notValid']}" itemValue="6" />
                                <f:selectItem itemLabel="#{bundle['file.deaccessionDialog.reason.selectItem.other']}" itemValue="7" />
                            </h:selectOneMenu>
                        </div>
                        <div class="form-group">
                            <label for="reasonForDeaccession">
                                #{bundle['file.deaccessionDialog.enterInfo']}
                            </label>
                            <p:inputTextarea id="reasonForDeaccession" styleClass="form-control" immediate="true" autoResize="false" rows="2" cols="40"
                                             onkeyup="updateHiddenReason(this);" value="#{DatasetPage.deaccessionReasonText}" widgetVar="reasonForDeaccession"/>
                            <p:message for="reasonForDeaccession"/>
                        </div>
                        <div class="form-group">
                            <label for="forwardURLForDeaccession">
                                #{bundle['file.deaccessionDialog.leaveURL']}
                            </label>
                            <p:inputText id="forwardURLForDeaccession" styleClass="form-control" value="#{DatasetPage.deaccessionForwardURLFor}" widgetVar="forwardURLForDeaccession"/>
                            <p:watermark for="forwardURLForDeaccession" value="#{bundle['file.deaccessionDialog.leaveURL.watermark']}" id="watermark" />
                        </div>
                        <div class="button-block">
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.deaccession}" rendered="#{DatasetPage.releasedVersionTabList.size() > 1}" 
                                           onclick="testDeaccessionVersionSelection(true);"/>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.deaccession}" rendered="#{DatasetPage.releasedVersionTabList.size() == 1}"
                                           onclick="testDeaccessionVersionSelection(false);"/>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.cancel}" onclick="deaccessionBlock.hide()"/>
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionConfirmation" header="Deaccession Dataset" widgetVar="deaccessionConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.deaccession.tip']}</p>
                        <div class="button-block">
                            <h:commandButton styleClass="btn btn-default" value="#{bundle.yes}" onclick="deaccessionConfirmation.hide();
                                    deaccessionBlock.hide()" action="#{DatasetPage.deaccessionVersions}" />
                            <button type="button" class="btn btn-default" value="No" onclick="deaccessionConfirmation.hide()">#{bundle.no}</button>
                        </div>
                    </p:dialog>
                    <p:dialog id="deaccessionAllConfirmation" header="#{bundle['dataset.editBtn.itemLabel.deaccession']}" widgetVar="deaccessionAllConfirmation" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deaccessionDialog.deaccessionDataset.tip']}</p>
                        <div class="button-block">
                            <h:commandButton styleClass="btn btn-default" value="Yes" onclick="deaccessionAllConfirmation.hide();
                                    deaccessionBlock.hide()" action="#{DatasetPage.deaccessionVersions}" />
                            <button type="button" class="btn btn-default" value="No" onclick="deaccessionAllConfirmation.hide()">#{bundle.no}</button>
                        </div>
                    </p:dialog>
                    <p:confirmDialog id="selectDeaccessionVersion" message="#{bundle['file.deaccessionDialog.dialog.selectVersion.tip']}" header="#{bundle['file.deaccessionDialog.dialog.selectVersion.header']}" widgetVar="selectDeaccessionVersion"> </p:confirmDialog>
                    <p:confirmDialog id="selectDeaccessionReason" message="#{bundle['file.deaccessionDialog.dialog.reason.tip']}" header="#{bundle['file.deaccessionDialog.dialog.reason.header']}" widgetVar="selectDeaccessionReason"> </p:confirmDialog>
                    <p:confirmDialog id="enterForwardUrl" message="#{bundle['file.deaccessionDialog.dialog.url.tip']}" header="#{bundle['file.deaccessionDialog.dialog.url.header']}" widgetVar="enterForwardUrl"> </p:confirmDialog>
                    <p:confirmDialog id="enterOtherReason" message="#{bundle['file.deaccessionDialog.dialog.textForReason.tip']}" header="#{bundle['file.deaccessionDialog.dialog.textForReason.header']}" widgetVar="enterOtherReason"> </p:confirmDialog>
                    <p:confirmDialog id="reasonTooManyCharacters" message="#{bundle['file.deaccessionDialog.dialog.limitChar.tip']}" header="#{bundle['file.deaccessionDialog.dialog.limitChar.header']}" widgetVar="reasonTooManyCharacters"> </p:confirmDialog>
                    <p:inputText id="hiddenReasonInput" style="display:none" widgetVar="hiddenReasonInput"/>
                    <p:dialog id="compareTwo" header="#{bundle['file.viewDiffDialog.header']}" widgetVar="compareTwo" modal="true">
                        <p class="help-block"><span class="glyphicon glyphicon-warning-sign text-danger"/> <span class="text-danger">#{bundle['file.viewDiffDialog.dialog.warning']}</span></p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="compareTwo.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <p:dialog id="detailsBlocks" styleClass="largePopUp" header="#{bundle['file.viewDiffDialog.header']}" widgetVar="detailsBlocks" modal="true">
                        <div id="title" class="margin-bottom-half">#{DatasetPage.datasetVersionDifference.newVersion.title}</div>
                        <div id="version-details-block" class=" clearfix margin-bottom-half">
                            <div class="pull-left">
                                &#160;
                            </div>
                            <div class="pull-left">
                                #{bundle['file.viewDiffDialog.version']}: #{DatasetPage.datasetVersionDifference.originalVersion.semanticVersion}<br/>
                                #{bundle['file.viewDiffDialog.lastUpdated']}: #{DatasetPage.datasetVersionDifference.originalVersion.lastUpdateTime}
                            </div>
                            <div class="pull-left">
                                #{bundle['file.viewDiffDialog.version']}: #{DatasetPage.datasetVersionDifference.newVersion.semanticVersion}<br/>
                                #{bundle['file.viewDiffDialog.lastUpdated']}: #{DatasetPage.datasetVersionDifference.newVersion.lastUpdateTime}
                            </div>
                        </div>
                        <ui:fragment rendered="#{!empty(DatasetPage.datasetVersionDifference.detailDataByBlock)}">
                            <ui:repeat value="#{DatasetPage.datasetVersionDifference.detailDataByBlock}" var="block">
                                <div class="panel panel-default">
                                    <div class="panel-heading text-info">
                                        <h:outputText value="#{block.get(0)[0].datasetFieldType.metadataBlock.displayName}" />
                                    </div>
                                    <p:dataTable id="byBlockInner" styleClass="dvnDifferanceTable" var="dsfArray" value="#{block}">
                                        <p:column styleClass="versionValue">
                                            <h:outputText value="#{dsfArray[0].datasetFieldType.title}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails">
                                            <h:outputText rendered="#{dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].displayValue}" />
                                            <h:outputText rendered="#{!dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].compoundDisplayValue}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails" >
                                            <h:outputText rendered="#{dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].displayValue}" />
                                            <h:outputText rendered="#{!dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].compoundDisplayValue}" />
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </ui:repeat>
                        </ui:fragment>
                        <div class="panel panel-default" jsf:rendered="#{!empty(DatasetPage.datasetVersionDifference.fileNote)}">
                            <div class="panel-heading text-info" rendered="#{!empty(DatasetPage.datasetVersionDifference.datasetFilesDiffList)}">
                                <h:outputText id="outputText" value="#{bundle.files}"/>
                            </div>
                            <p:dataTable id="diffFilesDataTable" styleClass="dvnDifferanceTable" value="#{DatasetPage.datasetVersionDifference.datasetFilesDiffList}" var="fileDiff">
                                <p:column styleClass="versionValue">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileID']} #{fileDiff.fileId}"/>
                                    <br></br>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.md5']} #{fileDiff.fileMD5}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{! fileDiff.file1Empty}">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileName']}: #{fileDiff.fileName1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileType']}: #{fileDiff.fileType1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileSize']}: #{fileDiff.fileSize1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.category']}: #{fileDiff.fileCat1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.description']}: #{fileDiff.fileDesc1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc1 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.restricted']}: #{fileDiff.fileRest1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileRest1 != null}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{fileDiff.file1Empty}">
                                    &#160;
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{! fileDiff.file2Empty}">
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileName']}: #{fileDiff.fileName2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileType']}: #{fileDiff.fileType2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.fileSize']}: #{fileDiff.fileSize2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.category']}: #{fileDiff.fileCat2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.description']}: #{fileDiff.fileDesc2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc2 != null}"/>
                                    <h:outputText value="#{bundle['file.viewDiffDialog.restricted']}: #{fileDiff.fileRest2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileRest2 != null}"/>
                                </p:column>
                                <p:column styleClass="versionDetails" rendered="#{fileDiff.file2Empty}">
                                    &#160;
                                </p:column>
                            </p:dataTable>
                        </div>
                        <div class="panel panel-default" jsf:rendered="#{!empty(DatasetPage.datasetVersionDifference.changedTermsAccess)}">
                            <div class="panel-heading text-info" >
                                <h:outputText id="outputTextTOU" value="#{bundle['dataset.versionDifferences.termsOfUseAccess']}"/>
                            </div>
                            <p:dataTable id="changedTermsAccessTable" styleClass="dvnDifferanceTable" var="diffArray" value="#{DatasetPage.datasetVersionDifference.changedTermsAccess}">
                                <p:column styleClass="versionValue">
                                            <h:outputText value="#{diffArray[0]}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails">
                                            <h:outputText value="#{diffArray[1]}" />
                                        </p:column>
                                        <p:column styleClass="versionDetails" >
                                            <h:outputText value="#{diffArray[2]}"/>
                                        </p:column>
                            </p:dataTable>
                        </div>
                        <div class="button-block margin-bottom">
                            <p:commandButton value="#{bundle.done}" onclick="detailsBlocks.hide()" type="button" />
                        </div>
                    </p:dialog>
                    
                    <p:dialog id="fileTagsPopup" styleClass="smallPopUp" header="#{bundle['file.editTags']}" widgetVar="fileTagsPopup" modal="true">
                        <p class="help-block"><span class="glyphicon glyphicon-info-sign"/> #{bundle['file.editTagsDialog.tip']}</p>
                        <div class="form-horizontal" jsf:rendered="#{!(empty DatasetPage.selectedFiles)}">
                            <div class="form-group">
                                <label for="fileTagsMenuDS" class="col-sm-3 control-label">
                                    #{bundle['file.editTagsDialog.select']}
                                </label>
                                <div class="col-sm-8">
                                    <p:selectCheckboxMenu id="fileTagsMenuDS" styleClass="form-control"
                                                          value="#{DatasetPage.selectedTags}" label="#{bundle.select}">
                                        <f:selectItems value="#{DatasetPage.dataset.categoriesByName}"/>
                                    </p:selectCheckboxMenu>
                                    <p:message for="fileTagsMenuDS" display="text" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fileTagAddNewDS" class="col-sm-3 control-label">
                                    #{bundle['file.editTagsDialog.add']}
                                </label>
                                <div class="col-sm-8">
                                    <p:inputText id="fileTagAddNewDS" styleClass="form-control"
                                                 type="text" value="#{DatasetPage.newCategoryName}"
                                                 placeholder="#{bundle['file.editTagsDialog.newName']}"
                                                 onkeypress="if (event.keyCode == 13) {
                                                             return false;
                                                         }" />
                                    <p:message for="fileTagAddNewDS" display="text" />
                                </div>
                            </div>

                        </div>
                        <div class="form-group" jsf:rendered="#{DatasetPage.tabularDataSelected}">
                            <label for="tabularDataTagsDsPAge" class="col-sm-3 control-label">
                                <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['file.tabularDataTags.title']}">
                        #{bundle['file.tabularDataTags']}
                                </span>
                            </label>
                            <div class="col-sm-8">
                                <p class="help-block">#{bundle['file.tabularDataTags.tip']}</p>
                                <p:selectCheckboxMenu id="tabularDataTagsDSPage" styleClass="form-control"
                                                      value="#{DatasetPage.selectedTabFileTags}" label="#{bundle.select}"
                                                      filter="false">
                                    <f:selectItems value="#{DatasetPage.tabFileTags}" />
                                </p:selectCheckboxMenu>
                                <p:message for="tabularDataTagsDSPage" display="text" />
                            </div>
                        </div>
                        <div class="button-block">
                            <p:commandButton id="fileTagsPopupSaveButton" value="#{bundle.saveChanges}" oncomplete="fileTagsPopup.hide()" update=":datasetForm:tabView:filesTable, :datasetForm" action="#{DatasetPage.saveFileTagsAndCategories()}"/>
                            <p:commandButton id="fileTagsPopupCancelButton" value="#{bundle.cancel}" onclick="fileTagsPopup.hide()" actionListener="#{DatasetPage.clearFileMetadataSelectedForTagsPopup()}"/>
                        </div>
                    </p:dialog>


                    <!-- Request Access Sign Up/Log In Button -->
                    <p:dialog header="#{bundle['file.requestAccess']}" widgetVar="accessSignUpLogIn_popup" modal="true">
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign"/>&#160;
                            <h:outputFormat value="#{dataverseHeaderFragment.signupAllowed ? bundle['file.requestAccess.dialog.msg.signup'] : bundle['file.requestAccess.dialog.msg']}" escape="false">
                                <f:param value="#{dataverseHeaderFragment.loginRedirectPage}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="accessSignUpLogIn_popup.hide()"/>
                        </div>
                    </p:dialog>
                    <!-- END: Request Access Sign Up/Log In Button -->

                    <p:dialog id="downloadPopup" styleClass="largePopUp" header="#{bundle['file.downloadDialog.header']}" widgetVar="downloadPopup" modal="true">
                        <o:importFunctions type="edu.harvard.iq.dataverse.util.MarkupChecker" />
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign"/> #{bundle['file.downloadDialog.tip']}
                        </p>
                        <p:fragment id="guestbookMessages">
                            <div class="container messagePanel">
                                <iqbs:messages collapsible="true" />
                            </div>
                        </p:fragment>

                        <div class="form-horizontal">
                            <div class="form-group" jsf:rendered="#{DatasetPage.workingVersion.termsOfUseAndAccess.license != 'CC0' and !empty DatasetPage.workingVersion.termsOfUseAndAccess.termsOfUse}">
                                <label class="col-sm-3 control-label" for="guestbook_tou">
                                    #{bundle['file.dataFilesTab.terms.list.termsOfUse.termsOfUse']}
                                </label>
                                <div class="col-sm-6">
                                    <div class="panel panel-default">
                                        <div class="panel-body read-terms">                                             
                                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.workingVersion.termsOfUseAndAccess.termsOfUse)}" escape="false" />
                                        </div>
                                    </div>   
                                </div>
                            </div>
                            <div class="form-group" jsf:rendered="#{!empty DatasetPage.workingVersion.termsOfUseAndAccess.termsOfAccess}">
                                <label class="col-sm-3 control-label" for="guestbook_toa">
                                    #{bundle['file.dataFilesTab.terms.list.termsOfAccess.termsOfsAccess']}
                                </label>
                                <div class="col-sm-6">
                                    <div class="panel panel-default">
                                        <div class="panel-body read-terms">                                             
                                            <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.workingVersion.termsOfUseAndAccess.termsOfAccess)}" escape="false" />                                           
                                        </div>  
                                    </div>
                                </div>
                            </div>
                            <ui:fragment rendered="#{DatasetPage.dataset.guestbook != null and DatasetPage.dataset.guestbook.enabled and DatasetPage.downloadPopupRequired}" id="guestbookUIFragment">
                                <p:fragment>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label" for="guestbookuser_nameText">
                                            #{bundle.name}
                                            <span class="glyphicon glyphicon-asterisk text-danger" jsf:rendered="#{DatasetPage.dataset.guestbook.nameRequired}" />
                                        </label>
                                        <div class="col-sm-6">
                                            <p:inputText id="guestbookuser_nameText" required="#{param['DO_GB_VALIDATION'] and DatasetPage.dataset.guestbook.nameRequired}" 
                                                         styleClass="form-control" value="#{DatasetPage.guestbookResponse.name}"
                                                         requiredMessage="#{bundle['requiredField']}"/>
                                            <p:message id="nameMessages" for="guestbookuser_nameText" display="text"/>
                                        </div>
                                    </div>
                                </p:fragment>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label" for="guestbookuser_email">
                                        #{bundle.email}
                                        <span class="glyphicon glyphicon-asterisk text-danger" jsf:rendered="#{DatasetPage.dataset.guestbook.emailRequired}" />
                                    </label>
                                    <div class="col-sm-6">
                                        <h:inputText id="guestbookuser_email" required="#{param['DO_GB_VALIDATION'] and DatasetPage.dataset.guestbook.emailRequired}"
                                                     styleClass="form-control" value="#{DatasetPage.guestbookResponse.email}"
                                                     requiredMessage="#{bundle['requiredField']}"/>
                                        <p:message id="emailMessages" for="guestbookuser_email" display="text"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label" for="guestbookuser_institution">
                                        #{bundle.institution}
                                        <span class="glyphicon glyphicon-asterisk text-danger" jsf:rendered="#{DatasetPage.dataset.guestbook.institutionRequired}" />
                                    </label>
                                    <div class="col-sm-6">
                                        <h:inputText id="guestbookuser_institution" required="#{param['DO_GB_VALIDATION'] and DatasetPage.dataset.guestbook.institutionRequired}"
                                                     styleClass="form-control" value="#{DatasetPage.guestbookResponse.institution}"
                                                     requiredMessage="#{bundle['requiredField']}"/>
                                        <p:message id="institutionMessages" for="guestbookuser_institution" display="text"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-3 control-label" for="guestbookuser_position">
                                        #{bundle.position}
                                        <span class="glyphicon glyphicon-asterisk text-danger" jsf:rendered="#{DatasetPage.dataset.guestbook.positionRequired}" />
                                    </label>
                                    <div class="col-sm-6">
                                        <h:inputText id="guestbookuser_position"  required="#{param['DO_GB_VALIDATION'] and DatasetPage.dataset.guestbook.positionRequired}"
                                                     styleClass="form-control" value="#{DatasetPage.guestbookResponse.position}"
                                                     requiredMessage="#{bundle['requiredField']}"/>
                                        <p:message id="positionMessages" for="guestbookuser_position" display="text"/>
                                    </div>
                                </div>
                                <div class="form-group" jsf:rendered="#{!empty DatasetPage.dataset.guestbook.customQuestions}">
                                    <label class="col-sm-3 control-label" for="guestbookuser_questions">
                                        #{bundle['dataset.guestbookResponse.guestbook.additionalQuestions']}
                                    </label>
                                    <div class="col-sm-6">
                                        <ui:repeat value="#{DatasetPage.guestbookResponse.customQuestionResponses}" var="customQuestionResponse">
                                            <div class="text-left">
                                                <label class="control-label">
                                                    <h:outputText value="#{customQuestionResponse.customQuestion.questionString}"/>
                                                    <span class="glyphicon glyphicon-asterisk text-danger" jsf:rendered="#{customQuestionResponse.customQuestion.required}" />
                                                </label>
                                                <h:inputText id="customQuestionResponse"
                                                             styleClass="form-control" value="#{customQuestionResponse.response}"
                                                             required="#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}"
                                                             rendered="#{customQuestionResponse.customQuestion.questionType=='text'}"
                                                             requiredMessage="#{bundle['requiredField']}"/>
                                                <p:message id="cqMessages" for="customQuestionResponse" display="text"/>                                                 
                                                <p:selectOneMenu id="customQuestionResponseSelect"
                                                                 styleClass="form-control" value="#{customQuestionResponse.response}"
                                                                 required="#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}"
                                                                 rendered="#{customQuestionResponse.customQuestion.questionType=='options'}"
                                                                 requiredMessage="#{bundle['requiredField']}">
                                                    <f:selectItem itemLabel="#{bundle.select}" itemValue="" noSelectionOption="true" />
                                                    <f:selectItems value="#{customQuestionResponse.responseSelectItems}" />
                                                </p:selectOneMenu>
                                            </div>
                                            <p:message id="cqSelectMessages" for="customQuestionResponseSelect" display="text"/>
                                        </ui:repeat>
                                    </div>
                                </div>
                            </ui:fragment>
                        </div>
                        <div class="button-block">
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.acceptTerms}"
                                           rendered="#{DatasetPage.downloadType=='download' or DatasetPage.downloadType==''}"
                                           actionListener="#{DatasetPage.saveGuestbookResponse('download')}"
                                           update="@([id$=Messages])" oncomplete="if (args === undefined) downloadPopup.hide();">
                                <f:param name="DO_GB_VALIDATION" value="true"/>
                            </p:commandLink>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.acceptTerms}"
                                           rendered="#{DatasetPage.downloadType=='multiple'}"
                                           actionListener="#{DatasetPage.saveGuestbookResponse('multiple')}"
                                           update="@([id$=Messages])" oncomplete="if (args === undefined) downloadPopup.hide();">
                                <f:param name="DO_GB_VALIDATION" value="true"/>
                            </p:commandLink>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.acceptTerms}"
                                           rendered="#{DatasetPage.downloadType=='subset'}"
                                           actionListener="#{DatasetPage.saveGuestbookResponse('subset')}"
                                           update="@([id$=Messages])" oncomplete="if (args === undefined)  downloadPopup.hide();  downloadDataSubsetPopup.show()">
                                <f:param name="DO_GB_VALIDATION" value="true"/>
                            </p:commandLink>
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle.acceptTerms}"
                                           rendered="#{DatasetPage.downloadType=='explore'}"
                                           actionListener="#{DatasetPage.saveGuestbookResponse('explore')}"
                                           update="@([id$=Messages]) " oncomplete="if (args === undefined) downloadPopup.hide();">
                                <f:param name="DO_GB_VALIDATION" value="true"/>
                            </p:commandLink>
                            <ui:remove>                            
                                <p:commandButton value="#{bundle.submit}" oncomplete="downloadPopup.hide()" rendered="#{DatasetPage.downloadType=='download'}"
                                                 actionListener="#{DatasetPage.saveGuestbookResponse('download')}" />
                                <p:commandButton value="#{bundle.submit}" oncomplete="downloadPopup.hide()" rendered="#{DatasetPage.downloadType=='multiple'}"
                                                 actionListener="#{DatasetPage.saveGuestbookResponse('multiple')}" />
                                <p:commandButton value="#{bundle.submit}" oncomplete="downloadPopup.hide();downloadDataSubsetPopup.show()"
                                                 update="downloadDataSubsetPopup" actionListener="#{DatasetPage.saveGuestbookResponse('subset')}" rendered="#{DatasetPage.downloadType=='subset'}" />

                                <p:commandButton value="#{bundle.submit}" oncomplete="downloadPopup.hide()" 
                                                 actionListener="#{DatasetPage.saveGuestbookResponse('explore')}" rendered="#{DatasetPage.downloadType=='explore'}" />
                            </ui:remove>
                            <p:commandButton type="button" styleClass="btn btn-default" value="#{bundle.cancel}" onclick="downloadPopup.hide()" />
                        </div>
                    </p:dialog>

                    <p:dialog id="downloadDataSubsetPopup" styleClass="smallPopUp" header="Download Data Subset" widgetVar="downloadDataSubsetPopup"
                              rendered="#{empty DatasetPage.editMode}" modal="true">
                        <div class="form-inline clearfix" jsf:rendered="#{!(empty DatasetPage.fileMetadataSelected)}">
                            <ui:include src="/subset/gui_subset.xhtml"/>
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['file.mapData.unpublished.header']}" widgetVar="mapData_popup" modal="true">
                        <p class="help-block">
                            <span class="text-danger"><span class="glyphicon glyphicon-warning-sign"/> #{bundle['file.mapData.unpublished.message']}</span>
                        </p>
                        <div class="button-block">
                            <button type="button" class="btn btn-default" onclick="mapData_popup.hide()">
                                #{bundle.close}
                            </button>
                        </div>
                    </p:dialog>

                    <p:dialog id="linkDatasetForm" header="#{bundle['dataset.link']}" widgetVar="linkDatasetForm" modal="true">
                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() > 0}">
                            <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 1}">
                                <p class="help-block">#{bundle['dataverse.link.no.choice']}</p>
                            </ui:fragment>
                            <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() > 1}">
                                <p class="help-block">#{bundle['dataverse.link.dataset.choose']}</p>
                            </ui:fragment>
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">
                                        <h:outputFormat value="#{bundle['dataverse.link.yourDataverses']}">
                                            <f:param value="#{DatasetPage.dataversesForLinking.size()}"/>
                                        </h:outputFormat>
                                    </label>
                                    <div class="col-sm-7">
                                        <h:selectOneMenu styleClass="form-control" value="#{DatasetPage.linkingDataverseId}"
                                                         rendered="#{DatasetPage.dataversesForLinking.size() > 1}">
                                            <f:selectItems value="#{DatasetPage.linkingDVSelectItems}" />
                                        </h:selectOneMenu>
                                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 1}">
                                            <p class="form-control-static">#{DatasetPage.linkingDataverse.displayName}</p>
                                        </ui:fragment>
                                    </div>
                                </div>
                            </div>
                        </ui:fragment>
                        <ui:fragment rendered="#{DatasetPage.dataversesForLinking.size() == 0}">
                            <ui:fragment rendered="#{DatasetPage.noDVsAtAll }">
                                <p>#{bundle['dataverse.link.no.linkable']}</p>
                            </ui:fragment>
                            <ui:fragment rendered="#{ DatasetPage.noDVsRemaining }">
                                <p>#{bundle['dataverse.link.no.linkable.remaining']}</p>
                            </ui:fragment>
                        </ui:fragment>
                        <div class="button-block">
                            <p:commandLink type="button" styleClass="btn btn-default" value="#{bundle['dataset.link.save']}"
                                           action="#{DatasetPage.saveLinkedDataset}"
                                           rendered="#{DatasetPage.dataversesForLinking.size() > 1}" />
                            <p:commandLink type="button" styleClass="btn btn-default" onclick="linkDatasetForm.hide()"
                                           value="#{bundle['dataset.link.save']}" actionListener="#{DatasetPage.saveLinkedDataset()}"
                                           rendered="#{DatasetPage.dataversesForLinking.size() == 1}" />
                            <button type="button" class="btn btn-default" onclick="linkDatasetForm.hide()">
                                #{bundle.cancel}
                            </button>
                        </div>
                    </p:dialog>

                   <p:dialog id="accessPopup" header="File Restrictions" widgetVar="accessPopup" modal="true">
                       <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE' or empty DatasetPage.editMode }">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label for="metadata_TermsAccess" class="col-sm-3 control-label">
                                        <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.termsOfsAccess.title']}">
                                            #{bundle['file.dataFilesTab.terms.list.termsOfAccess.termsOfsAccess']}
                                        </span>
                                    </label>
                                    <div class="col-sm-9">                                       
                                        <p:inputTextarea value="#{DatasetPage.workingVersion.termsOfUseAndAccess.termsOfAccess}" autoResize="false" rows="5" styleClass="form-control" widgetVar="inputtoa" />                                   
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="metadata_RequestAccess" class="col-sm-3 control-label">
                                        <span data-toggle="tooltip" data-placement="auto right" class="tooltiplabel text-info" data-original-title="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess.title']}">
                                            #{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess']}
                                        </span>
                                    </label>
                                    <div class="col-sm-9">  
                                        <p:selectBooleanCheckbox id="requestAccess" itemLabel="#{bundle['file.dataFilesTab.terms.list.termsOfAccess.requestAccess.enableBtn']}" 
                                                                 value="#{DatasetPage.workingVersion.termsOfUseAndAccess.fileAccessRequest}" widgetVar="inputfar"/>
                                    </div>
                                </div>
                            </div>
                            <div class="button-block">
                                <p:commandButton value="#{bundle.continue}" onclick="accessPopup.hide()" update=":datasetForm,:messagePanel" action="#{DatasetPage.restrictSelectedFiles(true)}" />
                                <p:commandButton value="#{bundle.cancel}" onclick="accessPopup.hide()" type="button" />
                            </div>
                        </ui:fragment>
                    </p:dialog>

                    <p:dialog id="inreview" header="#{bundle['dataset.submitBtn']}" widgetVar="inreview" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.submitMessage']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="inreview.hide()" action="#{DatasetPage.submitDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="inreview.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <!-- Publish/Submit for Review Dialogs -->
                    <p:dialog header="#{bundle['dataset.publish.header']}" widgetVar="publishConfirm" modal="true">
                        <ui:fragment rendered="#{DatasetPage.dataset.globalIdCreateTime == null}">
                            <p class="text-danger">
                                <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.unregistered.tip']}
                            </p>
                        </ui:fragment>
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.publish.tip']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="publishConfirm.hide()" action="#{DatasetPage.releaseDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="publishConfirm.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.publish.header']}" widgetVar="publishParent" modal="true">                                      
                        <ui:fragment rendered="#{DatasetPage.dataset.globalIdCreateTime == null}">
                            <p class="text-danger">
                                <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.unregistered.tip']}
                            </p>
                        </ui:fragment>
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.both']}" escape="false">
                                <f:param value="#{DatasetPage.dataset.owner.alias}"/>
                                <f:param value="#{DatasetPage.dataset.owner.displayName}"/>
                            </h:outputFormat>
                        </p>
                        <p class="help-block">
                            <span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.publishBoth.tip']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['dataset.mayNotBePublished.both.button']}" onclick="publishParent.hide()" action="#{DatasetPage.releaseParentDVAndDataset}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="publishParent.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.publish.header']}" widgetVar="releaseDraft" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.republish.tip']}
                        </p>
                        <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}">
                            <p class="help-block">
                                <span class="glyphicon glyphicon-info-sign"/> #{bundle['dataset.selectVersionNumber']}
                            </p>
                            <p:selectOneRadio id="options" value="#{DatasetPage.releaseRadio}">
                                <f:selectItem itemLabel="#{bundle['dataset.minorRelease']} (#{DatasetPage.datasetNextMinorVersion})" itemValue="1" />
                                <f:selectItem itemLabel="#{bundle['dataset.majorRelease']} (#{DatasetPage.datasetNextMajorVersion})" itemValue="2" />                                               
                            </p:selectOneRadio>
                        </ui:fragment>
                        <p>
                            <h:outputFormat value="#{bundle['dataset.majorRelease.tip']}" rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}">
                                <f:param value="#{DatasetPage.datasetNextMajorVersion}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="releaseDraft.hide()" rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}" action="#{DatasetPage.releaseDraft}" />
                            <p:commandButton value="#{bundle.continue}" onclick="releaseDraft.hide()" rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}" action="#{DatasetPage.releaseMajor}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="releaseDraft.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.mayNotBePublished']}" widgetVar="mayNotRelease" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.administrator']}" escape="false">
                                <f:param value="#{DatasetPage.dataset.owner.alias}"/>
                                <f:param value="#{DatasetPage.dataset.owner.displayName}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="mayNotRelease.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.mayNotBePublished']}" widgetVar="maynotPublishParent" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/>
                            <h:outputFormat value="#{bundle['dataset.mayNotPublish.twoGenerations']}" escape="false">
                                <f:param value="#{DatasetPage.dataset.owner.alias}"/>
                                <f:param value="#{DatasetPage.dataset.owner.displayName}"/>
                                <f:param value="#{DatasetPage.dataset.owner.owner.alias}"/>
                                <f:param value="#{DatasetPage.dataset.owner.owner.displayName}"/>
                            </h:outputFormat>
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.close}" onclick="maynotPublishParent.hide()" type="button" />
                        </div>
                    </p:dialog>

                    <p:dialog header="#{bundle['dataset.rejectBtn']}" widgetVar="sendBackToContributor" modal="true">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.rejectMessage']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.continue}" onclick="sendBackToContributor.hide()" action="#{DatasetPage.sendBackToContributor}" />
                            <p:commandButton value="#{bundle.cancel}" onclick="sendBackToContributor.hide()" type="button" />
                        </div>
                    </p:dialog>
                    <!-- END: Publish/Submit for Review Dialogs -->
                </h:form>
                <script type="text/javascript" src="/resources/js/dropins.js" id="dropboxjs" data-app-key="#{DatasetPage.dropBoxKey}"/>
                <script type="text/javascript">

                                function openDialog() {
                                    details.show();
                                }
                                function openCompareTwo() {
                                    compareTwo.show();
                                }
                                function testCheckBoxes() {
                                    var count = versionsTable.getSelectedRowsCount();
                                    if (count !== 2) {
                                        compareTwo.show();
                                    } else {
                                        $('button[id$="compareVersions"]').trigger('click');
                                    }
                                }

                                function updateTemplate() {
                                    $('button[id$="updateTemplate"]').trigger('click');
                                }

                                function registerDataset() {
                                    $('button[id$="registerDataset"]').trigger('click');
                                }

                                function checkFilesSelected() {
                                    var count = filesTable.getSelectedRowsCount();
                                    if (count > 0) {
                                        deleteFileConfirmation.show();
                                    }
                                }

                                function checkNewlyRestricted() {
                                    if ($('input[id$="showAccessPopup"]').val() == 'true') {
                                        accessPopup.show();
                                    }
                                    else {
                                        $('button[id$="datasetSave"]').trigger('click');
                                    }
                                }

                                function updateHiddenReason(textArea) {
                                    $('input[id$="hiddenReasonInput"]').val(textArea.value);
                                }

                                function testDeaccessionVersionSelection(testVersion) {
                                    var deaccessionText = $('input[id$="hiddenReasonInput"]').val();
                                    var urlEntry = $('input[id$="forwardURLForDeaccession"]').val();
                                    ;
                                    var valid = true;
                                    if (testVersion === true) {
                                        var count = versionDeaccessionTable.getSelectedRowsCount();
                                    }

                                    if (validateURL(urlEntry) === false) {
                                        valid = false;
                                        enterForwardUrl.show();
                                    }
                                    if (valid === true) {
                                        if ($("select[id$='reasonOptions'] option:selected").val() === '7') {
                                            if (deaccessionText === '') {
                                                valid = false;
                                                enterOtherReason.show();
                                            }
                                        }
                                    }
                                    if (deaccessionText.length >= 1001) {
                                        valid = false;
                                        reasonTooManyCharacters.show();
                                    }
                                    if (valid === true) {
                                        if ($("select[id$='reasonOptions'] option:selected").val() === '0') {
                                            valid = false;
                                            selectDeaccessionReason.show();
                                        }
                                    }
                                    if (valid === true) {
                                        if (testVersion === false) {
                                            deaccessionAllConfirmation.show();
                                        } else {
                                            if (count === 0) {
                                                selectDeaccessionVersion.show();
                                            } else {
                                                deaccessionConfirmation.show();
                                            }
                                        }
                                    }
                                }

                                function validateURL(textval) {
                                    if (textval === '') {
                                        return true;
                                    }
                                    var urlregex = new RegExp("^(http|https|ftp)\://([a-zA-Z0-9\.\-]+(\:[a-zA-Z0-9\.&amp;%\$\-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9\-]+\.)*[a-zA-Z0-9\-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(\:[0-9]+)*(/($|[a-zA-Z0-9\.\,\?\'\\\+&amp;%\$#\=~_\-]+))*$");
                                    return urlregex.test(textval);
                                }

                                function openDropboxChooser() {
                                    options = {
                                        // Required. Called when a user selects an item in the Chooser.
                                        success: function (files) {
                                            // Pass the JSON-ized output of the Chooser to the backing bean,
                                            // via a hidden input field:
                                            $('input[id$="dropBoxSelectionInput"]').val(JSON.stringify(files));
                                            //alert(JSON.stringify(files));
                                            // Trigger the upload processing method in the backing
                                            // bean, via an invisible commandButton:
                                            $('button[id$="dropBoxButton"]').trigger('click');

                                        },
                                        linkType: "direct",
                                        multiselect: true,
                                    };
                                    Dropbox.choose(options);
                                }
                </script>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
