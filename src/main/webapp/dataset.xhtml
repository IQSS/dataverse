<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <h:head>
    </h:head>

    <h:body>
        <ui:composition template="/dataverse_template.xhtml">
            <ui:param name="pageTitle" value="#{DatasetPage.editMode == 'CREATE' ? 'Add New Dataset' : DatasetPage.workingVersion.title} - #{DatasetPage.dataset.owner.name} Dataverse"/>
            <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
            <ui:param name="dataset" value="#{DatasetPage.dataset}"/>
            <ui:param name="version" value="#{DatasetPage.workingVersion}"/>
            <ui:param name="showBreadcrumbs" value="#{empty DatasetPage.editMode}"/>
            <ui:param name="showMessagePanel" value="#{true}"/>
            <ui:define name="body">
                <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="1itrou6ddxx0bsd"/>
                <script type="text/javascript">

                    function openDialog() {
                        details.show();
                    }
                    function openCompareTwo() {
                        compareTwo.show();
                    }
                    function testCheckBoxes() {
                        var count = versionsTable.getSelectedRowsCount();
                        if (count !== 2) {
                            compareTwo.show();
                        } else {
                            $('button[id$="compareVersions"]').trigger('click');
                        }
                    }

                    function updateTemplate() {
                            $('button[id$="updateTemplate"]').trigger('click');
                    }

                    function checkFilesSelected() {
                        var count = filesTable.getSelectedRowsCount();
                        if (count > 0) {
                            deleteFileConfirmation.show();
                            duplicateContentConfirmation.show();
                        } else {
                            $('button[id$="datasetSave"]').trigger('click');
                        }
                    }
                    
                    function updateHiddenReason(textArea){
                        $('input[id$="hiddenReasonInput"]').val(textArea.value);
                    }

                    function testDeaccessionVersionSelection(testVersion) {
                        var deaccessionText = $('input[id$="hiddenReasonInput"]').val();
                        var urlEntry = $('input[id$="forwardURLForDeaccession"]').val();;
                        var valid = true;
                        if (testVersion === true){
                            var count = versionDeaccessionTable.getSelectedRowsCount();
                        }

                        if (validateURL(urlEntry) === false) {
                            valid = false;
                            enterForwardUrl.show();
                        }
                        if (valid === true) {
                            if ($("select[id$='reasonOptions'] option:selected").val() === '7') {
                                if (deaccessionText === '') {
                                    valid = false;
                                    enterOtherReason.show();
                                }
                            }
                        }
                        if(deaccessionText.length >= 1001){
                            valid = false;
                            reasonTooManyCharacters.show();
                        }
                        if (valid === true) {
                            if ($("select[id$='reasonOptions'] option:selected").val() === '0') {
                                valid = false;
                                selectDeaccessionReason.show();
                            }
                        }
                        if (valid === true) {
                            if (testVersion === false) {
                                deaccessionAllConfirmation.show();
                            } else {
                                if (count === 0) {
                                    selectDeaccessionVersion.show();
                                } else {
                                    deaccessionConfirmation.show();
                                }
                            }
                        }
                    }

                    function validateURL(textval) {
                        if (textval === '') {
                            return true;
                        }
                        var urlregex = new RegExp("^(http|https|ftp)\://([a-zA-Z0-9\.\-]+(\:[a-zA-Z0-9\.&amp;%\$\-]+)*@)*((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|([a-zA-Z0-9\-]+\.)*[a-zA-Z0-9\-]+\.(com|edu|gov|int|mil|net|org|biz|arpa|info|name|pro|aero|coop|museum|[a-zA-Z]{2}))(\:[0-9]+)*(/($|[a-zA-Z0-9\.\,\?\'\\\+&amp;%\$#\=~_\-]+))*$");
                        return urlregex.test(textval);
                    }

                    function openDropboxChooser() {
                        options = {
                            // Required. Called when a user selects an item in the Chooser.
                            success: function(files) {
                                // Pass the JSON-ized output of the Chooser to the backing bean,
                                // via a hidden input field:
                                $('input[id$="dropBoxSelectionInput"]').val(JSON.stringify(files));
                                //alert(JSON.stringify(files));
                                // Trigger the upload processing method in the backing
                                // bean, via an invisible commandButton:
                                $('button[id$="dropBoxButton"]').trigger('click');

                            },
                            linkType: "direct",
                            multiselect: true,
                        };
                        Dropbox.choose(options);
                    }
                </script>

                <f:metadata>
                    <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                    <f:viewParam name="ownerId" value="#{DatasetPage.ownerId}"/>
                    <f:viewParam name="versionId" value="#{DatasetPage.versionId}"/>
                    <f:viewAction action="#{DatasetPage.init}" />
                </f:metadata>

                <h:form id="datasetForm">
                    <!-- Header / Button Panel -->
                    <ui:fragment>
                        <!-- View mode -->
                        <ui:fragment rendered="#{empty DatasetPage.editMode}">
                            <div id="topDatasetBlock">
                                <div id="actionButtonBlock" class="clearfix" style="margin-bottom:.55em;">
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode
                                                             and ((DatasetPage.workingVersion == DatasetPage.dataset.latestVersion and (DatasetPage.workingVersion.draft or DatasetPage.workingVersion.released))
                                                             or (DatasetPage.workingVersion != DatasetPage.dataset.latestVersion and DatasetPage.dataset.latestVersion.deaccessioned and  DatasetPage.workingVersion == DatasetPage.dataset.releasedVersion))
                                                             and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand')
                                                             and !DatasetPage.locked}">
                                        <div style="float:right; margin-left:1em;">
                                            <div class="btn-group">
                                                <button type="button" id="editDataSet" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                    <span class="glyphicon glyphicon-pencil" style="margin-right:.3em;"/> Edit Dataset <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu pull-right" role="menu" style="text-align:left;">
                                                    <li>
                                                        <p:commandLink id="editFiles" actionListener="#{DatasetPage.edit('FILE')}" update="@form" oncomplete="javascript:post_edit_files()">
                                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                            <h:outputText value="Files (Upload + Edit)" />
                                                        </p:commandLink>
                                                    </li>
                                                    <li>
                                                        <p:commandLink id="editMetadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@form" oncomplete="javascript:post_edit_metadata()">
                                                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                            <h:outputText value="Metadata" />
                                                        </p:commandLink>
                                                    </li>
                                                    <ui:fragment rendered="#{!DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('DeleteDatasetCommand')}">
                                                        <li class="divider"></li>
                                                        <li>
                                                            <p:commandLink id="deleteDataset" onclick="deleteConfirmation.show()">
                                                                <h:outputText value="Delete Dataset" />
                                                            </p:commandLink>
                                                        </li>
                                                    </ui:fragment>
                                                    <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('DeleteDatasetCommand')}">
                                                        <li class="divider"></li>
                                                        <li>
                                                            <p:commandLink id="deleteVersion" onclick="deleteVersionConfirmation.show()">
                                                                <h:outputText value="Delete Draft Version" />
                                                            </p:commandLink>
                                                        </li>
                                                    </ui:fragment>
                                                    <ui:fragment rendered="#{DatasetPage.dataset.released and !empty(DatasetPage.releasedVersionTabList) and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('DeleteDatasetCommand')}">
                                                        <li class="divider"></li>
                                                        <li>
                                                            <p:commandLink id="deaccessionDatasetLink" onclick="deaccessionBlock.show()">
                                                                <h:outputText value="Deaccession Dataset" />
                                                            </p:commandLink>
                                                        </li>
                                                    </ui:fragment>
                                                    <!--<li><a href="#" class="ui-commandlink ui-widget" style="pointer-events: none; color: grey;">Permissions</a></li>-->
                                                </ul>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode
                                                             and DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                             and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('PublishDatasetCommand')}">
                                        <div style="float:right; margin-left:1em;">
                                            <ui:fragment rendered="#{!DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released and !DatasetPage.locked}">
                                                <button type="button" class="btn btn-default" onclick="confirmation.show()">
                                                    <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Publish Dataset
                                                </button>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.owner.released and !DatasetPage.locked}">
                                                <button type="button" class="btn btn-default" onclick="releaseDraft.show()">
                                                    <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Publish Dataset
                                                </button>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released and !DatasetPage.locked}">
                                                <button type="button" class="btn btn-default" onclick="mayNotRelease.show()">
                                                    <span class="glyphicon glyphicon-globe" style="margin-right:.3em;"/> Publish Dataset
                                                </button>
                                            </ui:fragment>
                                        </div>
                                        <p:confirmDialog message="Are you sure you want to publish your dataset? Once you do so it must remain 'Published'." header="Publish Dataset" widgetVar="confirmation">
                                            <p:commandButton value="Continue" onclick="confirmation.hide()" action="#{DatasetPage.releaseDataset}">
                                            </p:commandButton>
                                            <p:commandButton value="Cancel" onclick="confirmation.hide()" type="button" />
                                        </p:confirmDialog>
                                        <p:confirmDialog message="Are you sure you want to republish your dataset?" header="Publish Dataset" widgetVar="releaseDraft">
                                            <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}">
                                                Select version number:
                                                <p:selectOneRadio id="options" value="#{DatasetPage.releaseRadio}">
                                                    <f:selectItem itemLabel="Major Release (#{DatasetPage.datasetNextMajorVersion})" itemValue="1" />
                                                    <f:selectItem itemLabel="Minor Release (#{DatasetPage.datasetNextMinorVersion})" itemValue="2" />
                                                </p:selectOneRadio>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}">
                                                Due to the nature of changes to the current draft this will be a major release (#{DatasetPage.datasetNextMajorVersion})
                                            </ui:fragment>
                                            <p:commandButton value="Continue" onclick="releaseDraft.hide()" action="#{DatasetPage.releaseDraft}">
                                            </p:commandButton>
                                            <p:commandButton value="Cancel" onclick="releaseDraft.hide()" type="button" />
                                        </p:confirmDialog>
                                        <p:confirmDialog message="This dataset may not be published because its host dataverse has not been published." header="May not publish" widgetVar="mayNotRelease">
                                        </p:confirmDialog>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.draft and DatasetPage.workingVersion != DatasetPage.dataset.latestVersion
                                                             and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand')}">
                                        <div style="float:right; margin-left:1em;">
                                            <h:outputLink styleClass="btn btn-warning" value="/dataset.xhtml?id=#{DatasetPage.dataset.id}&#38;versionId=#{DatasetPage.dataset.latestVersion.id}">
                                                <h:outputText value="View Unpublished Version"/>
                                            </h:outputLink>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.workingVersion != DatasetPage.dataset.releasedVersion
                                                             and !empty(DatasetPage.releasedVersionTabList)}">
                                        <div style="float:right; margin-left:1em;">
                                            <h:outputLink styleClass="btn btn-primary" value="/dataset.xhtml?id=#{DatasetPage.dataset.id}&#38;versionId=#{DatasetPage.dataset.releasedVersion.id}">
                                                <h:outputText value="View Published Version"/>
                                            </h:outputLink>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{empty DatasetPage.editMode}">
                                        <div style="float:right;">
                                            <button type="button" class="btn btn-default" onclick="contact_confirmation.show()">
                                                <span class="glyphicon glyphicon-envelope" style="margin-right:.3em;"/> Email Dataset Contact
                                            </button>
                                        </div>
                                    </ui:fragment>
                                    <p:confirmDialog message="Dataverse 4.0 Beta cannot email dataset contacts. Look for this feature in Dataverse 4.0!" header="Email Dataset Contact" widgetVar="contact_confirmation">
                                    </p:confirmDialog>
                                </div>
                                <div id="datasetVersionBlock">
                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.title.value}">
                                        <span id="title">#{DatasetPage.datasetVersionUI.title.value}</span>
                                        <h:outputText value="Draft" styleClass="label label-warning" rendered="#{DatasetPage.workingVersion.draft}"/>
                                        <h:outputText value="Unpublished" styleClass="label label-danger" rendered="#{!DatasetPage.dataset.released}"/>
                                        <h:outputText value="Deaccessioned" styleClass="label label-info" rendered="#{DatasetPage.workingVersion.deaccessioned}"/>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!empty DatasetPage.displayCitation}">
                                        <div id="citation" class="bg-info">
                                            <span>#{DatasetPage.displayCitation}</span>
                                            <ui:fragment rendered="#{!DatasetPage.dataset.released}">
                                                <span class="glyphicon glyphicon-question-sign text-primary" style="cursor:pointer; cursor:hand;" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="DRAFT VERSION will be replaced in the citation with V1 once the dataset has been published."></span>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{DatasetPage.dataset.released and DatasetPage.workingVersion.draft}">
                                                <span class="glyphicon glyphicon-question-sign text-primary" style="cursor:pointer; cursor:hand;" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="DRAFT VERSION will be replaced in the citation with the selected version once the dataset has been published."></span>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{DatasetPage.workingVersion.deaccessioned}">
                                                <span class="glyphicon glyphicon-question-sign text-primary" style="cursor:pointer; cursor:hand;" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-original-title="DEACCESSIONED VERSION has been added to the citation for this version since it is no longer available."></span>
                                            </ui:fragment>
                                            <span id="whycitelink" class="bg-warning small pull-right"><a href="/guides/Data_Citation/index.html" target="_blank">Why Cite?</a></span>
                                        </div>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{DatasetPage.workingVersion.deaccessioned}">
                                        <div class="bg-danger" style="padding:4px;margin-bottom:.5em;">
                                            <p><strong>Deaccession Reason:</strong> #{DatasetPage.workingVersion.versionNote}</p>
                                            <ui:fragment rendered="#{!empty DatasetPage.workingVersion.archiveNote}">
                                                <p>The dataset can now be accessed at: <a href="#{DatasetPage.workingVersion.archiveNote}" target="_blank">#{DatasetPage.workingVersion.archiveNote}</a></p>
                                            </ui:fragment>
                                        </div>
                                    </ui:fragment>

                                    <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.description.value and !DatasetPage.workingVersion.deaccessioned}">
                                        <span id="description">#{DatasetPage.datasetVersionUI.description.value}</span>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{!DatasetPage.workingVersion.deaccessioned and (!empty DatasetPage.datasetVersionUI.keyword.value 
                                                             or !empty DatasetPage.datasetVersionUI.subject.value or !empty DatasetPage.datasetVersionUI.relPublicationCitation 
                                                             or !empty DatasetPage.datasetVersionUI.notes.value)}">
                                        <div id="" class="panel panel-default" style="margin-top:1em;">
                                            <div class="panel-body" style="padding:12px 0;">
                                                <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.keyword.value}">
                                                    <span id="keywords" class="form-group">
                                                        <label class="col-sm-3 control-label">
                                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel" data-original-title="#{DatasetPage.datasetVersionUI.keyword.datasetFieldType.description}" title="">#{DatasetPage.datasetVersionUI.keyword.datasetFieldType.title}</a>
                                                        </label>
                                                        <span class="col-sm-8" style="padding-left:0; padding-right:0;">#{DatasetPage.datasetVersionUI.keyword.displayValue}</span>
                                                    </span>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.subject.value}">
                                                    <span id="subject" class="form-group">
                                                        <label class="col-sm-3 control-label">
                                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel" data-original-title="#{DatasetPage.datasetVersionUI.subject.datasetFieldType.description}" title="">#{DatasetPage.datasetVersionUI.subject.datasetFieldType.title}</a>
                                                        </label>
                                                        <span class="col-sm-8" style="padding-left:0; padding-right:0;">#{DatasetPage.datasetVersionUI.subject.displayValue}</span>
                                                    </span>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.relPublicationCitation}">
                                                    <span id="publication" class="form-group">
                                                        <label class="col-sm-3 control-label">
                                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel" data-original-title="#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).description}" title="">#{DatasetPage.datasetVersionUI.datasetRelPublications.get(0).title} </a>
                                                        </label>
                                                        <span class="col-sm-8" style="padding-left:0; padding-right:0;">#{DatasetPage.datasetVersionUI.relPublicationCitation}  <a href="#{DatasetPage.datasetVersionUI.relPublicationUrl}" title="#{DatasetPage.datasetVersionUI.relPublicationUrl}" target="_blank">#{DatasetPage.datasetVersionUI.relPublicationId}</a></span>
                                                    </span>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{!empty DatasetPage.datasetVersionUI.notes.value}">
                                                    <span id="note" class="form-group">
                                                        <label class="col-sm-3 control-label">
                                                            <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel" data-original-title="#{DatasetPage.datasetVersionUI.notes.datasetFieldType.description}" title="">#{DatasetPage.datasetVersionUI.notes.datasetFieldType.title}</a>
                                                        </label>
                                                        <span class="col-sm-8" style="padding-left:0; padding-right:0;">#{DatasetPage.datasetVersionUI.notes.value}</span>
                                                    </span>
                                                </ui:fragment>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                </div>
                            </div>
                        </ui:fragment>

                        <!-- Create mode -->
                        <ui:fragment rendered="#{DatasetPage.editMode == 'METADATA' or DatasetPage.editMode == 'CREATE'}">
                            <div class="form-group">
                                <label for="select_HostDataverse" class="col-sm-2 control-label">
                                    <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="The Dataverse which contains this data.">Host Dataverse</a>
                                </label>
                                <div class="col-sm-10">

                                    <h:outputText value="#{ DatasetPage.dataset.owner.name }" style="font-weight:bold;"/>
                                    <h:inputHidden value="#{DatasetPage.ownerId}" id="select_HostDataverse" />

                                    <ui:remove><!-- removed for beta -->
                                        <p:selectOneMenu id="select_HostDataverse" value="#{DatasetPage.ownerId}" filter="true" filterMatchMode="startsWith" effect="none">
                                            <f:selectItems value="#{dataverseServiceBean.findAll()}" var="dv" itemLabel="#{dv.name}" itemValue="#{dv.id}"/>
                                        </p:selectOneMenu>
                                    </ui:remove>
                                </div>
                            </div>
                        </ui:fragment>
                        <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                            <ui:fragment rendered="#{!empty DatasetPage.dataverseTemplates}">
                                <div class="form-group">
                                    <label for="select_DatasetTemplate" class="col-sm-2 control-label">
                                        <a href="#" data-toggle="tooltip" data-placement="auto right" class="tooltiplabel right" data-original-title="The dataset template which prepopulates info into the form automatically.">Dataset Template</a>
                                    </label>
                                    <div class="col-sm-10">
                                        <p:selectOneMenu value="#{DatasetPage.selectedTemplate}" onchange="updateTemplate()"
                                                         converter="templateConverter" id="select_DatasetTemplate" styleClass="form-control"
                                                         valueChangeListener="#{DatasetPage.updateSelectedTemplate}">
                                            <f:selectItem itemLabel="No template - clear default values" itemValue="#{null}" />
                                            <f:selectItems value="#{DatasetPage.dataverseTemplates}"
                                                           var="template" itemLabel="#{template.name}" itemValue="#{template}"/>
                                        </p:selectOneMenu>
                                        <p:commandButton value="Direct" id="updateTemplate"
                                                         style="display:none"
                                                         update="@all"
                                                         action="#{DatasetPage.handleChangeButton}">
                                        </p:commandButton>
                                    </div>
                                </div>
                            </ui:fragment>
                            <ui:include src="metadataFragment.xhtml"/>                      
                        </ui:fragment>
                    </ui:fragment>
                    
                    <!-- Create/Save Dataset Button Panel -->
                    <p:panel styleClass="panelLayoutButtonBlock" style="border-top: 1px solid #dddddd;" rendered="#{DatasetPage.editMode == 'METADATA'}">
                        <p:commandButton id="saveTop" value="Save Changes" onclick="checkFilesSelected();" />
                        <p:commandButton id="cancelTop" value="Cancel" action="#{DatasetPage.cancel}" process="@this" update="@form" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                    </p:panel>

                    <!-- Tabs -->
                    <ui:fragment rendered="#{DatasetPage.editMode != 'INFO'}">
                        <div id="contentTabs">
                            <ui:fragment> <!-- rendered="#{empty DatasetPage.editMode}" -->
                                <p:commandButton id="refreshButton" widgetVar="refreshButton" actionListener="#{DatasetPage.refresh}" update="@all" style="display:none"/>
                                <script type="text/javascript">
                                    function updateFilesTable(facesmessage) {
                                        $('button[id$="refreshButton"]').trigger('click');
                                    }
                                </script>
                                <p:socket channel="/ingest#{dataset.id}" onMessage="updateFilesTable" autoConnect="true">
                                    <p:ajax event="message" update="@all" />
                                </p:socket>
                            </ui:fragment>
                            <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}">
                                <p:tab id="dataFilesTab" title="Files" rendered="#{!DatasetPage.workingVersion.deaccessioned and 
                                                                                   (empty DatasetPage.editMode or DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}" >
                                    <!-- Upload -->
                                    <!--<p:message for="fileUpload" showDetail="true"/>-->
                                    <ui:fragment rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}">
                                        <!--<ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                                            <div class="alert alert-info">
                                                Tip: You can drag and drop your files from your desktop, directly into the upload widget.
                                            </div>
                                        </ui:fragment>-->
                                        <script>
                                            function uploadWidgetDropMsg() {
                                                var fileUpload = $('div[id$="fileUpload"] div.ui-fileupload-content');
                                                if ($(fileUpload).children('#dragdropMsg').length) {
                                                    // do nothing
                                                }
                                                else {
                                                    $(fileUpload).prepend('<div id="dragdropMsg">Drag and drop files here.</div>');
                                                }
                                            }
                                            function uploadWidgetDropRemoveMsg() {
                                                $('div[id$="fileUpload"] div.ui-fileupload-content div.dropMsg').remove();
                                            }
                                            $(document).ready(function() {
                                                uploadWidgetDropMsg();
                                            });
                                        </script>
                                        <p:fileUpload id="fileUpload" dragDropSupport="true" auto="true" multiple="true" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"
                                                      fileUploadListener="#{DatasetPage.handleFileUpload}" process="filesTable" update="filesTable" label="Select Files to Add"
                                                      oncomplete="javascript:bind_bsui_components();uploadWidgetDropMsg();addDeleteTooltip();" onstart="javascript:uploadWidgetDropRemoveMsg();"/>

                                        <div class="panel panel-default" style="margin-top:1em;">
                                            <div class="panel-body">
                                                <h:inputText id="dropBoxSelectionInput" style="display:none" value="#{DatasetPage.dropBoxSelection}"/>
                                                <p:commandButton id="dropBoxButton" actionListener="#{DatasetPage.handleDropBoxUpload}" update="@all" style="display:none">
                                                </p:commandButton>
                                                <p:commandButton value="Upload from Dropbox" onclick="openDropboxChooser();" icon="dropin-btn-status" />
                                                <p class="help-block">Files can also be uploaded directly from Dropbox.</p>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                    <!-- View -->
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode
                                                             and DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                             and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand')}">
                                        <div class="" style="text-align:right; margin-bottom:.5em;">
                                            <p:commandLink style="color:black;" styleClass="btn btn-default" title="Upload + Edit Files" actionListener="#{DatasetPage.edit('FILE')}" update="@form" oncomplete="javascript:post_edit_files();" disabled="#{DatasetPage.locked}">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                <span class="glyphicon #{DatasetPage.locked ? 'glyphicon-ban-circle' : 'glyphicon-plus'}" style="margin-right:.3em;"/> Upload + Edit Files
                                            </p:commandLink>
                                        </div>
                                    </ui:fragment>
                                    <!-- p:dataTable id="filesTable" value="#{empty DatasetPage.editMode ? DatasetPage.workingVersion.fileMetadatas : DatasetPage.dataset.latestVersion.fileMetadatas}" var="fileMetadata" -->
                                    <p:dataTable id="filesTable" value="#{empty DatasetPage.editMode ? DatasetPage.workingVersion.fileMetadatas : DatasetPage.dataset.latestVersion.fileMetadatas}"
                                                 rowIndexVar="rowNum"
                                                 selection="#{DatasetPage.selectedFiles}" rowKey="#{fileMetadata.dataFile.fileSystemName}" var="fileMetadata" widgetVar="filesTable">
                                        <p:column headerText="Delete?" selectionMode="multiple" rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}"
                                                  style="width:2%;text-align:center"/>
                                        <p:column styleClass="col-xs-1" style="text-align:center;">
                                            <ui:fragment rendered="#{!empty fileMetadata.dataFile.id and fileMetadata.dataFile.image}">
                                                <a class="imageThumbPreview" data-container="body" data-toggle="popover" data-placement="top" data-trigger="hover" data-html="true" data-content="&lt;img src=&#34;/api/access/datafile/#{fileMetadata.dataFile.id}?imageThumb=400&#34; alt=&#34;Preview: #{fileMetadata.label}&#34; /&gt;">
                                                    <p:graphicImage value="/api/access/datafile/#{fileMetadata.dataFile.id}?imageThumb=true"/>
                                                </a>
                                            </ui:fragment>

                                            <p:graphicImage value="/resources/images/icon_file.png" rendered="#{!fileMetadata.dataFile.image}"/>

                                            <ui:fragment rendered="#{empty fileMetadata.dataFile.id and !empty fileMetadata.dataFile.fileSystemName and fileMetadata.dataFile.image}">
                                                <p:graphicImage value="/api/access/imagethumb/#{fileMetadata.dataFile.fileSystemName}?mimetype=#{fileMetadata.dataFile.contentType}"/>
                                                <h:outputText id="imgPreview" value="Preview" styleClass="bg-info text-info" style="display:block;text-align:center;"/>
                                            </ui:fragment>
                                        </p:column>
                                        <p:column styleClass="col-sm-7">
                                            <h:outputText id="fileNameOutput" value="#{fileMetadata.label}" style="display:block;font-weight:bold;" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}"/>

                                            <ui:fragment rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}">
                                                <label class="control-label" for="fileName" style="margin-right:1em;margin-bottom:.5em;">
                                                    File Name
                                                </label>
                                                <p:inputText id="fileName" value="#{fileMetadata.label}" style="margin-bottom:.5em;"/>
                                                <p:message for="fileName"/>
                                            </ui:fragment>

                                            <h:outputText id="fileTypeOutputRegular" value="#{fileMetadata.dataFile.friendlyType}#{!empty fileMetadata.dataFile.md5 ? ', ' : ''}" rendered="#{!(fileMetadata.dataFile.tabularData)}"/>
                                           
                                            <h:outputText id="fileMD5" value="MD5: #{fileMetadata.dataFile.md5}" rendered="#{!(empty fileMetadata.dataFile.md5) and !(fileMetadata.dataFile.tabularData) and ((DatasetPage.editMode != 'FILE' and DatasetPage.editMode != 'CREATE') or !DatasetPage.isDuplicate(fileMetadata))}"/>
                                            <h:outputText id="duplicateFileMD5" style="color:red" value="MD5: #{fileMetadata.dataFile.md5} " rendered="#{!(empty fileMetadata.dataFile.md5) and ((DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and DatasetPage.isDuplicate(fileMetadata))}"/>
                                            <h:outputText id="fileDuplicateWarning" style="color:red" value=" (A file with this MD5 already exists in the dataset!)" rendered="#{DatasetPage.isDuplicate(fileMetadata) and (DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and (empty fileMetadata.id)}"/>

                                            <h:outputText id="fileTypeOutputTabular" value="Tabular Data#{!empty fileMetadata.dataFile.unf ? ', ' : ''}" rendered="#{fileMetadata.dataFile.tabularData}"/>
                                            <h:outputText id="fileUNF" value="#{fileMetadata.dataFile.unf}" rendered="#{!empty fileMetadata.dataFile.unf}"/>

                                            <ui:fragment rendered="#{ DatasetPage.hasMapLayerMetadata(fileMetadata)}">
                                                <br /><br /> <a href="#{ DatasetPage.getMapLayerMetadata(fileMetadata.dataFile).getLayerLink() }">View on WorldMap</a> 		
<br />
<iframe id="id_iframe_map" height="300" width="100%" src="#{ DatasetPage.getMapLayerMetadata(fileMetadata.dataFile).getEmbedMapLink() }"></iframe>

                                               <!--br />Metadata here: #{ DatasetPage.getMapLayerMetadata(fileMetadata.dataFile) }-->
                                            </ui:fragment>
                                            <div class="fileDescription">
                                                <h:outputText id="fileDescNonEmpty" value="#{fileMetadata.description}" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and !(empty fileMetadata.description)}"/>
                                                <!--<h:outputText id="fileDescEmpty" value="NO DESCRIPTION AVAILABLE" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE') and (empty fileMetadata.description)}"/>-->

                                                <ui:fragment rendered="#{DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE'}">
                                                    <label class="control-label" for="fileDescription" style="margin-right:1em; margin-top:.5em; vertical-align:top;">
                                                        Description
                                                    </label>
                                                    <p:inputTextarea  id="fileDescription" immediate="true" rows="2" cols="40" value="#{fileMetadata.description}" style="margin-top:.5em;"/>
                                                    <p:watermark for="fileDescription" value="Add file description..."/>
                                                    <p:message for="fileDescription"/>
                                                </ui:fragment>
                                            </div>
                                        </p:column>

                                        <p:column styleClass="col-sm-4" style="overflow: visible;text-align:right;" rendered="#{!(DatasetPage.editMode == 'FILE' or DatasetPage.editMode == 'CREATE')}">
                                            <ui:fragment rendered="#{fileMetadata.dataFile.tabularData or fileMetadata.dataFile.ingestInProgress}">
                                                <h:outputLink style="margin-right:1em;color:black;font-size:1em;" class="btn btn-default #{fileMetadata.dataFile.ingestInProgress ? 'disabled' : ''}" disabled="#{fileMetadata.dataFile.ingestInProgress ? 'disabled' : ''}" title="Explore" value="/dataexplore/gui.html?dfId=#{fileMetadata.dataFile.id}" target="_blank">
                                                    <span class="glyphicon glyphicon-stats" style="margin-right:.3em;"/> <span class="ladda-label">Explore</span>
                                                </h:outputLink>
                                            </ui:fragment>

                                            <ui:fragment rendered="#{fileMetadata.dataFile.ingestProblem}">
                                                <a href="#" class="imageThumbPreview h2" style="margin:0 .5em 0 0;vertical-align:middle;" data-toggle="popover" data-container="body" data-trigger="hover" data-placement="left" data-html="true" data-title="&lt;span class='text-danger h5'&gt;Tabular Data Ingest Failed&lt;/span&gt;" data-content="&lt;span class='text-danger'&gt;#{fileMetadata.dataFile.ingestReportMessage}&lt;/span&gt;">
                                                    <span class="glyphicon glyphicon-warning-sign text-danger" style="top:5px;"></span></a>
                                            </ui:fragment>

                                            <!--<ui:fragment rendered="#{fileMetadata.dataFile.ingestInProgress}">
                                                <p:graphicImage value="/resources/images/icon_inprogress.gif"/>
                                            </ui:fragment>-->
                                           

                                             <ui:fragment rendered="#{ !(dataverseSession.user.guest) and (DatasetPage.isShapefileType(fileMetadata)) }"> <!-- and (!(DatasetPage.hasMapLayerMetadata(fileMetadata))) }"-->                                                  
                                                 <a style="margin-right:1em;color:black;font-size:1em;" class="btn btn-default" href="#{fileMetadata.dataFile.getMapItURL(dataverseSession.user.id)}" role="button">
                                                    <span class="glyphicon glyphicon-map-marker" style="margin-right:.3em;"/> 
                                                           <h:outputText rendered="#{DatasetPage.hasMapLayerMetadata(fileMetadata)}" value="Re-Map Data" />
                                                           <h:outputText rendered="#{!(DatasetPage.hasMapLayerMetadata(fileMetadata))}" value="Map Data" />
                                                </a>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{!(fileMetadata.dataFile.tabularData)}">
                                                <a class="btn btn-default" href="/api/access/datafile/#{fileMetadata.dataFile.id}" role="button" style="color:#333333;">
                                                    <span class="glyphicon glyphicon-download-alt" style="margin-right:.3em;"/> Download
                                                </a>
                                            </ui:fragment>

                                            <ui:fragment rendered="#{fileMetadata.dataFile.tabularData}">
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                        <span class="glyphicon glyphicon-download-alt" style="margin-right:.3em;"/> Download <span class="caret"></span>
                                                    </button>
                                                    <ul class="dropdown-menu" role="menu" style="text-align:left;">
                                                        <li>
                                                            <h:outputLink value="/api/access/datafile/#{fileMetadata.dataFile.id}"  disabled="#{empty fileMetadata.dataFile.id}">
                                                                <h:outputText value="As Tab-Delimited"/>
                                                            </h:outputLink>
                                                        </li>
                                                        <li>
                                                            <h:outputLink value="/api/access/datafile/#{fileMetadata.dataFile.id}?format=RData"  disabled="#{empty fileMetadata.dataFile.id}">
                                                                <h:outputText value="As RData"/>
                                                            </h:outputLink>
                                                        </li>
                                                        <li>
                                                            <h:outputLink value="/api/access/datafile/#{fileMetadata.dataFile.id}?format=original"  disabled="#{empty fileMetadata.dataFile.id}">
                                                                <h:outputText value="Saved Original (#{fileMetadata.dataFile.originalFormatLabel})"/>
                                                            </h:outputLink>
                                                        </li>
                                                        <li>
                                                            <h:outputLink value="/api/meta/datafile/#{fileMetadata.dataFile.id}"  disabled="#{empty fileMetadata.dataFile.id}">
                                                                <h:outputText value="Variable Metadata"/>
                                                            </h:outputLink>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </ui:fragment>

                                            <ui:fragment rendered="#{fileMetadata.dataFile.ingestInProgress}">
                                                <h:outputText id="txtInprogess" value="Ingest in progress..." styleClass="bg-info text-info" style="display:block;text-align:center;"/>
                                            </ui:fragment>
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>

                                <p:tab id="metadataMapTab" title="Metadata" rendered="#{!DatasetPage.workingVersion.deaccessioned and (empty DatasetPage.editMode or DatasetPage.editMode == 'METADATA')}">
                                    <ui:fragment rendered="#{!dataverseSession.user.guest and empty DatasetPage.editMode
                                                             and DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                             and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand')}">
                                        <div class="" style="text-align:right; margin-bottom:.5em;">
                                            <p:graphicImage value="/resources/images/icon_locked.png" rendered="#{DatasetPage.locked}"/>
                                            <p:commandLink style="color:black;" styleClass="btn btn-default" title="Add + Edit Metadata" actionListener="#{DatasetPage.edit('METADATA')}" update="@form" oncomplete="javascript:post_edit_metadata()" disabled="#{DatasetPage.locked}">
                                                <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="0" />
                                                <span class="glyphicon glyphicon-pencil" style="margin-right:.3em;"/> Add + Edit Metadata
                                            </p:commandLink>
                                        </div>
                                    </ui:fragment>
                                    <div style="clear:left;">
                                        <ui:include src="metadataFragment.xhtml"/>
                                    </div>
                                </p:tab>
                                <p:tab id="versionsTab" title="Versions" rendered="#{empty DatasetPage.editMode}">
                                    <p:commandButton value="Show Differences" style="margin-bottom:.5em;"
                                                     onclick="testCheckBoxes();"
                                                     rendered="#{DatasetPage.compareVersionsCount > 2}">
                                    </p:commandButton>
                                    <p:commandButton value="Direct" id="compareVersions"
                                                     style="display:none"
                                                     update=":datasetForm"
                                                     oncomplete="detailsBlocks.show();post_differences();"
                                                     actionListener="#{DatasetPage.compareVersionDifferences()}">
                                    </p:commandButton>

                                    <p:dataTable id="versionsTable" value="#{DatasetPage.versionTabList}" var="versionTab" widgetVar="versionsTable"
                                                 rowIndexVar="rowNum" selection="#{DatasetPage.selectedVersions}" disabledSelection="#{versionTab.deaccessioned}"  rowKey="#{versionTab}">
                                        <p:column selectionMode="multiple" rendered="#{DatasetPage.compareVersionsCount > 2}"
                                                  style="width:2%;text-align:center"/>
                                        <p:column>
                                            <ui:fragment rendered="#{versionTab.released or ((versionTab.deaccessioned or versionTab.draft) and permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand'))}">
                                                <h:link id="versionLink" styleClass="ui-commandlink ui-widget" outcome="dataset">
                                                    <h:outputText rendered="#{!(versionTab.released or versionTab.deaccessioned)}" value="#{versionTab.versionState}" />
                                                    <h:outputText rendered="#{versionTab.released or versionTab.deaccessioned}" value="#{versionTab.versionNumber}.#{versionTab.minorVersionNumber}" />
                                                    <f:param name="id" value="#{versionTab.dataset.id}" />
                                                    <f:param name="versionId" value="#{versionTab.id}" />
                                                </h:link>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{versionTab.deaccessioned and  !(permissionServiceBean.on(DatasetPage.dataset).canIssueCommand('UpdateDatasetCommand'))}">
                                                <h:outputText rendered="#{!(versionTab.released or versionTab.deaccessioned)}" value="#{versionTab.versionState}" />
                                                <h:outputText rendered="#{versionTab.released or versionTab.deaccessioned}" value="#{versionTab.versionNumber}.#{versionTab.minorVersionNumber}" />
                                            </ui:fragment>
                                        </p:column>
                                        <p:column>
                                            <ui:fragment rendered="#{versionTab.defaultVersionDifference != null}">
                                                <ui:fragment rendered="#{!empty(versionTab.defaultVersionDifference.summaryDataForNote)}">
                                                    <h:outputLabel value="Citation Metadata: " />
                                                    <ui:repeat value="#{versionTab.defaultVersionDifference.summaryDataForNote}" var="summaryNote">
                                                        <h:outputText value=" #{summaryNote[0].datasetFieldType.displayName} (" />
                                                        <h:outputText rendered="#{(summaryNote[1]) > 0 and summaryNote[0].datasetFieldType.allowMultiples}"  value="#{summaryNote[1]} Added" />
                                                        <h:outputText rendered="#{(summaryNote[1]) > 0 and !(summaryNote[0].datasetFieldType.allowMultiples)}"  value="Added" />
                                                        <h:outputText rendered="#{(summaryNote[1]) > 0 and (summaryNote[2] + summaryNote[3]) > 0}"  value=", " />
                                                        <h:outputText rendered="#{(summaryNote[2]) > 0 and summaryNote[0].datasetFieldType.allowMultiples}"  value="#{summaryNote[2]} Removed" />
                                                        <h:outputText rendered="#{(summaryNote[2]) > 0 and !(summaryNote[0].datasetFieldType.allowMultiples)}"  value="Removed" />
                                                        <h:outputText rendered="#{(summaryNote[2]) > 0 and (summaryNote[3]) > 0}"  value=", " />
                                                        <h:outputText rendered="#{(summaryNote[3]) > 0 and summaryNote[0].datasetFieldType.allowMultiples}"  value="#{summaryNote[3]} Changed" />
                                                        <h:outputText rendered="#{(summaryNote[3]) > 0 and !(summaryNote[0].datasetFieldType.allowMultiples)}"  value="Changed" />
                                                        <h:outputText value="); " />
                                                    </ui:repeat>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{!empty(versionTab.defaultVersionDifference.blockDataForNote)}">
                                                    <ui:repeat value="#{versionTab.defaultVersionDifference.blockDataForNote}" var="blockNote">
                                                        <h:outputLabel rendered="#{blockNote[0].datasetFieldType.metadataBlock.displayName == 'Citation Metadata'}" value="Additional Citation Metadata: " />
                                                        <h:outputLabel rendered="#{!(blockNote[0].datasetFieldType.metadataBlock.displayName == 'Citation Metadata')}" value=" #{blockNote[0].datasetFieldType.metadataBlock.displayName}: " />
                                                        <h:outputText value=" (" />
                                                        <h:outputText rendered="#{blockNote[1] > 0}" value="#{blockNote[1]} Added" />
                                                        <h:outputText rendered="#{(blockNote[1]) > 0 and (blockNote[2] + blockNote[3]) > 0}" value=", " />
                                                        <h:outputText rendered="#{(blockNote[2]) > 0}" value="#{blockNote[2]} Removed" />
                                                        <h:outputText rendered="#{(blockNote[2]) > 0 and (blockNote[3]) > 0}" value=", " />
                                                        <h:outputText rendered="#{(blockNote[3]) > 0}" value="#{blockNote[3]} Changed" />
                                                        <h:outputText value="); " />
                                                    </ui:repeat>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{!empty(versionTab.defaultVersionDifference.fileNote)}">
                                                    <h:outputLabel value="#{versionTab.defaultVersionDifference.fileNote}" />
                                                </ui:fragment>
                                            </ui:fragment>
                                            <ui:fragment rendered="#{versionTab.defaultVersionDifference == null}">
                                                <ui:fragment rendered="#{versionTab.draft}">
                                                    This is a draft version.
                                                </ui:fragment>
                                                <ui:fragment rendered="#{versionTab.released and versionTab.priorVersionState == 'DEACCESSIONED'}">
                                                    Due to the previous version being deaccessioned, there are no difference notes for this published version.
                                                </ui:fragment>
                                                <ui:fragment rendered="#{versionTab.released and versionTab.priorVersionState == null}">
                                                    This is the first published version.
                                                </ui:fragment>
                                                <ui:fragment rendered="#{versionTab.deaccessioned}">
                                                    Deaccessioned Reason: #{versionTab.versionNote} <ui:fragment rendered="#{!empty versionTab.archiveNote}">The dataset can now be accessed at: <a href="#{versionTab.archiveNote}" target="_blank">#{versionTab.archiveNote}</a></ui:fragment>
                                                </ui:fragment>
                                            </ui:fragment>
                                            <p:commandLink rendered="#{(!empty(versionTab.defaultVersionDifference)) and DatasetPage.versionTabList.size() > (rowNum + 1)}"
                                                           actionListener="#{DatasetPage.updateVersionDifferences(versionTab, null)}"
                                                           oncomplete="detailsBlocks.show();post_differences();"
                                                           update=":datasetForm"
                                                           value="Show Details" style="margin-left:1em;"></p:commandLink>
                                        </p:column>
                                        <p:column style="min-width:140px;">
                                            <h:outputText value="#{versionTab.versionContributors}" />
                                        </p:column>
                                        <p:column>
                                            <h:outputText  id="versionDate" value="#{versionTab.versionDate}" style="white-space:nowrap;" />
                                        </p:column>
                                    </p:dataTable>
                                </p:tab>
                            </p:tabView>
                        </div>
                    </ui:fragment>
                    <p:confirmDialog id="compareTwo" message="You may only compare two versions." header="Please Select Two Versions" widgetVar="compareTwo">
                    </p:confirmDialog>
                    <p:confirmDialog message="Are you sure you want to delete your dataset? This action may not be 'Undone'." header="Delete Dataset" widgetVar="deleteConfirmation">
                        <p:commandButton value="Continue" onclick="deleteConfirmation.hide()" action="#{DatasetPage.deleteDataset()}">
                        </p:commandButton>
                        <p:commandButton value="Cancel" onclick="deleteConfirmation.hide()" type="button" />
                    </p:confirmDialog>
                    <p:confirmDialog message="Are you sure you want to delete this draft version? This action may not be 'Undone'." header="Delete Draft Version" widgetVar="deleteVersionConfirmation">
                        <p:commandButton value="Continue" onclick="deleteVersionConfirmation.hide()" action="#{DatasetPage.deleteDatasetVersion()}">
                        </p:commandButton>
                        <p:commandButton value="Cancel" onclick="deleteVersionConfirmation.hide()" type="button" />
                    </p:confirmDialog>
                    <p:confirmDialog message="Are you sure you want to delete the selected files? This action may not be 'Undone'." header="Delete Files" widgetVar="deleteFileConfirmation">
                        <ui:fragment rendered="#{DatasetPage.dataset.released}">
                            Files will not be removed from previously published versions of the dataset.
                        </ui:fragment>
                        <p:commandButton value="Continue" onclick="deleteFileConfirmation.hide()" action="#{DatasetPage.save()}">
                        </p:commandButton>
                        <p:commandButton value="Cancel" onclick="deleteFileConfirmation.hide()" type="button" />
                    </p:confirmDialog>
                    <p:confirmDialog message="Some of the files you are adding already exist in the dataset..." header="Duplicate Files" widgetVar="duplicateContentConfirmation">
                        <p:commandButton value="Continue" onclick="duplicateContentConfirmation.hide()" action="#{DatasetPage.save()}">
                        </p:commandButton>
                        <p:commandButton value="Cancel" onclick="duplicateContentConfirmation.hide()" type="button" />
                    </p:confirmDialog>
                    <p:dialog id="deaccessionBlock" header="Deaccession Dataset" widgetVar="deaccessionBlock" modal="true">
                        <p class="text-danger"><span class="glyphicon glyphicon-warning-sign"></span> Once you deaccession your dataset it will not be viewable by the public.</p>
                        <ui:fragment rendered="#{DatasetPage.releasedVersionTabList.size() > 1}">
                            <div class="form-group">
                                <label for="deaccessionOptions">Which version(s) do you want to deaccession?</label>
                                <p:dataTable id="versionDeaccessionTable" value="#{DatasetPage.releasedVersionTabList}" var="versionTab" widgetVar="versionDeaccessionTable"
                                             rowIndexVar="rowNum" selection="#{DatasetPage.selectedDeaccessionVersions}" rowKey="#{versionTab}">
                                    <p:column selectionMode="multiple" style="width:2%;text-align:center;"/>
                                    <p:column>
                                        <h:outputText value="Version #{versionTab.versionNumber}.#{versionTab.minorVersionNumber}, #{versionTab.versionDate}" />
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </ui:fragment>
                        <div class="form-group">
                            <label for="deaccessionOptions">What is the reason for deaccession?</label>
                            <h:selectOneMenu id="reasonOptions" styleClass="form-control" value="#{DatasetPage.deaccessionReasonRadio}">
                                <f:selectItem itemLabel="Select one..." itemValue="0" />
                                <f:selectItem itemLabel="There is identifiable data in one or more files" itemValue="1" />
                                <f:selectItem itemLabel="The research article has been retracted" itemValue="2" />
                                <f:selectItem itemLabel="The dataset has been transferred to another repository" itemValue="3" />
                                <f:selectItem itemLabel="IRB request" itemValue="4" />
                                <f:selectItem itemLabel="Legal issue or Data Usage Agreement" itemValue="5" />
                                <f:selectItem itemLabel="Not a valid dataset" itemValue="6" />
                                <f:selectItem itemLabel="Other (Please type reason in space provided below)" itemValue="7" />
                            </h:selectOneMenu>
                        </div>

                        <div class="form-group">
                            <label class="control-label" for="fileDescription">
                                Please enter additional information about the reason for deaccession.
                            </label>
                            <p:inputTextarea id="reasonForDeaccession" styleClass="form-control" immediate="true" rows="2" cols="40" 
                                          onkeyup="updateHiddenReason(this);"   value="#{DatasetPage.deaccessionReasonText}" widgetVar="reasonForDeaccession"/>
                            <p:message for="reasonForDeaccession"/>
                        </div>
                        <div class="form-group">
                            <label class="control-label" ><!--for="forwardURLForDeaccession"-->
                                If applicable, please leave a URL where this dataset can be accessed after deaccessioning.
                            </label>
                            <p:inputText id="forwardURLForDeaccession" styleClass="form-control" value="#{DatasetPage.deaccessionForwardURLFor}" widgetVar="forwardURLForDeaccession"/>
                            <!--<p:message for="forwardURLForDeaccession"/>-->
                        </div>
                        <ui:fragment rendered="#{DatasetPage.releasedVersionTabList.size() > 1}">
                            <button type="button" class="btn btn-success" value="Deaccession" onclick="testDeaccessionVersionSelection(true);">Deaccession</button>
                        </ui:fragment>
                        <ui:fragment rendered="#{DatasetPage.releasedVersionTabList.size() == 1}">
                            <button type="button" class="btn btn-success" value="Deaccession" onclick="testDeaccessionVersionSelection(false);">Deaccession</button>
                        </ui:fragment>
                        <button type="button" class="btn btn-default" value="Cancel" onclick="deaccessionBlock.hide()">Cancel</button>
                    </p:dialog>
                    <p:dialog id="deaccessionConfirmation" header="Deaccession Dataset" widgetVar="deaccessionConfirmation" modal="true">
                        <p>Are you sure you want to deaccession? The selected version(s) will no longer be viewable by the public.</p>
                        <h:commandButton styleClass="btn btn-success" value="Yes" onclick="deaccessionConfirmation.hide();
                                deaccessionBlock.hide()" action="#{DatasetPage.deaccessionVersions}" />
                        <button type="button" class="btn btn-default" value="No" onclick="deaccessionConfirmation.hide()">No</button>
                    </p:dialog>
                    <p:dialog id="deaccessionAllConfirmation" header="Deaccession Dataset" widgetVar="deaccessionAllConfirmation" modal="true">
                        <p>Are you sure you want to deaccession your dataset? It will no longer be viewable by the public.</p>
                        <h:commandButton styleClass="btn btn-success" value="Yes" onclick="deaccessionAllConfirmation.hide();
                                deaccessionBlock.hide()" action="#{DatasetPage.deaccessionVersions}" />
                        <button type="button" class="btn btn-default" value="No" onclick="deaccessionAllConfirmation.hide()">No</button>
                    </p:dialog>
                    <p:confirmDialog id="selectDeaccessionVersion" message="Please select version(s) for deaccessioning." header="Please Select Version(s)" widgetVar="selectDeaccessionVersion"> </p:confirmDialog>
                    <p:confirmDialog id="selectDeaccessionReason" message="Please select reason for deaccessioning." header="Please Select Reason" widgetVar="selectDeaccessionReason"> </p:confirmDialog>
                    <p:confirmDialog id="enterForwardUrl" message="Please enter valid forwarding URL." header="Invalid URL" widgetVar="enterForwardUrl"> </p:confirmDialog>
                    <p:confirmDialog id="enterOtherReason" message="Please enter text for reason for deaccessioning." header="Enter additional information" widgetVar="enterOtherReason"> </p:confirmDialog>
                    <p:confirmDialog id="reasonTooManyCharacters" message="Text for reason for deaccessioning may be no longer than 1000 characters." header="Limit 1000 characters" widgetVar="reasonTooManyCharacters"> </p:confirmDialog>
                    <p:inputText id="hiddenReasonInput" style="display:none" widgetVar="hiddenReasonInput"/>
                    <ui:fragment id="detailsBlock">
                        <p:dialog id="detailsBlocks" header="Version Differences Details" widgetVar="detailsBlocks">
                            <h:outputLabel value="Viewing: #{DatasetPage.datasetVersionDifference.newVersion.title}" />
                            <div class="clearfix" style="margin-bottom:1em;">
                                <div class="pull-right text-left" style="width:35%;padding:4px 10px;border: 1px solid #DDDDDD;border-left-width:0;">
                                    Version: #{DatasetPage.datasetVersionDifference.newVersion.semanticVersion}<br/>
                                    Last Updated: #{DatasetPage.datasetVersionDifference.newVersion.lastUpdateTime}
                                </div>
                                <div class="pull-right text-left" style="width:35%;padding:4px 10px;border: 1px solid #DDDDDD;">
                                    Version: #{DatasetPage.datasetVersionDifference.originalVersion.semanticVersion}<br/>
                                    Last Updated: #{DatasetPage.datasetVersionDifference.originalVersion.lastUpdateTime}
                                </div>
                                <div class="pull-right text-left" style="width:30%;padding:4px 10px;">
                                    &#160;
                                </div>
                            </div>
                            <ui:fragment rendered="#{!empty(DatasetPage.datasetVersionDifference.detailDataByBlock)}">
                                <ui:repeat value="#{DatasetPage.datasetVersionDifference.detailDataByBlock}" var="block">
                                    <div class="panel panel-default">
                                        <div class="panel-heading text-info">
                                            <h:outputText value="#{block.get(0)[0].datasetFieldType.metadataBlock.displayName}" />
                                        </div>
                                        <p:dataTable id="byBlockInner" styleClass="dvnDifferanceTable" var="dsfArray" value="#{block}">
                                            <p:column styleClass="versionValue">
                                                <h:outputText value="#{dsfArray[0].datasetFieldType.title}" />
                                            </p:column>
                                            <p:column styleClass="versionDetails">
                                                <h:outputText rendered="#{dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].displayValue}" />
                                                <h:outputText rendered="#{!dsfArray[0].datasetFieldType.primitive and !(dsfArray[0].isEmpty())}" value="#{dsfArray[0].compoundDisplayValue}" />
                                            </p:column>
                                            <p:column styleClass="versionDetails" >
                                                <h:outputText rendered="#{dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].displayValue}" />
                                                <h:outputText rendered="#{!dsfArray[1].datasetFieldType.primitive and !(dsfArray[1].isEmpty())}" value="#{dsfArray[1].compoundDisplayValue}" />
                                            </p:column>
                                        </p:dataTable>
                                    </div>
                                </ui:repeat>
                            </ui:fragment>
                            <ui:fragment rendered="#{!empty(DatasetPage.datasetVersionDifference.fileNote)}">
                                <div class="panel panel-default">
                                    <div class="panel-heading text-info" rendered="#{!empty(DatasetPage.datasetVersionDifference.datasetFilesDiffList)}">
                                        <h:outputText id="outputText" value="Files"/>
                                    </div>
                                    <p:dataTable id="diffFilesDataTable" styleClass="dvnDifferanceTable" value="#{DatasetPage.datasetVersionDifference.datasetFilesDiffList}" var="fileDiff">
                                        <p:column styleClass="versionValue">
                                            <h:outputText value="File ID: #{fileDiff.fileId}"/>
                                        </p:column>
                                        <p:column styleClass="versionDetails" rendered="#{! fileDiff.file1Empty}">
                                            <h:outputText value="File Name: #{fileDiff.fileName1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName1 != null}"/>
                                            <h:outputText value="File Type: #{fileDiff.fileType1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType1 != null}"/>
                                            <h:outputText value="File Size: #{fileDiff.fileSize1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize1 != null}"/>
                                            <h:outputText value="Category: #{fileDiff.fileCat1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat1 != null}"/>
                                            <h:outputText value="Description: #{fileDiff.fileDesc1}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc1 != null}"/>
                                        </p:column>
                                        <p:column styleClass="versionDetails" rendered="#{fileDiff.file1Empty}">
                                            &#160;
                                        </p:column>
                                        <p:column styleClass="versionDetails" rendered="#{! fileDiff.file2Empty}">
                                            <h:outputText value="File Name: #{fileDiff.fileName2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileName2 != null}"/>
                                            <h:outputText value="File Type: #{fileDiff.fileType2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileType2 != null}"/>
                                            <h:outputText value="File Size: #{fileDiff.fileSize2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileSize2 != null}"/>
                                            <h:outputText value="Category: #{fileDiff.fileCat2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileCat2 != null}"/>
                                            <h:outputText value="Description: #{fileDiff.fileDesc2}" styleClass="diffDetailBlock" rendered="#{fileDiff.fileDesc2 != null}"/>
                                        </p:column>
                                        <p:column styleClass="versionDetails" rendered="#{fileDiff.file2Empty}">
                                            &#160;
                                        </p:column>
                                    </p:dataTable>
                                </div>
                            </ui:fragment>
                        </p:dialog>
                    </ui:fragment>
                    <ui:fragment rendered="#{DatasetPage.editMode == 'CREATE'}">
                        <div class="alert alert-info" style="margin-top:.5em;">
                            Metadata Tip: After adding the dataset, click the Edit Dataset button to add more metadata..
                        </div>
                    </ui:fragment>

                    <!-- Create/Save Dataset Button Panel -->
                    <p:panel styleClass="panelLayoutButtonBlock" rendered="#{!empty DatasetPage.editMode}">
                        <p:commandButton id="save"  value="#{DatasetPage.editMode == 'CREATE' ? 'Add Dataset' : 'Save Changes'}" onclick="checkFilesSelected();" >
                        </p:commandButton>
                        <p:commandButton id="cancel" value="Cancel" action="#{DatasetPage.cancel}" process="@this" update="@form"  rendered="#{DatasetPage.editMode != 'CREATE'}" oncomplete="javascript:post_cancel_edit_files_or_metadata()">
                            <f:setPropertyActionListener target="#{DatasetPage.selectedTabIndex}" value="#{DatasetPage.editMode == 'METADATA' ? 1 : DatasetPage.selectedTabIndex}"/>
                        </p:commandButton>
                        <p:button id="cancelCreate" value="Cancel" outcome="/dataverse.xhtml?id=#{DatasetPage.ownerId}"  rendered="#{DatasetPage.editMode == 'CREATE'}" />
                    </p:panel>
                    <p:commandButton value="Direct" id="datasetSave"
                                     style="display:none"
                                     update=":datasetForm"
                                     action="#{DatasetPage.save}">
                    </p:commandButton>
                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>
