<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:dv="http://dataverse.org/facelets" xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:iqbs="http://xmlns.jcp.org/jsf/composite/iqbs"
>

<!--@elvariable id="dataset" type="edu.harvard.iq.dataverse.persistence.dataset.Dataset"-->
<!--@elvariable id="privateUrlLink" type="java.lang.String"-->
<!--@elvariable id="dataverseLk" type="edu.harvard.iq.dataverse.persistence.dataverse.Dataverse"-->
<!--@elvariable id="DatasetPage" type="edu.harvard.iq.dataverse.DatasetPage"-->

<h:head>
</h:head>
<h:body>
    <ui:composition template="/dataverse_template.xhtml">
        <ui:param name="pageTitle"
                  value="#{DatasetPage.workingVersion.title} - #{DatasetPage.dataset.owner.name}"/>
        <ui:param name="dataverse" value="#{DatasetPage.dataset.owner}"/>
        <ui:param name="showMessagePanel" value="#{true}"/>
        <ui:define name="dc_meta_header">
            <meta name="DC.identifier" content="#{DatasetPage.persistentId}"/>
            <meta name="DC.type" content="Dataset"/>
            <meta name="DC.title" content="#{DatasetPage.title}"/>
            <meta name="DC.date" content="#{DatasetPage.workingVersion.publicationDateAsString}"/>
            <meta name="DC.publisher" content="#{DatasetPage.publisher}"/>
            <meta name="DC.description" content="#{DatasetPage.description}"/>
            <ui:repeat var="author" value="#{DatasetPage.datasetAuthors}">
                <meta name="DC.creator" content="#{author}"/>
            </ui:repeat>
            <ui:repeat var="subject" value="#{DatasetPage.workingVersion.datasetSubjects}">
                <meta name="DC.subject" content="#{subject}"/>
            </ui:repeat>
        </ui:define>
        <ui:define name="jsonld_header">
            <script type="application/ld+json">
                <h:outputText value="#{DatasetPage.jsonLd}"/>
            </script>
        </ui:define>
        <ui:define name="og_header">
            <meta property="og:title" content="#{DatasetPage.title}"/>
            <meta property="og:type" content="article"/>
            <meta property="og:url"
                  content="#{systemConfig.dataverseSiteUrl}/dataset.xhtml?persistentId=#{dataset.globalId}"/>
            <meta property="og:image"
                  content="#{systemConfig.dataverseSiteUrl.concat(resource['images/favicondataverse.png'])}"/>
            <meta property="og:site_name" content="#{DatasetPage.publisher}"/>
            <meta property="og:description"
                  content="#{(DatasetPage.description.length()>150 ? DatasetPage.description.substring(0,147).concat('...'): DatasetPage.description)}"/>
            <ui:repeat var="author" value="#{DatasetPage.datasetAuthors}">
                <meta property="article:author" content="#{author}"/>
            </ui:repeat>
            <meta property="article:published_time" content="#{DatasetPage.workingVersion.publicationDateAsString}"/>
        </ui:define>
        <ui:define name="body">
            <o:importFunctions type="edu.harvard.iq.dataverse.common.MarkupChecker"/>
            <f:metadata>
                <o:importConstants
                        type="edu.harvard.iq.dataverse.persistence.datafile.license.FileTermsOfUse.RestrictType"
                        var="restrictTypeEnum"/>
                <o:importConstants
                        type="edu.harvard.iq.dataverse.persistence.datafile.license.FileTermsOfUse.TermsOfUseType"
                        var="termsOfUseTypeEnum"/>
                <f:viewParam name="id" value="#{DatasetPage.dataset.id}"/>
                <f:viewParam name="version" value="#{DatasetPage.version}"/>
                <f:viewParam name="versionId" value="#{DatasetPage.versionId}"/>
                <f:viewParam name="persistentId" value="#{DatasetPage.persistentId}"/>
                <f:viewAction action="#{dataverseSession.updateLocaleInViewRoot}"/>
                <f:viewAction action="#{DatasetPage.init}"/>
                <f:viewAction action="#{datasetFilesTab.init(DatasetPage.workingVersion)}"/>
                <f:viewAction action="#{DatasetMetadataTab.init(DatasetPage.workingVersion, DatasetPage.locked)}"/>
                <f:viewAction action="#{DatasetGuestbookTab.init(DatasetPage.dataset)}"/>
                <f:viewAction action="#{datasetVersionsTab.init(DatasetPage.dataset)}"/>
                <f:viewAction action="#{datasetDeaccessionDialog.init(DatasetPage.dataset)}"/>
                <f:viewAction action="#{dataverseHeaderFragment.initBreadcrumbs(DatasetPage.dataset)}"/>
            </f:metadata>
            <h:form id="datasetForm">
                <!-- Header / Button Panel -->
                <!-- View editMode -->
                <p:fragment id="topDatasetBlockFragment">
                    <div id="topDatasetBlock">
                        <div id="actionButtonBlock" class="button-block clearfix"
                             jsf:rendered="#{!widgetWrapper.widgetView}">
                            <div class="btn-group pull-right" role="group">
                                <!-- Edit/Publish Button Group -->
                                <!-- Publish/Submit for Review/Return to Author Button Group -->
                                <ui:fragment rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                            and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                            or (DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                            and DatasetPage.canUpdateDataset()
                                                            and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset))}">
                                    <!-- Publish Buttons -->
                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   onclick="PF('publishConfirm').show()"
                                                   rendered="#{!DatasetPage.dataset.released
                                                               and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                               and DatasetPage.dataset.owner.released
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   onclick="PF('noFilesInDataset').show()"
                                                   rendered="#{!DatasetPage.dataset.released
                                                               and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and !DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   onclick="PF('releaseDraft').show()"
                                                   rendered="#{DatasetPage.dataset.released
                                                    and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                    and DatasetPage.dataset.owner.released
                                                    and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                    and DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <!-- 4.2.1:  replaced permissionServiceBean.on(DatasetPage.dataset.owner).has('PublishDataverse') with DatasetPage.canPublishDataverse() -->
                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   onclick="PF('mayNotRelease').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and
                                                    !DatasetPage.dataset.owner.released
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and !DatasetPage.canPublishDataverse()
                                                               and DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   onclick="PF('publishParent').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                               and DatasetPage.canPublishDataverse()
                                                               and (DatasetPage.dataset.owner.owner == null
                                                                    or (DatasetPage.dataset.owner.owner != null and DatasetPage.dataset.owner.owner.released))
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>

                                    <p:commandLink type="button"
                                                   styleClass="btn btn-default btn-access #{DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview ? 'disabled' : ''}"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and !DatasetPage.dataset.owner.released
                                                               and DatasetPage.canPublishDataverse()
                                                               and (DatasetPage.dataset.owner.owner != null and !DatasetPage.dataset.owner.owner.released)
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)
                                                               and DatasetPage.isLatestDatasetWithAnyFilesIncluded()}"
                                                   onclick="PF('maynotPublishParent').show()">
                                        <span class="glyphicon glyphicon-globe"/> #{bundle['dataset.publish.btn']}
                                    </p:commandLink>
                                    <!-- END: Publish Buttons -->

                                    <!-- Return to Author Button -->
                                    <p:commandLink id="returnForModificationButton" type="button" styleClass="btn btn-default btn-access #{(DatasetPage.locked and !DatasetPage.dataset.latestVersion.inReview)
                                                                                                          ? 'disabled' : ''}"
                                                   onclick="PF('sendBackToContributor').show()"
                                                   rendered="#{DatasetPage.dataset.latestVersion.versionState=='DRAFT' and DatasetPage.dataset.latestVersion.inReview
                                                               and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <span class="glyphicon glyphicon-repeat"/> #{bundle['dataset.rejectBtn']}
                                    </p:commandLink>
                                    <!-- END: Return to Author Button -->

                                    <!-- Submit for Review Button -->
                                    <ui:fragment rendered="#{DatasetPage.workingVersion == DatasetPage.dataset.latestVersion
                                                                and !DatasetPage.datasetLockedInWorkflow
                                                                and DatasetPage.dataset.latestVersion.versionState=='DRAFT'
                                                                and DatasetPage.canUpdateDataset()
                                                                and !permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                        <button type="button"
                                                class="btn btn-default btn-access #{DatasetPage.dataset.latestVersion.inReview or DatasetPage.dataset.locked ? 'disabled' : ''}"
                                                onclick="#{DatasetPage.dataset.latestVersion.inReview or DatasetPage.dataset.locked ? 'return false;' : 'sentToReview();'}">
                                            <span class="glyphicon glyphicon-globe"/> #{DatasetPage.dataset.latestVersion.inReview ? bundle['dataset.disabledSubmittedBtn'] : bundle['dataset.submitBtn']}
                                        </button>
                                    </ui:fragment>

                                    <!-- End: Submit for Review Button -->
                                </ui:fragment>
                                <!-- END: Publish/Submit for Review/Return to Author Button Group -->

                                <p:commandLink
                                        rendered="#{dataverseSession.user.authenticated and !DatasetPage.workingVersion.deaccessioned and DatasetPage.dataset.released}"
                                        type="button" styleClass="btn btn-default btn-access"
                                        oncomplete="PF('linkDatasetForm').show();"
                                        update="linkDatasetForm">
                                    <span class="glyphicon glyphicon-link"/> #{bundle['link']}
                                </p:commandLink>

                                <!-- Edit Button -->
                                <ui:fragment rendered="#{DatasetPage.sessionUserAuthenticated
                                                                                  and DatasetPage.canUpdateDataset()
                                                                                  and !DatasetPage.dataset.deaccessioned}">
                                    <button type="button" id="editDataSet"
                                            class="btn btn-default btn-access dropdown-toggle #{DatasetPage.lockedFromEdits ? 'disabled' : ''}"
                                            data-toggle="dropdown">
                                        <span class="glyphicon glyphicon-pencil"/> #{bundle['dataset.editBtn']} <span
                                            class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu pull-right text-left" role="menu">
                                        <li>
                                            <h:outputLink
                                                    value="/editdatafiles.xhtml?datasetId=#{DatasetPage.dataset.id}&#38;mode=UPLOAD">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.upload']}"/>
                                            </h:outputLink>
                                        </li>
                                        <li>
                                            <h:outputLink
                                                    value="/editDatasetMetadata.xhtml?datasetId=#{DatasetPage.dataset.id}">
                                                <h:outputText value="#{bundle['dataset.editBtn.itemLabel.metadata']}"/>
                                            </h:outputLink>
                                        </li>
                                        <li>
                                            <h:outputLink
                                                    value="/selectGuestbook.xhtml?datasetId=#{DatasetPage.dataset.id}">
                                                <h:outputText
                                                        value="#{bundle['dataset.editBtn.itemLabel.selectGuestbook']}"/>
                                            </h:outputLink>
                                        </li>
                                        <li>
                                            <p:commandLink id="setEmbargo"
                                                           action="#{DatasetPage.initCurrentEmbargo()}"
                                                           update="setEmbargoPanel"
                                                           oncomplete="PF('setEmbargoConfirmation').show()"
                                                           rendered="#{DatasetPage.isUserAbleToSetOrUpdateEmbargo() or DatasetPage.isUserAbleToLiftEmbargo()}"
                                            >
                                                <h:outputText
                                                        value="#{bundle['dataset.editBtn.itemLabel.embargo']}"/>
                                            </p:commandLink>
                                        </li>
                                        <ui:fragment
                                                rendered="#{permissionsWrapper.canManagePermissions(DatasetPage.dataset)}">
                                            <li class="#{settingsWrapper.publicInstall ? '' : 'dropdown-submenu pull-left'}">
                                                <ui:fragment rendered="#{!settingsWrapper.publicInstall}">
                                                    <a tabindex="-1"
                                                       href="#">#{bundle['dataset.editBtn.itemLabel.permissions']}</a>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <h:link id="manageDatasetPermissions"
                                                                    styleClass="ui-commandlink ui-widget"
                                                                    outcome="permissions-manage">
                                                                <h:outputText value="#{bundle['dataset']}"/>
                                                                <f:param name="id" value="#{DatasetPage.dataset.id}"/>
                                                            </h:link>
                                                        </li>
                                                        <li>
                                                            <h:link id="manageFilePermissions"
                                                                    styleClass="ui-commandlink ui-widget"
                                                                    outcome="permissions-manage-files">
                                                                <h:outputText value="#{bundle['file']}"/>
                                                                <f:param name="id" value="#{DatasetPage.dataset.id}"/>
                                                            </h:link>
                                                        </li>
                                                    </ul>
                                                </ui:fragment>
                                                <h:link id="managePermissions"
                                                        rendered="#{settingsWrapper.publicInstall}"
                                                        styleClass="ui-commandlink ui-widget"
                                                        outcome="permissions-manage">
                                                    <h:outputText
                                                            value="#{bundle['dataset.editBtn.itemLabel.permissions']}"/>
                                                    <f:param name="id" value="#{DatasetPage.dataset.id}"/>
                                                </h:link>
                                            </li>
                                            <li>
                                                <p:commandLink id="privateUrl"
                                                               oncomplete="PF('privateUrlConfirmation').show()"
                                                               action="#{DatasetPage.initPrivateUrlPopUp()}"
                                                               update="privateUrlPanel">
                                                    <h:outputText
                                                            value="#{bundle['dataset.editBtn.itemLabel.privateUrl']}"/>
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <li>
                                            <h:outputLink
                                                    value="/dataset-widgets.xhtml?datasetId=#{DatasetPage.dataset.id}">
                                                <h:outputText
                                                        value="#{bundle['dataset.editBtn.itemLabel.thumbnailsAndWidgets']}"/>
                                            </h:outputLink>
                                        </li>
                                        <ui:fragment
                                                rendered="#{!DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deleteDataset"
                                                               onclick="PF('deleteConfirmation').show()">
                                                    <h:outputText
                                                            value="#{bundle['dataset.editBtn.itemLabel.deleteDataset']}"/>
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <ui:fragment
                                                rendered="#{DatasetPage.dataset.released and DatasetPage.dataset.latestVersion.versionState=='DRAFT' and permissionsWrapper.canIssueDeleteDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deleteVersion"
                                                               onclick="PF('deleteVersionConfirmation').show()">
                                                    <h:outputText
                                                            value="#{bundle['dataset.editBtn.itemLabel.deleteDraft']}"/>
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                        <ui:fragment
                                                rendered="#{DatasetPage.dataset.released and DatasetPage.existReleasedVersion and permissionsWrapper.canIssuePublishDatasetCommand(DatasetPage.dataset)}">
                                            <li class="divider"></li>
                                            <li>
                                                <p:commandLink id="deaccessionDatasetLink"
                                                               onclick="showDeaccessionDialog(); return false;">
                                                    <h:outputText
                                                            value="#{bundle['dataset.editBtn.itemLabel.deaccession']}"/>
                                                </p:commandLink>
                                            </li>
                                        </ui:fragment>
                                    </ul>
                                </ui:fragment>
                                <!-- END: Edit Button -->
                                <!-- END: Edit/Link/Publish Button Group -->
                            </div>

                            <!-- Contact/Share Button Group -->
                            <div class="btn-group pull-right" id="datasetButtonBar" role="group">
                                <p:commandLink class="text-button btn-contact bootstrap-button-tooltip"
                                               title="#{bundle['dataset.email.datasetContactBtn']}"
                                               update=":contactDialog" oncomplete="PF('contactForm').show()"
                                               actionListener="#{sendFeedbackDialog.initUserInput}">
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.userMessage}" value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.userEmail}" value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.messageSubject}"
                                                                 value=""/>
                                    <f:setPropertyActionListener target="#{sendFeedbackDialog.recipient}"
                                                                 value="#{DatasetPage.dataset}"/>
                                    <span class="glyphicon glyphicon-envelope"/> #{bundle['contact.contact']}
                                </p:commandLink>
                                <p:commandLink styleClass="text-button btn-share bootstrap-button-tooltip"
                                               rendered="#{!DatasetPage.workingVersion.deaccessioned}"
                                               title="#{bundle['dataset.share.datasetShare']}"
                                               oncomplete="PF('shareDialog').show();sharrre();">
                                    <span class="glyphicon glyphicon-share"/> #{bundle['share']}
                                </p:commandLink>
                            </div>
                            <p:dialog id="shareDialog" header="#{bundle['dataset.share.datasetShare']}"
                                      widgetVar="shareDialog" modal="true"
                                      rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                                <p class="help-block">#{bundle['dataset.share.datasetShare.tip']}</p>

                                <div id="sharrre-widget"
                                     data-url="#{systemConfig.dataverseSiteUrl}/dataset.xhtml?persistentId=#{dataset.globalId}"
                                     data-text="#{bundle['dataset.share.datasetShare.shareText']}"></div>

                                <div class="button-block">
                                    <button type="button" onclick="PF('shareDialog').hide()" class="btn btn-default"
                                            value="#{bundle.close}">
                                        #{bundle.close}
                                    </button>
                                </div>
                            </p:dialog>
                            <!-- END: Contact/Share Button Group -->

                            <!-- Metrics -->
                            <div id="metrics-block" class="col-xs-3"
                                 jsf:rendered="#{!(settingsWrapper.rsyncDownload or DatasetPage.workingVersion.deaccessioned)}">
                                <div id="metrics-label" class="col-xs-4 small text-center">
                                    <span class="glyphicon glyphicon-stats"/> #{bundle['metrics.title']}
                                </div>
                                <div id="metrics-content" class="col-xs-8 small text-center">
                                    <h:outputFormat styleClass="metrics-downloads"
                                                    value="{0} #{bundle['metrics.downloads']}">
                                        <f:param
                                                value="#{guestbookResponseService.getCountGuestbookResponsesByDatasetId(DatasetPage.dataset.id)}"/>
                                    </h:outputFormat>
                                </div>
                            </div>
                            <!-- END: Metrics -->
                        </div>

                        <div id="datasetVersionBlock" class="container-fluid">
                            <div id="title-block" class="row"
                                 jsf:rendered="#{!empty DatasetPage.title}">
                                <div class="col-xs-1 vcenter title-preview-icon-block">
                                    <img src="#{DatasetPage.thumbnailString}"
                                         jsf:rendered="#{!empty DatasetPage.thumbnailString}"/>
                                    <span class="icon-dataset" jsf:rendered="#{empty DatasetPage.thumbnailString}"/>
                                </div>
                                <div class="col-xs-11 vcenter">
                                    <span id="title">#{DatasetPage.title}</span>
                                    <h:outputText value="#{bundle['dataset.versionUI.draft']}"
                                                  styleClass="label label-primary"
                                                  rendered="#{DatasetPage.workingVersion.draft}"/>
                                    <h:outputText value="#{bundle['dataset.versionUI.inReview']}"
                                                  styleClass="label label-success"
                                                  rendered="#{DatasetPage.workingVersion.inReview}"/>
                                    <h:outputText value="#{bundle['dataset.versionUI.unpublished']}"
                                                  styleClass="label label-warning"
                                                  rendered="#{!DatasetPage.dataset.released}"/>
                                    <h:outputText value="#{bundle['dataset.versionUI.deaccessioned']}"
                                                  styleClass="label label-danger"
                                                  rendered="#{DatasetPage.workingVersion.deaccessioned}"/>
                                    <!-- DATASET VERSION NUMBER -->
                                    <h:outputText styleClass="label label-default"
                                                  rendered="#{DatasetPage.workingVersion.released and !(DatasetPage.workingVersion.draft or DatasetPage.workingVersion.inReview or DatasetPage.workingVersion.deaccessioned)}"
                                                  value="#{bundle['file.DatasetVersion']} #{DatasetPage.workingVersion.versionNumber}.#{DatasetPage.workingVersion.minorVersionNumber}"/>
                                    <h:outputText styleClass="label label-default"
                                                  rendered="#{!DatasetPage.workingVersion.released and !(DatasetPage.workingVersion.draft or DatasetPage.workingVersion.inReview or DatasetPage.workingVersion.deaccessioned)}"
                                                  value="#{bundle['file.DatasetVersion']} #{DatasetPage.workingVersion.versionState}"/>
                                </div>
                            </div>
                            <!-- CITATION BLOCK -->
                            <ui:fragment rendered="#{!empty DatasetPage.displayCitation}">
                                <ui:include src="dataset-citation.xhtml">
                                    <ui:param name="datasetPage" value="true"/>
                                </ui:include>
                            </ui:fragment>
                            <!-- END: CITATION BLOCK -->
                            <div id="deaccession-reason-block" class="row bg-danger"
                                 jsf:rendered="#{DatasetPage.workingVersion.deaccessioned}">
                                <h5 class="margin-top-half">#{bundle['dataset.deaccession.reason']}</h5>
                                <p>#{DatasetPage.workingVersion.versionNote}</p>
                                <ui:fragment rendered="#{!empty DatasetPage.workingVersion.archiveNote}">
                                    <p>#{bundle['dataset.beAccessedAt']} <a
                                            href="#{DatasetPage.workingVersion.archiveNote}"
                                            target="_blank">#{DatasetPage.workingVersion.archiveNote}</a></p>
                                </ui:fragment>
                            </div>
                            <!-- BEGIN: DATASET SUMMARY -->
                            <div jsf:id="dataset-summary-metadata" class="row panel panel-default"
                                 jsf:rendered="#{!widgetWrapper.widgetView and !DatasetPage.workingVersion.deaccessioned and
                                                    (!empty DatasetPage.datasetSummaryFields or !empty DatasetPage.workingVersion.fileMetadatas) }">
                                <div class="panel-body metadata-panel-body">
                                    <ui:repeat value="#{DatasetPage.datasetSummaryFields}" var="dsf">

                                        <div id="keywords" class="form-group"
                                             jsf:rendered="#{!empty DatasetPage.keywordsDisplaySummary and dsf.datasetFieldType.name=='keyword'}">
                                            <label class="col-sm-3 control-label">
                                                #{bundle['dataset.keywordDisplay.title']}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{dsf.datasetFieldType.localeDescription}"></span>
                                            </label>
                                            <div class="col-sm-9">#{DatasetPage.keywordsDisplaySummary}</div>
                                        </div>
                                        <div id="publication" class="form-group"
                                             jsf:rendered="#{!empty DatasetPage.firstRelPublication and 
                                                dsf.datasetFieldType.name=='publication'}">
                                            <label class="col-sm-3 control-label">
                                                #{dsf.datasetFieldType.localeTitle}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{dsf.datasetFieldType.localeDescription}"></span>
                                            </label>
                                            <div class="col-sm-9">
                                                <h:outputText
                                                        value="#{DatasetPage.firstRelPublication.text}"
                                                        escape="false"/>
                                                <b>#{DatasetPage.firstRelPublication.url}</b>
                                                <ui:fragment
                                                        rendered="#{not empty DatasetPage.firstRelPublication.url}">
                                                    <a href="#{DatasetPage.firstRelPublication.url}"
                                                       title="#{DatasetPage.firstRelPublication.url}"
                                                       target="_blank">
                                                        <h:outputText
                                                                value="#{DatasetPage.firstRelPublication.idType}: #{DatasetPage.firstRelPublication.idNumber}"/>
                                                    </a>
                                                </ui:fragment>
                                                <ui:fragment rendered="#{empty DatasetPage.firstRelPublication.url}">
                                                    <h:outputText
                                                            value="#{DatasetPage.firstRelPublication.idType}: #{DatasetPage.firstRelPublication.idNumber}"/>
                                                </ui:fragment>
                                            </div>
                                        </div>

                                        <div class="form-group"
                                             jsf:rendered="#{dsf.datasetFieldType.name!='publication' and dsf.datasetFieldType.name!='keyword'  }">
                                            <label for="metadata_#{dsf.datasetFieldType.name}"
                                                   class="col-sm-3 control-label">
                                                #{dsf.datasetFieldType.localeTitle}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{dsf.datasetFieldType.localeDescription}"></span>
                                            </label>

                                            <ui:include src="viewMetadataField.xhtml">
                                                <ui:param name="datasetField" value="#{dsf}"/>
                                            </ui:include>
                                        </div>
                                    </ui:repeat>

                                    <ui:fragment
                                            rendered="#{!empty DatasetPage.workingVersion.fileMetadatas and !DatasetPage.sameTermsOfUseForAllFiles and !DatasetPage.isUserUnderEmbargo()}">
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">
                                                #{bundle['dataset.files.license']}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{bundle['dataset.files.license.description']}"></span>
                                            </label>
                                            <div class="col-sm-9">
                                                #{bundle['dataset.files.license.multiple']}
                                            </div>
                                        </div>
                                    </ui:fragment>
                                    <ui:fragment
                                            rendered="#{!empty DatasetPage.workingVersion.fileMetadatas and DatasetPage.sameTermsOfUseForAllFiles and !DatasetPage.isUserUnderEmbargo()}">
                                        <div class="form-group"
                                             jsf:rendered="#{DatasetPage.termsOfUseOfFirstFile.get().termsOfUseType == termsOfUseTypeEnum.LICENSE_BASED}">
                                            <label class="col-sm-3 control-label">
                                                #{bundle['dataset.files.license']}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{bundle['dataset.files.license.description']}"></span>
                                            </label>
                                            <div class="col-sm-9">
                                                #{DatasetPage.termsOfUseOfFirstFile.get().license.getLocalizedName(dataverseSession.locale)}
                                            </div>
                                        </div>
                                        <div class="form-group"
                                             jsf:rendered="#{DatasetPage.termsOfUseOfFirstFile.get().termsOfUseType == termsOfUseTypeEnum.ALL_RIGHTS_RESERVED}">
                                            <label class="col-sm-3 control-label">
                                                #{bundle['dataset.files.termsOfAccess']}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{bundle['dataset.files.license.description']}"></span>
                                            </label>
                                            <div class="col-sm-9">
                                                #{bundle['file.allRightsReserved']}
                                            </div>
                                        </div>
                                        <div class="form-group"
                                             jsf:rendered="#{DatasetPage.termsOfUseOfFirstFile.get().termsOfUseType == termsOfUseTypeEnum.RESTRICTED}">
                                            <label class="col-sm-3 control-label">
                                                #{bundle['dataset.files.termsOfAccess']}
                                                <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                      data-toggle="tooltip" data-placement="auto right"
                                                      data-original-title="#{bundle['dataset.files.termsOfAccess.description']}"></span>
                                            </label>
                                            <div class="col-sm-9">
                                                #{bundle['file.termsOfAccess.restricted']} -
                                                <h:outputText
                                                        value="#{bundle['file.termsOfAccess.restricted.'.concat(DatasetPage.termsOfUseOfFirstFile.get().restrictType)]}"
                                                        rendered="#{DatasetPage.termsOfUseOfFirstFile.get().restrictType != restrictTypeEnum.CUSTOM}"/>
                                                <h:outputText
                                                        value="#{DatasetPage.termsOfUseOfFirstFile.get().restrictCustomText}"
                                                        rendered="#{DatasetPage.termsOfUseOfFirstFile.get().restrictType == restrictTypeEnum.CUSTOM}"/>
                                            </div>
                                        </div>
                                    </ui:fragment>
                                    <!-- Embargo -->
                                    <ui:fragment
                                            rendered="#{DatasetPage.dataset.hasActiveEmbargo()}">
                                    <div class="form-group" >
                                        <label class="col-sm-3 control-label">
                                            #{bundle['dataset.embargo.datasetSummary.title']}
                                            <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                                  data-toggle="tooltip" data-placement="auto right"
                                                  data-original-title="#{bundle['dataset.embargo.datasetSummary.tip']}"></span>
                                        </label>
                                        <div class="col-sm-9">
                                            #{DatasetPage.currentEmbargoDateForDisplay}
                                        </div>
                                    </div>
                                    </ui:fragment>
                                </div>
                            </div>
                            <!-- END: DATASET SUMMARY -->
                        </div>
                    </div>
                </p:fragment>
                <!-- END View editMode -->
                <!-- END Header / Button Panel -->

                <!-- View/Tabs infoMode -->
                <!-- Tabs -->
                <div id="contentTabs">

                    <p:fragment id="pageRefreshFragment">
                        <h:inputHidden value="#{DatasetPage.lockedForAnyReason}"
                                       id="datasetLockedForAnyReasonVariable"/>
                        <h:inputHidden value="#{DatasetPage.stateChanged}" id="datasetStateChangedVariable"/>

                        <p:remoteCommand name="refreshAllLocksCommand" process="@this"
                                         update=":#{p:resolveClientId('datasetForm:pageRefreshFragment', view)}"
                                         actionListener="#{DatasetPage.refreshAllLocks()}"/>
                        <p:remoteCommand name="refreshAllCommand" process="@this"
                                         update=":datasetForm:topDatasetBlockFragment,:datasetForm:tabView:filesTable,:messagePanel"
                                         actionListener="#{DatasetPage.refresh}"/>

                        <!-- see the comment in the javascript below that explains what this button is for -->
                        <p:commandButton id="refreshButton" process="@this" widgetVar="refreshButton"
                                         update=":datasetForm:topDatasetBlockFragment,:datasetForm:tabView:filesTable,:messagePanel,datasetForm:tabView:editMetadataButton"
                                         style="display:none"/>

                        <script type="text/javascript">
                            $(this).ready(function () {
                                refreshIfStillLocked();
                            });

                            function refreshIfStillLocked() {
                                if ($('input[id$="datasetLockedForAnyReasonVariable"]').val() === 'true') {
                                    // if dataset is locked, instruct the page to
                                    // wait and check again:
                                    waitAndCheckLockAgain();
                                } else {
                                    // if not locked, has it just been unlocked?
                                    if ($('input[id$="datasetStateChangedVariable"]').val() === 'true') {
                                        // For whatever unknown PrimeFaces reason
                                        // the page needs to be refreshed twice, for all
                                        // the pull down menus to update properly:
                                        refreshAllCommand();
                                        // You can't just run 2 refreshAllCommand()s in a row
                                        // either; because the command has an "update=@all" on it,
                                        // so I guess if you try to execute the 2nd one right after
                                        // the first one, this fragment is still going to be loading -
                                        // so there would not yet be a command to run! (it needs to
                                        // be rendered, before you can execute it, that is)
                                        setTimeout(function () {
                                            // this button doesn't do anything, but it has an update="@all"
                                            // attribute:
                                            $('button[id$="refreshButton"]').trigger('click');
                                            //refreshAllCommand();
                                        }, 1500);
                                    }
                                }
                            }

                            function waitAndCheckLockAgain() {
                                setTimeout(function () {
                                    // refresh the lock in the
                                    // backing bean; i.e., check, if the ingest has
                                    // already completed in the background:
                                    //$('button[id$="refreshButton"]').trigger('click');
                                    //refreshLockCommand();
                                    refreshAllLocksCommand();
                                }, 10000);
                            }
                        </script>
                    </p:fragment>

                    <p:tabView id="tabView" widgetVar="content" activeIndex="#{DatasetPage.selectedTabIndex}"
                               dynamic="true">

                        <p:tab id="dataFilesTab" title="#{bundle.files}" rendered="#{!DatasetPage.workingVersion.deaccessioned or
                                                              (DatasetPage.workingVersion.deaccessioned and DatasetPage.canUpdateDataset())}">
                            <ui:include src="filesFragment.xhtml"/>
                        </p:tab>

                        <!-- 4.2.1: the 3 tabs below - metadata, terms and versions: these account for ~100 queries total -->
                        <!-- a lot of these however, are repeated queries on AuthenticatedUser and RoleAssignment; once these are optimized, the tabs will become very cheap. -->
                        <p:tab id="metadataTab" title="#{bundle['file.dataFilesTab.metadata.header']}"
                               rendered="#{(!DatasetPage.workingVersion.deaccessioned or (DatasetPage.workingVersion.deaccessioned and DatasetPage.canUpdateDataset()))}">
                            <ui:include src="metadataTab.xhtml"/>
                        </p:tab>

                        <!-- 4.2.1: see comment above -->
                        <p:tab id="termsTab" title="#{bundle['file.dataFilesTab.terms.list.guestbook']}"
                               rendered="#{!DatasetPage.workingVersion.deaccessioned}">
                            <ui:include src="view-dataset-guestbook.xhtml"/>
                        </p:tab>
                        <!-- 4.2.1: see above -->
                        <p:tab id="versionsTab" title="#{bundle['file.dataFilesTab.versions']}">
                            <ui:include src="dataset-versions.xhtml">
                            </ui:include>
                        </p:tab>
                    </p:tabView>
                </div>
                <!-- END View/Tabs infoMode -->

                <!-- Popups -->
                <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDialog.header']}"
                          widgetVar="deleteConfirmation" modal="true">
                    <p class="text-warning"><span
                            class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDialog.tip']}</p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.continue}" onclick="PF('deleteConfirmation').hide()"
                                         action="#{DatasetPage.deleteDataset()}"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('deleteConfirmation').hide();"
                                         type="button"/>
                    </div>
                </p:dialog>
                <!-- Set Embargo -->
                <p:dialog id="SetEmbargo" styleClass="smallPopUp" header="#{bundle['dataset.embargo.header']}"
                          widgetVar="setEmbargoConfirmation" modal="true">
                    <p:fragment id="setEmbargoPanel">
                        <p class="help-block">
                            <h:outputFormat value="#{bundle['dataset.embargo.description.message']}"
                                            escape="false"
                                            rendered="#{DatasetPage.isUserAbleToSetOrUpdateEmbargo()}"
                            >
                                <br />
                            </h:outputFormat>
                            <h:outputFormat value="#{bundle['dataset.embargo.max.message']}"
                                            escape="false"
                                            rendered="#{DatasetPage.isUserAbleToSetOrUpdateEmbargo() and DatasetPage.isMaximumEmbargoLengthSet()}"
                            >
                                <f:param value="#{DatasetPage.getMaximumEmbargoLength()}"/>
                                <br />
                            </h:outputFormat>
                            <h:outputFormat value="#{bundle['dataset.embargo.message']}"
                                            escape="false"
                                            rendered="#{not empty DatasetPage.currentEmbargoDate}"
                            >
                                <f:param value="#{DatasetPage.currentEmbargoDateForDisplay}"/>
                                <br />
                            </h:outputFormat>
                        </p>
                        <div jsf:rendered="#{DatasetPage.isUserAbleToSetOrUpdateEmbargo()}">
                            <p:outputLabel for="embargoDatePicker" value="#{bundle['dataset.embargo.calendar.label']}" />
                            <span class="glyphicon glyphicon-question-sign tooltip-icon"
                                  data-toggle="tooltip" data-placement="auto right"
                                  data-original-title="#{bundle['dataset.embargo.calendar.label.tip']}"></span>
                            <p:calendar
                                    id="embargoDatePicker"
                                    rendered="#{!DatasetPage.isMaximumEmbargoLengthSet()}"
                                    value="#{DatasetPage.currentEmbargoDate}"
                                    showButtonBar="true"
                                    mindate="#{DatasetPage.getTomorrowsDate()}"
                                    effect="drop"
                                    navigator="true"
                                    pattern="#{settingsWrapper.getSettingValue(':DefaultDateFormat')}"
                                    validator="#{DatasetPage.validateEmbargoDate}"
                                    locale="#{dataverseSession.localeCode}"
                                    timeZone="UTC"
                            />
                            <p:calendar
                                    id="embargoDatePickerMaxLimited"
                                    rendered="#{DatasetPage.isMaximumEmbargoLengthSet()}"
                                    value="#{DatasetPage.currentEmbargoDate}"
                                    showButtonBar="true"
                                    mindate="#{DatasetPage.getTomorrowsDate()}"
                                    maxdate="#{DatasetPage.getMaximumEmbargoDate().get()}"
                                    effect="drop"
                                    navigator="true"
                                    pattern="#{settingsWrapper.getSettingValue(':DefaultDateFormat')}"
                                    validator="#{DatasetPage.validateEmbargoDate}"
                                    locale="#{dataverseSession.localeCode}"
                                    timeZone="UTC"
                            />
                            <p:message id="embargoMsg" for="embargoDatePicker" display="text" />
                            <p:message id="embargoMsgMaxLimited" for="embargoDatePickerMaxLimited" display="text" />
                        </div>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['dataset.embargo.set.button']}"
                                             action="#{DatasetPage.updateEmbargoDate()}"
                                             update="setEmbargoPanel,:messagePanel, dataset-summary-metadata"
                                             rendered="#{DatasetPage.isUserAbleToSetOrUpdateEmbargo()}"
                                             oncomplete="if (args &amp;&amp; !args.validationFailed) { PF('setEmbargoConfirmation').hide(); } else { #{DatasetPage.initCurrentEmbargo()}; }"
                            />
                            <p:commandButton value="#{bundle['dataset.embargo.lift.button']}"
                                             onclick="PF('setEmbargoConfirmation').hide();PF('removeEmbargoConfirmation').show()"
                                             rendered="#{DatasetPage.isUserAbleToLiftEmbargo()}" update="setEmbargoPanel"/>
                            <p:commandButton styleClass="btn btn-default"
                                             value="#{bundle.close}"
                                             onclick="PF('setEmbargoConfirmation').hide();"
                                             update="setEmbargoPanel, embargoDatePicker"
                                             resetValues="true"
                            />
                        </div>
                    </p:fragment>
                </p:dialog>
                <!-- Confirm embargo lift -->
                <p:dialog styleClass="smallPopUp" header="#{bundle['dataset.embargo.header']}"
                          widgetVar="removeEmbargoConfirmation" modal="true" closable="false">
                    <p class="text-warning"><span
                            class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.embargo.lift.confirmationText']}
                    </p>
                    <p jsf:rendered="#{DatasetPage.dataset.hasEverBeenPublished()}" class="text-warning"><span
                            class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.embargo.lift.publishedConfirmationText']}
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle['dataset.embargo.lift.confirmButton']}"
                                         immediate="true"
                                         action="#{DatasetPage.liftEmbargo()}"
                                         update="setEmbargoPanel,:messagePanel, dataset-summary-metadata"
                                         onclick="PF('removeEmbargoConfirmation').hide();"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('removeEmbargoConfirmation').hide();PF('setEmbargoConfirmation').show();"
                                         type="button"/>
                    </div>
                </p:dialog>

                <p:dialog styleClass="smallPopUp" header="#{bundle['file.deleteDraftDialog.header']}"
                          widgetVar="deleteVersionConfirmation" modal="true">
                    <p class="text-warning"><span
                            class="glyphicon glyphicon-warning-sign"/> #{bundle['file.deleteDraftDialog.tip']}</p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.continue}" onclick="PF('deleteVersionConfirmation').hide()"
                                         action="#{DatasetPage.deleteDatasetVersion()}"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('deleteVersionConfirmation').hide();"
                                         type="button"/>
                    </div>
                </p:dialog>
                <p:dialog id="privateUrlId" styleClass="smallPopUp" header="#{bundle['dataset.privateurl.header']}"
                          widgetVar="privateUrlConfirmation" modal="true">
                    <p:fragment id="privateUrlPanel">
                        <p class="help-block">
                            <h:outputFormat value="#{bundle['dataset.privateurl.tip']}" escape="false">
                                <f:param value="#{settingsWrapper.guidesBaseUrl}"/>
                                <f:param value="#{settingsWrapper.guidesVersion}"/>
                            </h:outputFormat>
                        </p>
                        <div>
                            <div class="highlight" jsf:rendered="#{empty(DatasetPage.privateUrl)}">
                                <p class="no-margin-bottom">#{bundle['dataset.privateurl.absent']}</p>
                            </div>
                            <div class="highlight" jsf:rendered="#{!empty(DatasetPage.privateUrl)}" onclick="if (event.target) {
                                            selectText(event.target);
                                        } else {
                                            selectText(this);
                                        }">
                                <p class="text-success highlightBold"
                                   jsf:rendered="#{DatasetPage.privateUrlWasJustCreated}"><span
                                        class="glyphicon glyphicon glyphicon-ok"/> #{bundle['dataset.privateurl.createdSuccess']}
                                </p>
                                <ui:param name="privateUrlLink"
                                          value="#{DatasetPage.getPrivateUrlLink(DatasetPage.privateUrl)}"/>
                                <p class="no-margin-bottom">
                                    <span>#{privateUrlLink}</span>
                                </p>
                            </div>
                        </div>
                        <div class="button-block">
                            <p:commandButton value="#{bundle['dataset.privateurl.createPrivateUrl']}"
                                             action="#{DatasetPage.createPrivateUrl()}"
                                             update="privateUrlPanel,:messagePanel"
                                             rendered="#{empty(DatasetPage.privateUrl)}"/>
                            <p:commandButton value="#{bundle['dataset.privateurl.disablePrivateUrl']}"
                                             action="#{DatasetPage.setPrivateUrlJustCreatedToFalse()}"
                                             onclick="PF('privateUrlConfirmation').hide();PF('disablePrivateUrlConfirmation').show()"
                                             rendered="#{!empty(DatasetPage.privateUrl)}" update="privateUrlPanel"/>
                            <p:commandButton styleClass="btn btn-default" value="#{bundle.close}"
                                             onclick="PF('privateUrlConfirmation').hide();"
                                             update="privateUrlPanel"/>
                        </div>
                    </p:fragment>
                </p:dialog>
                <p:dialog styleClass="smallPopUp" header="#{bundle['dataset.privateurl.header']}"
                          widgetVar="disablePrivateUrlConfirmation" modal="true" closable="false">
                    <p class="text-warning"><span
                            class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.privateurl.disableConfirmationText']}
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle['dataset.privateurl.disablePrivateUrlConfirm']}"
                                         action="#{DatasetPage.disablePrivateUrl()}"
                                         update="privateUrlPanel,:messagePanel"
                                         onclick="PF('disablePrivateUrlConfirmation').hide();"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('disablePrivateUrlConfirmation').hide();PF('privateUrlConfirmation').show();"
                                         type="button"/>
                    </div>
                </p:dialog>

                <p:dialog id="linkDatasetForm" styleClass="largePopUp" header="#{bundle['dataset.link']}"
                          widgetVar="linkDatasetForm" modal="true">
                    <div class="form-horizontal">
                        <p class="help-block">
                            <h:outputFormat value="#{bundle['dataverse.link.dataset.choose']}" escape="false">
                                <o:param>
                                    <p:commandLink value="#{installationConfig.supportTeamName}"
                                                   oncomplete="PF('linkDatasetForm').hide();PF('contactForm').show()"
                                                   update=":contactDialog"
                                                   actionListener="#{sendFeedbackDialog.initUserInput}">
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.messageSubject}"
                                                                     value=""/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.recipient}"
                                                                     value="#{null}"/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.userMessage}"
                                                                     value=""/>
                                        <f:setPropertyActionListener target="#{sendFeedbackDialog.userEmail}" value=""/>
                                    </p:commandLink>
                                </o:param>
                            </h:outputFormat>
                        </p>
                        <div class="form-group">
                            <label class="col-xs-3 control-label">
                                <h:outputText value="#{bundle['dataverse.link.yourDataverses']}"/>
                            </label>
                            <div class="col-xs-8">
                                <p:fragment id="linkNameContent">
                                    <p:autoComplete id="dataverseLinkName" style="width:75%;"
                                                    binding="#{DatasetPage.selectedDataverseMenu}"
                                                    placeholder="#{bundle['dataverse.link.yourDataverses.inputPlaceholder']}"
                                                    emptyMessage="#{bundle['dataverse.link.dataset.none']}"
                                                    scrollHeight="180" forceSelection="true"
                                                    minQueryLength="1" queryDelay="1000"
                                                    value="#{DatasetPage.selectedDataverseForLinking}"
                                                    multiple="false"
                                                    completeMethod="#{DatasetPage.completeLinkingDataverse}"
                                                    required="#{param['DO_DS_LINK_VALIDATION']}"
                                                    requiredMessage="#{bundle['dataverse.link.select']}"
                                                    styleClass="DropdownPopup" panelStyleClass="DropdownPopupPanel"
                                                    var="dataverseLk" itemLabel="#{dataverseLk.displayName}"
                                                    itemValue="#{dataverseLk}" converter="dataverseConverter">
                                        <p:column>
                                            <h:outputText value="#{dataverseLk.displayName}"/>
                                        </p:column>
                                        <p:column>
                                            <h:outputText value="#{dataverseLk.alias}"/>
                                        </p:column>
                                        <p:ajax process="@this" event="itemSelect"/>
                                        <p:ajax process="@this" event="itemUnselect"/>
                                    </p:autoComplete>
                                    <p:message for="dataverseLinkName"/>
                                </p:fragment>
                            </div>
                        </div>
                    </div>
                    <div class="button-block">
                        <p:commandLink id="saveLinkButton" type="button" styleClass="btn btn-default"
                                       update="linkNameContent @([id$=Messages])"
                                       oncomplete="if (args &amp;&amp; !args.validationFailed) linkDatasetCommand();"
                                       value="#{bundle['dataset.link.save']}">
                            <f:param name="DO_DS_LINK_VALIDATION" value="true"/>
                        </p:commandLink>
                        <button type="button" class="btn btn-default"
                                onclick="PF('linkDatasetForm').hide();">
                            #{bundle.cancel}
                        </button>
                    </div>
                </p:dialog>

                <p:remoteCommand name="linkDatasetCommand" oncomplete="PF('linkDatasetForm').hide();"
                                 update=":messagePanel  @([id$=Messages])"
                                 actionListener="#{DatasetPage.saveLinkingDataverses}"/>

                <p:dialog id="inreview" header="#{bundle['dataset.submitBtn']}" widgetVar="inreview" modal="true">

                    <p:outputPanel rendered="#{DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                        <p class="text-warning">
                            <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.submitMessage']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.submit}" onclick="PF('inreview').hide();"
                                             action="#{DatasetPage.submitDataset}"
                                             immediate="true"/>
                            <p:commandButton value="#{bundle.cancel}"
                                             onclick="PF('inreview').hide();" type="button"
                                             immediate="true"/>
                        </div>
                    </p:outputPanel>

                    <p:outputPanel rendered="#{!DatasetPage.isLatestDatasetWithAnyFilesIncluded()}">
                        <p class="text-danger">
                            <span class="glyphicon glyphicon-exclamation-sign"/> #{bundle['dataset.submit.failure.noFiles']}
                        </p>
                        <div class="button-block">
                            <p:commandButton value="#{bundle.ok}"
                                             onclick="PF('inreview').hide();"
                                             type="button"/>
                        </div>
                    </p:outputPanel>
                </p:dialog>

                <!-- Publish/Submit for Review Dialogs -->
                <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="publishConfirm"
                          modal="true"
                          rendered="#{DatasetPage.canPublishDataverse()}">

                    <p class="text-warning">
                        <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.publish.tip']}
                    </p>
                    <div id="terms-agreement-block" class="well"
                         jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0}">
                        <h:outputText value="#{DatasetPage.datasetPublishCustomText}" escape="false"/>
                    </div>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.continue}" onclick="PF('publishConfirm').hide();"
                                         action="#{DatasetPage.releaseDataset}"
                                         immediate="true"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('publishConfirm').hide();"
                                         type="button"/>
                    </div>

                </p:dialog>

                <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="noFilesInDataset"
                          modal="true"
                          rendered="#{DatasetPage.canPublishDataverse()}">

                    <p class="text-danger">
                        <span class="glyphicon glyphicon-exclamation-sign"/> #{bundle['dataset.publish.error.noFiles']}
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.ok}"
                                         onclick="PF('noFilesInDataset').hide();"
                                         type="button"/>
                    </div>

                </p:dialog>

                <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="publishParent"
                          modal="true">
                    <p class="text-warning">
                        <span class="glyphicon glyphicon-warning-sign"/>
                        <h:outputFormat value="#{bundle['dataset.mayNotPublish.both']}" escape="false">
                            <o:param>
                                <a href="/dataverse/#{DatasetPage.dataset.owner.alias}"
                                   title="#{DatasetPage.dataset.owner.displayName}">
                                    <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                </a>
                            </o:param>
                        </h:outputFormat>
                    </p>
                    <div id="terms-agreement-block" class="well"
                         jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0}">
                        <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetPublishCustomText)}"
                                      escape="false"/>
                    </div>
                    <p class="help-block">
                        #{bundle['dataset.publishBoth.tip']}
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle['dataset.mayNotBePublished.both.button']}"
                                         onclick="PF('publishParent').hide();"
                                         action="#{DatasetPage.releaseParentDVAndDataset}"
                                         immediate="true"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('publishParent').hide();"
                                         type="button" immediate="true"/>
                    </div>
                </p:dialog>

                <p:dialog width="70%" header="#{bundle['dataset.publish.header']}" widgetVar="releaseDraft"
                          modal="true">
                    <p class="text-warning">
                        <span class="glyphicon glyphicon-warning-sign"/> #{bundle['dataset.republish.tip']}
                    </p>
                    <div id="terms-agreement-block" class="well"
                         jsf:rendered="#{DatasetPage.datasetPublishCustomText.length() > 0 and DatasetPage.isDatasetPublishPopupCustomTextOnAllVersions()}">
                        <h:outputText value="#{MarkupChecker:sanitizeBasicHTML(DatasetPage.datasetPublishCustomText)}"
                                      escape="false"/>
                    </div>
                    <ui:fragment rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}">
                        <p class="help-block">
                            #{bundle['dataset.selectVersionNumber']}
                        </p>
                        <p:selectOneRadio id="options" value="#{DatasetPage.releaseRadio}">
                            <f:selectItem
                                    itemLabel="#{bundle['dataset.minorRelease']} (#{DatasetPage.datasetNextMinorVersion})"
                                    itemValue="1"/>
                            <f:selectItem
                                    itemLabel="#{bundle['dataset.majorRelease']} (#{DatasetPage.datasetNextMajorVersion})"
                                    itemValue="2"/>
                            <c:if test="#{dataverseSession.user.isSuperuser()}">
                                <f:selectItem rendered="#" itemLabel="#{bundle['dataset.updateRelease']}"
                                              itemValue="3"/>
                            </c:if>
                        </p:selectOneRadio>
                    </ui:fragment>
                    <p>
                        <h:outputFormat value="#{bundle['dataset.majorRelease.tip']}"
                                        rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}">
                            <f:param value="#{DatasetPage.datasetNextMajorVersion}"/>
                        </h:outputFormat>
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.continue}"
                                         onclick="PF('releaseDraft').hide();"
                                         rendered="#{DatasetPage.dataset.latestVersion.minorUpdate}"
                                         action="#{DatasetPage.releaseDraft}"/>
                        <p:commandButton value="#{bundle.continue}" onclick="PF('releaseDraft').hide();"
                                         rendered="#{!DatasetPage.dataset.latestVersion.minorUpdate}"
                                         action="#{DatasetPage.releaseMajor}" immediate="true"/>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('releaseDraft').hide();"
                                         type="button"/>
                    </div>
                </p:dialog>

                <p:dialog header="#{bundle['dataset.publish.header']}" widgetVar="mayNotRelease" modal="true">
                    <p class="text-danger">
                        <span class="glyphicon glyphicon-exclamation-sign"/>
                        <h:outputFormat value="#{bundle['dataset.mayNotPublish.administrator']}" escape="false">
                            <o:param>
                                <a href="/dataverse.xhtml?alias=#{DatasetPage.dataset.owner.alias}"
                                   title="#{DatasetPage.dataset.owner.displayName}">
                                    <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                </a>
                            </o:param>
                        </h:outputFormat>
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.close}" onclick="PF('mayNotRelease').hide();"
                                         type="button"/>
                    </div>
                </p:dialog>

                <p:dialog header="#{bundle['dataset.publish.header']}" widgetVar="maynotPublishParent" modal="true">
                    <p class="text-danger">
                        <span class="glyphicon glyphicon-exclamation-sign"/>
                        <h:outputFormat value="#{bundle['dataset.mayNotPublish.twoGenerations']}" escape="false">
                            <o:param>
                                <a href="/dataverse/#{DatasetPage.dataset.owner.alias}"
                                   title="#{DatasetPage.dataset.owner.displayName}">
                                    <h:outputText value="#{DatasetPage.dataset.owner.displayName}"/>
                                </a>
                            </o:param>
                            <o:param>
                                <a href="/dataverse/#{DatasetPage.dataset.owner.owner.alias}"
                                   title="#{DatasetPage.dataset.owner.owner.displayName}">
                                    <h:outputText value="#{DatasetPage.dataset.owner.owner.displayName}"/>
                                </a>
                            </o:param>
                        </h:outputFormat>
                    </p>
                    <div class="button-block">
                        <p:commandButton value="#{bundle.close}" onclick="PF('maynotPublishParent').hide();"
                                         type="button"/>
                    </div>
                </p:dialog>

                <p:dialog header="#{bundle['dataset.rejectBtn']}" widgetVar="sendBackToContributor" modal="true">
                    <div class="form-group">
                        <label for="returnReasonTextArea" class="col-sm-3 control-label">#{bundle['dataset.reject.messageBox.label']}
                            <span class="glyphicon glyphicon-asterisk text-danger" title="#{bundle.requiredField}"/>
                        </label>
                        <div class="col-sm-9">
                            <p:fragment id="returnReasonFragment">
                                <p:inputTextarea id="returnReasonTextArea"
                                                 rows="3"
                                                 value="#{DatasetPage.returnToAuthorReason}"
                                                 maxlength="255"
                                                 cols="60"
                                                 counter="display"
                                                 counterTemplate="#{bundle['dataset.reject.messageBox.counter']}"
                                                 autoResize="false"
                                                 required="#{param['DO_RETURN_VALIDATION']}"
                                                 requiredMessage="#{bundle['dataset.reject.enterReason']}"
                                                 styleClass="form-control"
                                >
                                </p:inputTextarea>
                                <h:message for="returnReasonTextArea" styleClass="bg-danger text-danger"/>
                                <p>
                                    <h:outputText id="display"/>
                                </p>
                            </p:fragment>
                        </div>
                        <p:watermark for="returnReasonTextArea" value="#{bundle['dataset.rejectWatermark']}"
                                     id="returnReasonwatermark"/>
                    </div>
                    <div class="button-block">
                        <p:commandLink styleClass="btn btn-default btn-access"
                                       value="#{bundle.ok}"
                                       update=":messagePanel returnReasonFragment"
                                       oncomplete="if (args &amp;&amp; !args.validationFailed) PF('sendBackToContributor').hide();"
                                       actionListener="#{DatasetPage.sendBackToContributor()}"
                        >
                            <f:param name="DO_RETURN_VALIDATION" value="#{true}" />
                        </p:commandLink>
                        <p:commandButton value="#{bundle.cancel}"
                                         onclick="PF('sendBackToContributor').hide();"
                                         type="button" />
                    </div>
                </p:dialog>
                <!-- END: Publish/Submit for Review Dialogs -->
            </h:form>


            <ui:include src="dataset-deaccession-dialog.xhtml"/>


            <script type="text/javascript">
                /* using this function to prevent syntax errors on conditionally deciding onclick action */
                function sentToReview() {
                    PF('inreview').show();
                }
            </script>

            <script type="text/javascript">
                PrimeFaces.locales['pl'] = {
                    closeText: 'Zamknij',
                    prevText: 'Poprzedni',
                    nextText: 'Nastpny',
                    monthNames: ['Stycze','Luty','Marzec','Kwiecie','Maj','Czerwiec','Lipiec','Sierpie','Wrzesie','Padziernik','Listopad','Grudzie'],
                    monthNamesShort: ['Sty','Lut','Mar','Kwi','Maj','Cze', 'Lip','Sie','Wrz','Pa','Lis','Gru'],
                    dayNames: ['Niedziela','Poniedziaek','Wtorek','roda','Czwartek','Pitek','Sobota'],
                    dayNamesShort: ['Nie','Pon','Wt','r','Czw','Pt','So'],
                    dayNamesMin: ['N','P','W','','Cz','P','S'],
                    weekHeader: 'Tydzie',
                    firstDay: 1,
                    isRTL: false,
                    showMonthAfterYear: false,
                    yearSuffix: '',
                    timeOnlyTitle: 'Tylko czas',
                    timeText: 'Czas',
                    hourText: 'Godzina',
                    minuteText: 'Minuta',
                    secondText: 'Sekunda',
                    currentText: 'Teraz',
                    ampm: false,
                    month: 'Miesic',
                    week: 'Tydzie',
                    day: 'Dzie',
                    allDayText : 'Cay dzie'
                };
            </script>
        </ui:define>
    </ui:composition>
</h:body>


</html>
