# Dataverse 6.2

Please note: To read these instructions in full, please go to https://github.com/IQSS/dataverse/releases/tag/v6.3 rather than the list of releases, which will cut them off.

This release brings new features, enhancements, and bug fixes to the Dataverse software.
Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.

# Table of Contents
- [Release Highlights](#release-highlights)
- [Bug fixes](#bug-fixes)
- [Persistence](#persistence)
- [API](#api)
- [Backward Incompatibilities](#backward-incompatibilities)
- [Guides](#guides)
- [New Settings](#new-settings)
- [Complete List of Changes](#complete-list-of-changes)
- [Getting Help](#getting-help)
- [Upgrade instructions](#upgrade-instructions)

## Release Highlights

### Sitemap now supports more than 50k items

Dataverse can now handle more than 50,000 items when generating sitemap files, splitting the content across multiple files to comply with the Sitemap protocol.

For details see https://dataverse-guide--10321.org.readthedocs.build/en/10321/installation/config.html#creating-a-sitemap-and-submitting-it-to-search-engines #8936 and #10321.

### Improved use of Dataverse thumbnail

Dataverse will use the Dataset thumbnail, if one is defined, rather than the generic Dataverse logo in the Open Graph metadata header. This means the image will be seen when, for example, the dataset is referenced on Facebook.

### Improved Controlled Vocabulary for Citation block

The Controlled Vocabuary Values list for the metadata field Language in the Citation block has been improved, with some missing two- and three-letter ISO 639 codes added, as well as more alternative names for some of the languages, making all these extra language identifiers importable.

### Re-addition of 'cell counting' to Life Science block

Re-adding value `cell counting` to Life Science metadata block's Measurement Type vocabularies accidentally removed in `v5.1`. 

### Support for rsync has been deprecated

Support for rsync has been deprecated. Information has been removed from the guides for rsync and related software such as Data Capture Module (DCM) and Repository Storage Abstraction Layer (RSAL). You can still find this information in [older versions](https://guides.dataverse.org/en/6.2/developers/big-data-support.html#data-capture-module-dcm) of the guides.

[See.](#database-settings)

### Updates on Support for External Vocabulary Services

Multiple extensions of the External Vocabulary mechanism have been added. These extensions allow interaction with services based on the Ontoportal software and are expected to be generally useful for other service types.

These changes include:

- *Improved Indexing with Compound Fields:* When using an external vocabulary service with compound fields, you can now specify which field(s) will include additional indexed information, such as translations of an entry into other languages. This is done by adding the `indexIn` in `retrieval-filtering`. (#10505)
For more information, please check [GDCC/dataverse-external-vocab-support documentation](https://github.com/gdcc/dataverse-external-vocab-support/tree/main/docs).

- *Broader Support for Indexing Service Responses:* Indexing of the results from `retrieval-filtering` responses can now handle additional formats including Json Arrays of Strings and values from arbitrary keys within a JSON Object. (#10505)

- *HTTP Headers:* You are now able to add HTTP request headers required by the service you are implementing (#10331)

- *Flexible params in retrievalUri:* You can now use `managed-fields` field names as well as the `term-uri-field` field name as parameters in the `retrieval-uri` when configuring an external vocabulary service. `{0}` as an alternative to using the `term-uri-field` name is still supported for backward compatibility. Also you can specify if the value must be url encoded with `encodeUrl:`. (#10404). For example : `"retrieval-uri": "https://data.agroportal.lirmm.fr/ontologies/{keywordVocabulary}/classes/{encodeUrl:keywordTermURL}"`



[↑ Table of Contents](#table-of-contents)

## Bug fixes
[↑ Table of Contents](#table-of-contents)

## Persistence
[↑ Table of Contents](#table-of-contents)

## API 
[↑ Table of Contents](#table-of-contents)

## Backward Incompatibilities
[↑ Table of Contents](#table-of-contents)

## Guides
[↑ Table of Contents](#table-of-contents)

## New Settings 
[↑ Table of Contents](#table-of-contents)

### MicroProfile Settings

### SMTP Settings: 

### Database Settings:

***Deprecated:***

- :DataCaptureModuleUrl
- :DownloadMethods
- :LocalDataAccessPath
- :RepositoryStorageAbstractionLayerUrl

## Complete List of Changes

For the complete list of code changes in this release, see the [6.3 Milestone](https://github.com/IQSS/dataverse/issues?q=milestone%3A6.3+is%3Aclosed) in GitHub.

[↑ Table of Contents](#table-of-contents)

## Getting Help

For help with upgrading, installing, or general questions please post to the [Dataverse Community Google Group](https://groups.google.com/forum/#!forum/dataverse-community) or email support@dataverse.org.

[↑ Table of Contents](#table-of-contents)

## Upgrade Instructions

Upgrading requires a maintenance window and downtime. Please plan accordingly, create backups of your database, etc.

These instructions assume that you've already upgraded through all the 5.x releases and are now running Dataverse 6.2.

0\. These instructions assume that you are upgrading from the immediate previous version. If you are running an earlier version, the only safe way to upgrade is to progress through the upgrades to all the releases in between before attempting the upgrade to this version.

If you are running Payara as a non-root user (and you should be!), **remember not to execute the commands below as root**. Use `sudo` to change to that user first. For example, `sudo -i -u dataverse` if `dataverse` is your dedicated application user.

In the following commands, we assume that Payara 6 is installed in `/usr/local/payara6`. If not, adjust as needed.

`export PAYARA=/usr/local/payara6`

(or `setenv PAYARA /usr/local/payara6` if you are using a `csh`-like shell)

1\. Usually, when a Solr schema update is released, we recommend deploying the new version of Dataverse and then updating the `schema.xml` on the Solr side. With 6.3, we recommend to install the base schema first. Without it, Dataverse 6.3 is not going to be able to show any results after the initial deployment. If your instance is using any custom metadata blocks, you will need to further modify the schema, see step 9 of this document.

- Stop Solr instance (usually `service solr stop`, depending on Solr installation/OS, see the [Installation Guide](https://guides.dataverse.org/en/6.2/installation/prerequisites.html#solr-init-script))

- Replace schema.xml

  - `wget https://raw.githubusercontent.com/IQSS/dataverse/master/conf/solr/9.3.0/schema.xml`
  - `cp schema.xml /usr/local/solr/solr-9.3.0/server/solr/collection1/conf`

- Start Solr instance (usually `service solr start`, depending on Solr/OS)

2\. Undeploy the previous version.

- `$PAYARA/bin/asadmin undeploy dataverse-6.2`

3\. Stop Payara and remove the generated directory

- `service payara stop`
- `rm -rf $PAYARA/glassfish/domains/domain1/generated`

4\. Start Payara

- `service payara start`

5\. Deploy this version.

- `$PAYARA/bin/asadmin deploy dataverse-6.3.war`

As noted above, deployment of the war file might take several minutes due a database migration script required for the new storage quotas feature.

6\. For installations with internationalization:

- Please remember to update translations via [Dataverse language packs](https://github.com/GlobalDataverseCommunityConsortium/dataverse-language-packs).

7\. Restart Payara

- `service payara stop`
- `service payara start`

8\. Update the following Metadata Blocks to reflect the incremental improvements made to the handling of core metadata fields: 

 ```
wget https://github.com/IQSS/dataverse/releases/download/v6.3/citation.tsv

curl http://localhost:8080/api/admin/datasetfield/load -H "Content-type: text/tab-separated-values" -X POST --upload-file scripts/api/data/metadatablocks/citation.tsv

wget https://github.com/IQSS/dataverse/releases/download/v6.3/biomedical.tsv`

curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @biomedical.tsv -H "Content-type: text/tab-separated-values"

```

9\. For installations with custom or experimental metadata blocks:

- Stop Solr instance (usually `service solr stop`, depending on Solr installation/OS, see the [Installation Guide](https://guides.dataverse.org/en/6.3/installation/prerequisites.html#solr-init-script))

- Run the `update-fields.sh` script that we supply, as in the example below (modify the command lines as needed to reflect the correct path of your solr installation):
```
	wget https://raw.githubusercontent.com/IQSS/dataverse/master/conf/solr/9.3.0/update-fields.sh
	chmod +x update-fields.sh
	curl "http://localhost:8080/api/admin/index/solr/schema" | ./update-fields.sh /usr/local/solr/solr-9.3.0/server/solr/collection1/conf/schema.xml
```
     
- Restart Solr instance (usually `service solr restart` depending on solr/OS)

10\. Reindex Solr:

   For details, see https://guides.dataverse.org/en/6.3/admin/solr-search-index.html but here is the reindex command:

```
   curl http://localhost:8080/api/admin/index


[↑ Table of Contents](#table-of-contents)
