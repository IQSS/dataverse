# Dataverse 6.7

Please note: To read these instructions in full, please go to https://github.com/IQSS/dataverse/releases/tag/v6.7 rather than the [list of releases](https://github.com/IQSS/dataverse/releases), which will cut them off.

This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project!

## Release Highlights

Highlights for Dataverse 6.7 include:

- file previewers are now available in the development environment
- licenses may now be linked to Dataset Types
- ability to pin a specific Dataverse version in Docker

## Features Added

### File Previews Available in Dev Environment, More Docs

In Dataverse 6.5 File Previewers were enabled in the "demo or eval" containerized (Dockerized) environment (#11025). These previewers are now available in the development environment as well and [documentation](https://dataverse-guide--11181.org.readthedocs.build/en/11181/container/running/demo.html#file-previewers) has been added explaining how to configure them. See also #10506 and #11181.

### Dataset Types can set available Licenses

Licenses (e.g. "MIT") can now be linked to dataset types (e.g. "software") using new superuser APIs. The create Dataset Type APIs have been extended to allow you to set metadata blocks and/or licenses on the creation of a Dataset Type. 

If a license is not available for a given dataset type then the Create Dataset API will prevent that license from being applied to the dataset.
Also, the UI will only show those licenses that are available to a the dataset's dataset type.

For more information, see the guides ([overview](https://dataverse-guide--11385.org.readthedocs.build/en/11385/user/dataset-management.html#dataset-types), [new APIs](https://dataverse-guide--11385.org.readthedocs.build/en/11385/api/native-api.html#set-available-licenses-for-a-dataset-type)), #10519 and #11001.

### Ability to pin to a specific Dataverse version in Docker (and more)

Container image management has been enhanced to provide better support for multiple Dataverse releases and improved maintenance workflows.

**Versioned Image Tags**: Application ("dataverse") and Config Baker [images on Docker Hub](https://hub.docker.com/u/gdcc) now have versioned tags, supporting the latest three Dataverse software releases. This enables users to pin to specific versions (e.g. 6.7), providing better stability for production deployments. Previously, the "alpha" tag could be used, but it was always overwritten by the latest release. Now, you can choose the 6.7 tag, for example, to stay on that version. Please note that the "alpha" tag should no longer be used and will likely be deleted. The equivalent is the new "latest" tag.

**Backport Support**: Application and Config Baker image builds now support including code backports for past releases, enabling the delivery of security fixes and critical updates to older (supported) versions.

**Enhanced Documentation**: Container image [documentation](https://dataverse-guide--11477.org.readthedocs.build/en/11477/container/index.html) has been updated to reflect the new versioning scheme and maintenance processes.

**Config Baker Base Image Change**: The Config Baker image has been migrated from Alpine to Ubuntu as its base operating system, aligning with other container images in the project for consistency and better compatibility. The past releases have not been migrated, only future releases (6.7+) will use Ubuntu.

**Workflow Responsibility Split**: GitHub Actions workflows for containers have been reorganized with a clear separation of concerns:

- `container_maintenance.yml` handles all release-time and maintenance activities
- Other workflows focus solely on preview images for development merges and pull requests

These improvements provide more robust container image lifecycle management, better security update delivery, and clearer operational procedures for both development and production environments.
See also the [Container Guide](https://dataverse-guide--11477.org.readthedocs.build/en/11477/container/index.html), #10618, and #11477.

### Notes for documentation writers

Sphinx has been upgraded to 7.4.0 and new dependencies have been added, including semver. Please re-run the `pip install -r requirements.txt` setup [step](https://guides.dataverse.org/en/6.7/contributor/documentation.html#installing-sphinx) to upgrade your environment. Otherwise you might see an error like `ModuleNotFoundError: No module named 'semver'`.

### Archival Bag Configuration Change

Archival Bags now use the JVM option `dataverse.bagit.sourceorg.name` in generating the bag-info.txt file's "Internal-Sender-Identifier" (in addition to its use for "Source-Organization") rather than pulling the value from a deprecated `bagit.SourceOrganization` entry in Bundle.properties ("Internal-Sender-Identifier" is generated by appending " Catalog" in both cases). Sites using archival bags would not see a change if these settings were already using the same value. See #10680 and #11416.

### String Field Type Added

The "string" type has been added as a new field type for metadata fields.

In contrast to "text" fields, "string" fields are stored and indexed exactly as provided, without any text analysis or transformations.

This field type is suitable for fields like IDs (e.g. ORCIDs) or enums, where exact matches are required when searching.

### Modify Assign Role API error message

Change error message from specifying 'User' and 'Dataverse' since it is used for groups and Datasets as well
Generic message: datasets.api.grant.role.assignee.has.role.error=Role has already been granted.

Note: Re-Translation needed.

### API_BEARER_AUTH_USE_BUILTIN_USER_ON_ID_MATCH feature flag

A new feature flag called `API_BEARER_AUTH_USE_BUILTIN_USER_ON_ID_MATCH` has been introduced, which allows the use of a built-in user
account when an identity match is found during OIDC API bearer token authentication.

This feature enables automatic association of an incoming IdP identity with an existing built-in user account, bypassing
the need for additional user registration steps.

See [the guides](https://dataverse-guide--11193.org.readthedocs.build/en/11193/installation/config.html#feature-flags), #11193, #11197, and #11314.

### Keycloak SPI for Built-In users

A Keycloak SPI, `builtin-users-spi`, has been implemented that allows the use of Keycloak on instances with built-in
accounts for OIDC
authentication, enabling the use of the SPA on those instances.

Looking ahead, this authenticator SPI could also support mapping Shibboleth users coming in through Keycloak to existing
Shib users without changing the provider in the Dataverse database. However, this would require changes to the storage
provider to support more than just built-in users.

The SPI code is available in the Dataverse code repository (`conf/keycloak/builtin-users-spi`).

### Tabular Tags can now be replaced

Previously the API POST /files/{id}/metadata/tabularTags could only add new tags to the tabular tags list. Now with the query parameter ?replace=true the list of tags will be replaced.

See also [the guides](https://dataverse-guide--11359.org.readthedocs.build/en/11359/api/native-api.html#updating-file-tabular-tags), #11292, and #11359.


### Other Features

- It is now possible to link draft datasets to other Dataverse collections. As usual, the datasets will only become publicly visible in the linked collection(s) after they have been published. To publish a linked dataset, your account must have the "Publish Dataset" permission for the Dataverse collection in which the dataset was originally created. Permissions in the linked Dataverse collections do not apply. See also #10134.
- Navigation across the guides has been improved. You can now click in the upper left to go "home". The navbar has been simplified with fewer links. The bottom of every page now has "Next" and "Previous" links. A "Source" link at the bottom has also been added. See #10942.
- The tutorial on running Dataverse in Docker has been updated to include [how to load a metadata block](https://dataverse-guide--11204.org.readthedocs.build/en/11204/container/running/demo.html#additional-metadata-blocks) and then update Solr to know about the new fields. See also #11004 and #11204




## Bugs Fixed

-Deeply nested compound fields are not (yet) supported by Dataverse but the Search API now properly avoids returning duplicate values for them. See #11172.

### NcML Previewer Bug Fix

[Dataverse Previewers](https://github.com/gdcc/dataverse-previewers) v1.4 contains a bug in the NcML previewer that prevents it from working with signed URLs. (See #11252 for screenshots.)

This has been [fixed](https://github.com/gdcc/dataverse-previewers/commit/2211989e7b9e12c875e18b4893ba4f1dfb1603a5) in the "betatest" version of the previewer.

Until v1.5 is released, we recommend [deleting](https://guides.dataverse.org/en/6.5/admin/external-tools.html#managing-external-tools) the v1.4 version and switching to the "betatest" version. This can be achieved by editing the [curl command](https://github.com/gdcc/dataverse-previewers/blob/develop/6.1curlcommands.md#ncml-previewer) for the NcML previewer, changing this line...

`"toolUrl":"https://gdcc.github.io/dataverse-previewers/previewers/v1.4/NcmlPreview.html",`

... to...

`"toolUrl":"https://gdcc.github.io/dataverse-previewers/previewers/betatest/NcmlPreview.html",`

Note that there are two curl commands as the NcML tool supports two content types:

- `"contentType":"application/x-hdf5"`
- `"contentType":"application/netcdf"`

See also #11252 and #11311.

### Bug fix to Search API. Now includes all type totals (Dataverses, Dataset, and Files) regardless of the list of types requested

None requested types were returned with total count set to 0.
&type=dataverse&type=dataset would result in "Files" : 0 since type=file was not requested

Now all counts show the correct totals.

### Reduced chance of losing metadata on Edit Dataset Metadata page

The remedy for the problem consists of two parts:
- Do not show the _host dataverse_ field when there is nothing to choose. This mimics the behaviour for templates.
- When you accidentally start typing in the _host dataverse_ field, undo the change with backspace, fill in the other metadata fields and save the draft, the page used to get blocked due to an exception. Reloading the page would erase all your input. The exception (caused by an invalid argument) is remedied returning the currently selected value.



## API Updates

### API for Persistent Identifier Reconciliation

Added a new API for persistent identifier reconciliation. An unpublished dataset can be updated with a new
pidProvider. If a persistent identifier was already registered when the dataset was registered, this is undone and the
new provider (if changed in the meantime) is used. Note that this change does not affect the storage repository where the old identifier is still
used. See [the guides](https://dataverse-guide--10567.org.readthedocs.build/en/10567/api/native-api.html#reconcile-the-pid-of-a-dataset-if-multiple-pid-providers-are-enabled), #10501, and #10567.

### Edit Dataset Metadata API extension

This endpoint now allows removing fields (by sending empty values), as long as they are not required by the dataset.
New ``sourceInternalVersionNumber`` optional query parameter, which prevents inconsistencies by managing updates that
  may occur from other users while a dataset is being edited.

### Update File Metadata API (PR #11271)

A new API endpoint has been added to allow updating file metadata for one or more files in a dataset.
See the [Native API documentation](https://guides.dataverse.org/en/latest/api/native-api.html) for details on usage.

### Extend Restrict API to include new attributes

Original /restrict API only allowed for a boolean to update the restricted attribute of a file.
The extended API still allows for the single boolean for backward compatibility.
This change also allows for a JSON object to be passed which allows for the required `restrict` flag as well as optional attributes: `enableAccessRequest` and `termsOfAccess`.
If `enableAccessRequest` is false then the `termsOfAccess` text must also be included.

See [the guides](https://dataverse-guide--11349.org.readthedocs.build/en/11349/api/native-api.html#restrict-files), #11299, and #11349.


### Other API Updates



## End-Of-Life (EOL) Announcements


## Security


## Settings Added



## Backward Incompatible Changes

Generally speaking, see the [API Changelog](https://guides.dataverse.org/en/latest/api/changelog.html) for a list of backward-incompatible API changes.
An undocumented Search API parameter called "show_my_data" has been removed. It was never exercised by tests and is believed to be unused. API users should use the [MyData] API instead. See the [API changelog](https://dataverse-guide--11375.org.readthedocs.build/en/11375/api/changelog.html), #11287 and #11375.


## Complete List of Changes

For the complete list of code changes in this release, see the [6.7 milestone](https://github.com/IQSS/dataverse/issues?q=milestone%3A6.7+is%3Aclosed) in GitHub.

## Getting Help

For help with upgrading, installing, or general questions please post to the [Dataverse Community Google Group](https://groups.google.com/g/dataverse-community) or email support@dataverse.org.

## Installation

If this is a new installation, please follow our [Installation Guide](https://guides.dataverse.org/en/latest/installation/). Please don't be shy about [asking for help](https://guides.dataverse.org/en/latest/installation/intro.html#getting-help) if you need it!

Once you are in production, we would be delighted to update our [map of Dataverse installations](https://dataverse.org/installations) around the world to include yours! Please [create an issue](https://github.com/IQSS/dataverse-installations/issues) or email us at support@dataverse.org to join the club!

You are also very welcome to join the [Global Dataverse Community Consortium](https://www.gdcc.io/) (GDCC).

## Upgrade Instructions

Upgrading requires a maintenance window and downtime. Please plan accordingly, create backups of your database, etc.

These instructions assume that you've already upgraded through all the 5.x releases and are now running Dataverse 6.6.

If you are using archival bags, be sure that the `dataverse.bagit.sourceorg.name` JVM option is set.
