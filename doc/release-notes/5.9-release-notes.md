# Dataverse Software 5.9

This release brings new features, enhancements, and bug fixes to the Dataverse Software. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.

## Release Highlights

### Dataverse Collection Backend Optimizations

Optimizations to one of the most used pages in the application.

### Support for HTTP "Range" Header for Partial File Downloads

Dataverse now supports the HTTP "Range" header, which allows users to download parts of a file. Here are some examples:

- `bytes=0-9` gets the first 10 bytes.
- `bytes=10-19` gets 10 bytes from the middle.
- `bytes=-10` gets the last 10 bytes.
- `bytes=9-` gets all bytes except the first 10.

Only a single range is supported. For more information, see the [Data Access API](https://guides.dataverse.org/en/5.9/api/dataaccess.html) section of the API Guide.

### Support for optional external metadata validation scripts

This enables an installation administrator to provide custom scripts for additional metadata validation when datasets are being published and/or when Dataverse collections are being published or modified. Harvard Dataverse Repository has been using this mechanism to combat content that violates our Terms of Use. All the validation or verification logic is defined in these external scripts, thus making it possible for an installation to add checks custom-tailored to their needs.  

Please note that only the metadata are subject to these validation checks (not the content of any uploaded files!).

For more information, see the [Database Settings](https://guides.dataverse.org/en/5.9/installation/config.html) section of the Guide.

### Displaying author's identifier as link

In the dataset page's metadata tab the author's identifier is displayed as a clickable link, which points to the profile page in the external service (ORCID, VIAF etc.), given that the identifier scheme provides a resolvable landing page. If the identifier does not match the expected scheme, a link is not shown.

### Auxiliary File API Enhancements

This release includes updates to the Auxiliary File API:

- Auxiliary files can now also be associated with non-tabular files
- Improved error reporting
- The API will block attempts to create a duplicate auxiliary file
- Delete and list-by-original calls have been added
- Bug fix: correct checksum recorded for aux file

Please note that the auxiliary files feature is experimental and is designed to support integration with tools from the [OpenDP Project](https://opendp.org). If the API endpoints are not needed they can be blocked.

## Major Use Cases and Infrastructure Enhancements

Newly-supported major use cases in this release include:

- Dataverse Page Speedup (Issue #7804, PR #8143)
- Improved accessibility of buttons on the Dataset and File pages (Issue #8247, PR #8257)
- Spam Checker (Issue #8155, PR #8245)
- Remove invalid characters (Issue #8018, PR #8242)
- Auxiliary files can now also be associated with non-tabular files (Issue #8235, PR #8237)
- The API will block attempts to create a duplicate auxiliary file (Issue #8235, PR #8237)
- Delete Aux ((Issue #8235, PR #8237)
- List-by-origin calls have been added (Issue #8235, PR #8237)
- .geojson files are now correctly identified as GeoJSON files rather than "unknown" (Issue #8261, PR #8262)
- Additional info around role deletion in ActionLogRecord (Issue #2912, PR #8211)
- New ManageFilePermissions Permission (Issue #8109, PR #8174)
- Improve Index Speed (Issue #8097, PR #8152)
- HTTP Range (Issue #6397, PR #8087)
- Account Migration (PR #7916)


## Notes for Dataverse Installation Administrators

### Indexing performance on datasets with large numbers of files

We discovered that whenever a full reindexing needs to be performed, datasets with large numbers of files take exceptionally long time to index (for example, in the IQSS repository it takes several hours for a dataset that has 25,000 files). In situations where the Solr index needs to be erased and rebuilt from scratch (such as a Solr version upgrade, or a corrupt index, etc.) this can significantly delay the repopulation of the search catalog.

We are still investigating the reasons behind this performance issue. For now, even though some improvements have been made, a dataset with thousands of files is still going to take a long time to index. But we've made a simple change to the reindexing process, to index any such datasets at the very end of the batch, after all the datasets with fewer files have been reindexed. This does not improve the overall reindexing time, but will repopulate the bulk of the search index much faster for the users of the installation.

### New ManageFilePermissions Permission

Dataverse can now support a use case in which a Admin or Curator would like to delegate the ability to grant access to restricted files to other users. This can be implemented by creating a custom role (e.g. DownloadApprover) that has the new ManageFilePermissions permission. This release introduces the new permission ( and adjusts the existing standard Admin and Curator roles so they continue to have the ability to grant file download requrests).

### Thumbnail Defaults

New defaults have been added for when to create thumbnails for images and PDFs. The default is 3 MB for images, 1 MB for PDFs. Previously, there was no default.

## New JVM Options and DB Settings

- :Settingname XXX

## Notes for Developers and Integrators

Mention new section of the Dev Guide that covers writing more efficient front-end code

## Complete List of Changes

For the complete list of code changes in this release, see the [5.9 Milestone](https://github.com/IQSS/dataverse/milestone/100?closed=1) in Github.

For help with upgrading, installing, or general questions please post to the [Dataverse Community Google Group](https://groups.google.com/forum/#!forum/dataverse-community) or email support@dataverse.org.

## Installation

If this is a new installation, please see our [Installation Guide](https://guides.dataverse.org/en/5.9/installation/). Please also contact us to get added to the [Dataverse Project Map](https://guides.dataverse.org/en/5.9/installation/config.html#putting-your-dataverse-installation-on-the-map-at-dataverse-org) if you have not done so already.

## Upgrade Instructions

- Reindex Solr and reexport all exports after deployment because invalid characters are removed in the database by a SQL upgrade script.
- A full re-index is needed to update the facets, as well as optionally running the "redetect file type" API on existing GeoJSON files.

0\. These instructions assume that you've already successfully upgraded from Dataverse Software 4.x to Dataverse Software 5 following the instructions in the [Dataverse Software 5 Release Notes](https://github.com/IQSS/dataverse/releases/tag/v5.0). After upgrading from the 4.x series to 5.0, you should progress through the other 5.x releases before attempting the upgrade to 5.9.

If you are running Payara as a non-root user (and you should be!), **remember not to execute the commands below as root**. Use `sudo` to change to that user first. For example, `sudo -i -u dataverse` if `dataverse` is your dedicated application user.  

In the following commands we assume that Payara 5 is installed in `/usr/local/payara5`. If not, adjust as needed.

`export PAYARA=/usr/local/payara5`

(or `setenv PAYARA /usr/local/payara5` if you are using a `csh`-like shell)

1\. Undeploy the previous version.

- `$PAYARA/bin/asadmin list-applications`
- `$PAYARA/bin/asadmin undeploy dataverse<-version>`

2\. Stop Payara and remove the generated directory

- `service payara stop`
- `rm -rf $PAYARA/glassfish/domains/domain1/generated`

3\. Start Payara

- `service payara start`
  
4\. Deploy this version.

- `$PAYARA/bin/asadmin deploy dataverse-5.9.war`

5\. Restart payara

- `service payara stop`
- `service payara start`

6\. Update Solr schema.xml.

`/usr/local/solr/solr-8.8.1/server/solr/collection1/conf` is used in the examples below as the location of your Solr schema. Please adapt it to the correct location, if different in your installation. Use `find / -name schema.xml` if in doubt.

6a\. Replace `schema.xml` with the base version included in this release.

```
   wget https://github.com/IQSS/dataverse/releases/download/v5.9/schema.xml
   cp schema.xml /usr/local/solr/solr-8.8.1/server/solr/collection1/conf
```

For installations that are not using any Custom Metadata Blocks, **you can skip the next step**.

6b\. For installations with Custom Metadata Blocks

Use the script provided in the release to add the custom fields to the base `schema.xml` installed in the previous step.

```
   wget https://github.com/IQSS/dataverse/releases/download/v5.9/update-fields.sh
   chmod +x update-fields.sh
   curl "http://localhost:8080/api/admin/index/solr/schema" | ./update-fields.sh /usr/local/solr/solr-8.8.1/server/solr/collection1/conf/schema.xml
```

(Note that the curl command above calls the admin api on `localhost` to obtain the list of the custom fields. In the unlikely case that you are running the main Dataverse Application and Solr on different servers, generate the `schema.xml` on the application node, then copy it onto the Solr server)

7\. Restart Solr

Usually `service solr stop; service solr start`, but may be different on your system. See the [Installation Guide](https://guides.dataverse.org/en/5.9/installation/prerequisites.html#solr-init-script) for more details.
